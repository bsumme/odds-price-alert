<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Arbitrage Bet Finder - Mobile</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        body.fade-out {
            opacity: 0;
        }

        body.fade-in {
            opacity: 1;
        }

        /* Mobile Header */
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .mobile-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .mobile-header h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .mobile-toolbar {
            display: none;
        }

        .mobile-toolbar a {
            flex: 1;
            text-align: center;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.6rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.9rem;
            text-decoration: none;
            white-space: nowrap;
        }

        .mobile-toolbar a.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
            font-weight: 700;
        }

        /* Filter Toggle Button */
        .filter-toggle-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 0;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
        }

        .filter-toggle-btn:active {
            background: #334155;
        }

        .filter-toggle-btn.active {
            background: #166534;
            color: #bbf7d0;
            border-color: #15803d;
        }

        /* Filter Panel */
        .filter-panel {
            background: #1e293b;
            border-bottom: 2px solid #334155;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .filter-panel.open {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .filter-content {
            padding: 1rem;
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        select,
        input[type="number"],
        input[type="tel"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.4rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            font-size: 16px;
            /* Prevent zoom on iOS */
            min-height: 44px;
        }

        select:focus,
        input[type="number"]:focus,
        input[type="tel"]:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.2);
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            cursor: pointer;
            min-width: 20px;
            min-height: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-top: 0.75rem;
            padding: 0.5rem;
            cursor: pointer;
            min-height: 44px;
        }

        .btn {
            border: none;
            border-radius: 0.4rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:last-child {
            margin-bottom: 0;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:active {
            background: #15803d;
        }

        .mode-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .mode-toggle button {
            flex: 1;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            border-radius: 0.55rem;
            padding: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-toggle button.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:active {
            background: #64748b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status-bar {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: #0f172a;
            border-radius: 0.4rem;
        }

        /* Results Section */
        .results-section {
            padding: 1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .summary-bar {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #1e293b;
            border-radius: 0.4rem;
            border: 1px solid #334155;
        }

        /* Card-based results */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .opportunity-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #334155;
        }

        .sport-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: #334155;
            color: #e5e7eb;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .margin-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-positive {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-negative {
            background: #7f1d1d;
            color: #fecaca;
        }

        .bet-section {
            margin-bottom: 1rem;
        }

        .bet-section-title {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .bet-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-logo {
            width: 32px;
            height: 32px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .bet-details {
            flex: 1;
        }

        .bet-description {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .bet-odds {
            font-size: 1.1rem;
            font-weight: 700;
            color: #bbf7d0;
            margin-bottom: 0.25rem;
        }

        .bet-book {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .card-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #334155;
            font-size: 0.75rem;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        /* Watcher Panel - Bottom Sheet */
        .watcher-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .watcher-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .watcher-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 2px solid #334155;
            border-radius: 1rem 1rem 0 0;
            z-index: 2001;
            max-height: 85vh;
            overflow-y: auto;
            transition: bottom 0.3s ease;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.3);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .watcher-panel.open {
            bottom: 0;
        }

        .watcher-header {
            position: sticky;
            top: 0;
            background: #1e293b;
            padding: 1rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .watcher-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }

        .watcher-close-btn {
            background: transparent;
            border: none;
            color: #e5e7eb;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watcher-content {
            padding: 1rem;
        }

        /* Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 1px solid #334155;
            padding: 0.75rem 1rem;
            z-index: 999;
            text-align: center;
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0));
        }

        .credits-display {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .credits-display .credits-low {
            color: #fecaca;
        }

        .credits-display .credits-medium {
            color: #fde68a;
        }

        .credits-display .credits-high {
            color: #bbf7d0;
        }

        /* Main content padding for footer */
        main {
            padding-bottom: 4rem;
        }

        /* Small text utility */
        .small-text {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Swipe indicator for watcher panel */
        .swipe-indicator {
            width: 40px;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin: 0.5rem auto;
        }

        /* Pull to refresh indicator */
        .pull-refresh {
            text-align: center;
            padding: 1rem;
            color: #94a3b8;
            font-size: 0.875rem;
            display: none;
        }

        .pull-refresh.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            font-size: 0.85rem;
            color: #cbd5e1;
            position: sticky;
            top: 0;
            background: #0f172a;
            z-index: 1;
        }

        .scroll-container {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-header-top">
            <h1>Arbitrage Finder</h1>
        </div>
    </header>

    <script src="/table-renderers.js"></script>

    <main>
        <div class="card" style="margin: 0 0 0.75rem 0;">
            <div class="mode-toggle">
                <button id="arb-mode-btn" class="active" aria-pressed="true">Main Markets</button>
                <button id="props-mode-btn" aria-pressed="false">Player Props</button>
            </div>
            <div class="small-text" style="margin-top: 0.35rem;">Swap between arbitrage finder and player props search without
                leaving the page.</div>
        </div>

        <!-- Filter Toggle -->
        <button class="filter-toggle-btn" id="filter-toggle-btn">
            <span>Filters & Settings</span>
            <span id="filter-arrow">â–¼</span>
        </button>

        <!-- Filter Panel -->
        <div class="filter-panel" id="filter-panel">
            <div class="filter-content">
                <div class="card" id="arb-filter-panel">
                    <h2>Arbitrage Bet Finder</h2>
                    <div class="small-text" style="margin-bottom: 1rem;">
                        Discover arbitrage opportunities across multiple sports and markets
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn-secondary" id="watcher-toggle-btn">Open Hedge Watcher</button>
                    </div>

                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label>Select Sports</label>
                        <button id="toggle-all-sports-btn"
                            style="padding: 0.3rem 0.6rem; font-size: 0.85rem; cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">Show
                            All Sports</button>
                    </div>
                    <div id="sports-container-mobile">
                        <!-- Mobile sports checkboxes populated from /api/sports -->
                    </div>

                    <label>Select Markets</label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="market-checkbox" value="h2h" checked />
                        <span>Moneyline</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="market-checkbox" value="spreads" checked />
                        <span>Spreads</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" class="market-checkbox" value="totals" checked />
                        <span>Totals</span>
                    </label>

                    <label for="best-target-book-select">Target book</label>
                    <select id="best-target-book-select">
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                        <option value="novig">Novig</option>
                    </select>

                    <label for="best-compare-book-select">Compare against</label>
                    <select id="best-compare-book-select">
                        <option value="novig" selected>Novig</option>
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                    </select>

                    <label for="best-max-results-input">Max results</label>
                    <input id="best-max-results-input" type="number" min="10" max="200" step="10" value="10" />

                    <label class="checkbox-label"
                        style="margin-top: 1rem; padding: 0.75rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                        <input type="checkbox" id="dummy-data-checkbox" />
                        <span>Use Dummy Data</span>
                    </label>

                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" id="find-best-btn">Find Arbitrage Opportunities</button>
                        <button class="btn btn-secondary" id="clear-best-btn">Clear</button>
                    </div>

                    <div class="status-bar" id="best-status-bar">Ready.</div>
                </div>

                <div class="card" id="props-filter-panel" style="display: none;">
                    <h2>Player Props Search</h2>
                    <div class="small-text" style="margin-bottom: 0.75rem;">
                        Scan player props for edges across books without leaving the main page.
                    </div>

                    <label for="props-sport">Sport</label>
                    <select id="props-sport">
                        <option value="" selected>Select a sport</option>
                    </select>

                    <label for="props-game">Upcoming Games</label>
                    <select id="props-game">
                        <option value="">All Games</option>
                    </select>

                    <label for="props-team">Team</label>
                    <select id="props-team">
                        <option value="">All Teams</option>
                    </select>

                    <label for="props-player">Player</label>
                    <select id="props-player">
                        <option value="">All Players</option>
                    </select>

                    <label>Markets</label>
                    <div class="pill-group" id="props-markets" style="margin-bottom: 0.5rem;">
                        <label><input type="checkbox" value="all_player_props" checked>All player props</label>
                        <label><input type="checkbox" value="player_points" checked>Points</label>
                        <label><input type="checkbox" value="player_rebounds" checked>Rebounds</label>
                        <label><input type="checkbox" value="player_assists" checked>Assists</label>
                        <label><input type="checkbox" value="player_threes" checked>Threes</label>
                    </div>

                    <label for="props-target">Target book</label>
                    <select id="props-target">
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                        <option value="novig">Novig</option>
                    </select>

                    <label for="props-compare" style="margin-top: 0.4rem;">Compare against</label>
                    <select id="props-compare">
                        <option value="novig" selected>Novig</option>
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                    </select>

                    <div class="filter-actions">
                        <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="props-search-btn" disabled>Find Player Props</button>
                            <button class="btn btn-secondary" id="props-all-sports-btn">Search All Sports</button>
                            <button class="btn btn-secondary" id="props-reset-btn">Reset</button>
                        </div>
                        <div class="status-bar" id="props-status-bar">Ready.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results-section" style="display: none;">
            <div class="results-header">
                <h2>Arbitrage Opportunities</h2>
            </div>
            <div class="summary-bar" id="best-summary-bar"></div>
            <div class="pull-refresh" id="pull-refresh">Pull down to refresh</div>
            <div class="scroll-container">
                <table>
                    <thead>
                        <tr>
                            <th>Sport</th>
                            <th>Recommended Bet</th>
                            <th>Hedge Bet</th>
                            <th>Arbitrage Margin</th>
                            <th>Start Time</th>
                        </tr>
                    </thead>
                    <tbody id="best-results-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="results-section" id="props-results-section" style="display: none;">
            <div class="results-header">
                <h2>Player Props</h2>
            </div>
            <div class="summary-bar" id="props-summary-bar">Results from player props search will display here.</div>
            <div class="scroll-container">
                <table>
                    <thead>
                        <tr>
                            <th>Selection</th>
                            <th>Recommended Bet</th>
                            <th>Opposing Bet</th>
                            <th>Edge</th>
                            <th>Start / Game</th>
                        </tr>
                    </thead>
                    <tbody id="props-results-body">
                        <tr><td colspan="5" class="small-text">No player props yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state">
            Use the filters above to find arbitrage opportunities
        </div>
    </main>

    <!-- Watcher Panel Overlay -->
    <div class="watcher-overlay" id="watcher-overlay"></div>

    <!-- Watcher Panel - Bottom Sheet -->
    <div class="watcher-panel" id="watcher-panel">
        <div class="watcher-header">
            <h2>ðŸ”” Hedge Watcher</h2>
            <button class="watcher-close-btn" id="watcher-close-btn">âœ•</button>
        </div>
        <div class="swipe-indicator"></div>
        <div class="watcher-content">
            <div class="small-text" style="margin-bottom: 1rem;">
                Monitor for hedge opportunities (arbitrage margin â‰¥ 0%).
            </div>

            <label for="watcher-interval-input">Check interval (seconds)</label>
            <input id="watcher-interval-input" type="number" min="30" max="300" step="10" value="60" />

            <label for="sms-phone-input" style="margin-top: 1rem;">SMS Phone (optional)</label>
            <input id="sms-phone-input" type="tel" placeholder="5551234567" />

            <label for="sms-threshold-input" style="margin-top: 1rem;">Min arbitrage margin for SMS (%)</label>
            <input id="sms-threshold-input" type="number" step="0.1" value="0" />
            <div class="small-text">Only send text alerts when arbitrage margin meets or exceeds this value.</div>

            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" id="start-watcher-btn">Start Watcher</button>
                <button class="btn btn-secondary" id="stop-watcher-btn" disabled>Stop</button>
            </div>

            <div style="margin-top: 1rem;">
                <button class="btn btn-secondary" id="test-sms-btn">Test SMS Alert</button>
            </div>

            <div class="status-bar" id="watcher-status-bar" style="margin-top: 1rem;">Watcher stopped.</div>
            <div class="status-bar" id="test-sms-status" style="margin-top: 1rem; display: none;"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="credits-display">
            <span id="api-credits">API: Loading...</span>
        </div>
    </footer>

    <script>
        // All JavaScript from desktop version, adapted for mobile
        let valuePollTimer = null;
        let lastValueData = null;
        let filterHedgeOnly = false;
        let watcherTimer = null;
        let lastBestValueData = null;
        let alertedPlayIds = new Set();
        let smsAlertedPlayIds = new Set();
        let touchStartY = 0;
        let touchEndY = 0;
        let isPulling = false;
        let currentMode = "arb";
        let propsData = { plays: [] };
        let stopWatcher = () => { };

        const BOOK_LABELS = {
            draftkings: "DraftKings",
            fanduel: "FanDuel",
            fliff: "Fliff",
            novig: "Novig",
        };

        function getBookLabel(key) {
            if (!key) return "";
            return BOOK_LABELS[key] || key;
        }

        function formatStartTime(isoString) {
            if (!isoString) return "";

            const trimmed = String(isoString).trim();
            if (!trimmed) return "";

            const date = new Date(trimmed);
            if (Number.isNaN(date.getTime())) {
                return trimmed;
            }

            const options = {
                timeZone: "America/New_York",
                month: "short",
                day: "numeric",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            };
            return date.toLocaleString("en-US", options) + " ET";
        }

        let showAllSportsModeM = false;

        async function fetchAndRenderSportsMobile(showAll = false) {
            try {
                const res = await fetch('/api/sports');
                if (!res.ok) {
                    console.warn('Failed to fetch sports schema for mobile');
                    return;
                }
                const list = await res.json();
                const container = document.getElementById('sports-container-mobile');
                if (!container) return;
                container.innerHTML = '';
                for (const s of list) {
                    if (!s || !s.key) continue;
                    if (!showAll && !s.active) continue;
                    const label = document.createElement('label');
                    label.className = 'checkbox-label';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'sport-checkbox';
                    input.value = s.key;
                    input.checked = showAll ? false : true;
                    const span = document.createElement('span');
                    span.textContent = s.title || s.key;
                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                }

                const propsSportSelect = document.getElementById('props-sport');
                if (propsSportSelect) {
                    const options = list
                        .filter((s) => s && s.key && (showAll || s.active))
                        .map((s) => ({ value: s.key, label: s.title || s.key }));
                    setSelectOptions(propsSportSelect, options, 'Select a sport');
                    updatePropsSearchButton();
                }
            } catch (err) {
                console.warn('Error loading mobile sports schema', err);
            }
        }

        function getSmsMarginThreshold() {
            const thresholdInput = document.getElementById("sms-threshold-input");
            const value = thresholdInput ? Number(thresholdInput.value) : 0;
            return Number.isNaN(value) ? 0 : value;
        }

        function getTeamLogoUrl(teamName, sportKey = null) {
            if (!teamName) return null;

            const teamMapping = {
                // NBA
                "atlanta hawks": "atl",
                "boston celtics": "bos",
                "brooklyn nets": "bkn",
                "charlotte hornets": "cha",
                "chicago bulls": "chi",
                "cleveland cavaliers": "cle",
                "dallas mavericks": "dal",
                "denver nuggets": "den",
                "detroit pistons": "det",
                "golden state warriors": "gs",
                "houston rockets": "hou",
                "indiana pacers": "ind",
                "los angeles clippers": "lac",
                "los angeles lakers": "lal",
                "memphis grizzlies": "mem",
                "miami heat": "mia",
                "milwaukee bucks": "mil",
                "minnesota timberwolves": "min",
                "new orleans pelicans": "no",
                "new york knicks": "ny",
                "oklahoma city thunder": "okc",
                "orlando magic": "orl",
                "philadelphia 76ers": "phi",
                "phoenix suns": "phx",
                "portland trail blazers": "por",
                "sacramento kings": "sac",
                "san antonio spurs": "sa",
                "toronto raptors": "tor",
                "utah jazz": "utah",
                "washington wizards": "wsh",
                // NFL
                "arizona cardinals": "ari",
                "atlanta falcons": "atl",
                "baltimore ravens": "bal",
                "buffalo bills": "buf",
                "carolina panthers": "car",
                "chicago bears": "chi",
                "cincinnati bengals": "cin",
                "cleveland browns": "cle",
                "dallas cowboys": "dal",
                "denver broncos": "den",
                "detroit lions": "det",
                "green bay packers": "gb",
                "houston texans": "hou",
                "indianapolis colts": "ind",
                "jacksonville jaguars": "jax",
                "kansas city chiefs": "kc",
                "las vegas raiders": "lv",
                "los angeles chargers": "lac",
                "los angeles rams": "lar",
                "miami dolphins": "mia",
                "minnesota vikings": "min",
                "new england patriots": "ne",
                "new orleans saints": "no",
                "new york giants": "nyg",
                "new york jets": "nyj",
                "philadelphia eagles": "phi",
                "pittsburgh steelers": "pit",
                "san francisco 49ers": "sf",
                "seattle seahawks": "sea",
                "tampa bay buccaneers": "tb",
                "tennessee titans": "ten",
                "washington commanders": "wsh",
                // NCAAB - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "butler bulldogs": "2086",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "connecticut huskies": "41",
                "creighton bluejays": "154",
                "duke blue devils": "150",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgetown hoyas": "46",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "gonzaga bulldogs": "2250",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "indiana hoosiers": "84",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "marquette golden eagles": "269",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "miami hurricanes": "2390",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "missouri tigers": "142",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "san diego state aztecs": "21",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "syracuse orange": "183",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "villanova wildcats": "222",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275",
                "xavier musketeers": "2752",
                // NCAAF - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "boise state broncos": "68",
                "boston college eagles": "103",
                "byu cougars": "252",
                "california golden bears": "25",
                "central florida knights": "2116",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "miami hurricanes": "2390",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "mississippi rebels": "145",
                "missouri tigers": "142",
                "nebraska cornhuskers": "158",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "tulane green wave": "2655",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "wake forest demon deacons": "154",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275"
            };

            const normalized = teamName.toLowerCase().trim().replace(/\s+/g, ' ');
            let teamCode = teamMapping[normalized];

            if (!teamCode) {
                const shortNameMapping = {
                    "kansas": "2305",
                    "kansas jayhawks": "2305",
                    "jayhawks": "2305",
                    "arizona": "12",
                    "arizona wildcats": "12",
                    "wildcats": "12",
                    "kentucky": "96",
                    "kentucky wildcats": "96",
                    "duke": "150",
                    "duke blue devils": "150",
                    "north carolina": "153",
                    "north carolina tar heels": "153",
                    "tar heels": "153",
                    "ucla": "26",
                    "ucla bruins": "26",
                    "usc": "30",
                    "usc trojans": "30",
                    "texas": "251",
                    "texas longhorns": "251",
                    "michigan": "130",
                    "michigan wolverines": "130",
                    "ohio state": "194",
                    "ohio state buckeyes": "194",
                    "alabama": "333",
                    "alabama crimson tide": "333",
                    "georgia": "61",
                    "georgia bulldogs": "61",
                    "lsu": "99",
                    "lsu tigers": "99",
                    "florida": "57",
                    "florida gators": "57",
                    "tennessee": "2633",
                    "tennessee volunteers": "2633",
                    "oklahoma": "201",
                    "oklahoma sooners": "201",
                    "oregon": "2483",
                    "oregon ducks": "2483",
                    "wisconsin": "275",
                    "wisconsin badgers": "275",
                    "penn state": "213",
                    "penn state nittany lions": "213",
                    "notre dame": "87"
                };

                for (const [shortName, code] of Object.entries(shortNameMapping)) {
                    if (normalized === shortName || normalized.startsWith(shortName + " ") || normalized.endsWith(" " + shortName)) {
                        teamCode = code;
                        break;
                    }
                }

                if (!teamCode) {
                    const words = normalized.split(/\s+/);
                    const firstWord = words.length > 0 ? words[0] : normalized;

                    for (const [key, code] of Object.entries(teamMapping)) {
                        if (normalized === key ||
                            key.startsWith(normalized + " ") ||
                            normalized.startsWith(key + " ") ||
                            key.startsWith(firstWord + " ") ||
                            (normalized.length >= 3 && key.includes(normalized)) ||
                            (key.length >= 3 && normalized.includes(key))) {
                            teamCode = code;
                            break;
                        }
                    }
                }
            }

            let sportPath = "nba";
            if (sportKey) {
                if (sportKey.includes("ncaaf") || sportKey.includes("ncaab")) {
                    sportPath = "ncaa";
                } else if (sportKey.includes("football") || sportKey.includes("nfl")) {
                    sportPath = "nfl";
                } else if (sportKey.includes("hockey")) {
                    sportPath = "nhl";
                } else if (sportKey.includes("basketball") || sportKey.includes("nba")) {
                    sportPath = "nba";
                }
            }

            if (teamCode) {
                return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${teamCode}.png`;
            }

            const fallback = normalized.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${fallback}.png`;
        }

        function formatOdds(odds) {
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        function sortPlaysByArbitrageMargin(plays, direction = "desc") {
            const list = Array.isArray(plays) ? [...plays] : [];
            const fallback = direction === "asc" ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;

            list.sort((a, b) => {
                const aMargin = typeof a?.arb_margin_percent === "number" ? a.arb_margin_percent : fallback;
                const bMargin = typeof b?.arb_margin_percent === "number" ? b.arb_margin_percent : fallback;
                return direction === "asc" ? aMargin - bMargin : bMargin - aMargin;
            });

            return list;
        }

        function createTeamNameWithLogo(teamName, sportKey = null) {
            if (!teamName) return document.createTextNode("");

            const container = document.createElement("span");
            container.className = "team-name-with-logo";

            const logo = document.createElement("img");
            logo.className = "team-logo";
            logo.src = getTeamLogoUrl(teamName, sportKey);
            logo.alt = teamName;
            logo.onerror = function () {
                this.style.display = "none";
            };

            const nameSpan = document.createElement("span");
            nameSpan.textContent = teamName;

            container.appendChild(logo);
            container.appendChild(nameSpan);

            return container;
        }

        function parseTeamFromOutcome(outcomeName) {
            if (!outcomeName) return null;
            const parts = outcomeName.split(" @ ");
            return parts[0].trim();
        }

        function parseTeamsFromMatchup(matchup) {
            if (!matchup) return { away: null, home: null };
            const parts = matchup.split(" @ ");
            if (parts.length === 2) {
                return { away: parts[0].trim(), home: parts[1].trim() };
            }
            return { away: matchup, home: null };
        }

        function setBestStatus(msg) {
            document.getElementById("best-status-bar").textContent = msg;
        }

        function setBestSummary(msg) {
            document.getElementById("best-summary-bar").textContent = msg;
        }

        function setPropsStatus(msg) {
            const bar = document.getElementById("props-status-bar");
            if (bar) bar.textContent = msg;
        }

        function setPropsSummary(msg) {
            const bar = document.getElementById("props-summary-bar");
            if (bar) bar.textContent = msg;
        }

        function setMode(mode) {
            currentMode = mode;
            const isArb = mode === "arb";

            const arbBtn = document.getElementById("arb-mode-btn");
            const propsBtn = document.getElementById("props-mode-btn");
            arbBtn?.classList.toggle("active", isArb);
            arbBtn?.setAttribute("aria-pressed", String(isArb));
            propsBtn?.classList.toggle("active", !isArb);
            propsBtn?.setAttribute("aria-pressed", String(!isArb));

            document.getElementById("arb-filter-panel").style.display = isArb ? "block" : "none";
            document.getElementById("props-filter-panel").style.display = isArb ? "none" : "block";

            const hasArbResults = !!lastBestValueData && Array.isArray(lastBestValueData.plays) && lastBestValueData.plays.length > 0;
            document.getElementById("results-section").style.display = isArb && (hasArbResults || watcherTimer) ? "block" : "none";
            document.getElementById("empty-state").style.display = isArb && !hasArbResults ? "block" : "none";
            document.getElementById("props-results-section").style.display = isArb ? "none" : "block";

            if (!isArb) {
                stopWatcher();
                renderPlayerPropResults();
            }
        }

        function getSelectedPropMarkets() {
            const boxes = Array.from(document.querySelectorAll('#props-markets input[type="checkbox"]:checked'));
            const values = boxes.map((box) => box.value);
            return values.includes("all_player_props") && values.length > 1
                ? values.filter((v) => v !== "all_player_props")
                : values;
        }

        function resetMarkets() {
            document.querySelectorAll('#props-markets input[type="checkbox"]').forEach((box, idx) => {
                box.checked = idx === 0 || box.value === "player_points" || box.value === "player_rebounds" || box.value === "player_assists" || box.value === "player_threes";
            });
        }

        function setSelectOptions(select, options, placeholder) {
            if (!select) return;
            select.innerHTML = "";
            const frag = document.createDocumentFragment();
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.textContent = placeholder;
            frag.appendChild(placeholderOption);

            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.textContent = opt.label;
                frag.appendChild(option);
            });

            select.appendChild(frag);
        }

        function updatePropsSearchButton() {
            const sportSelected = Boolean(document.getElementById("props-sport")?.value);
            const searchBtn = document.getElementById("props-search-btn");

            if (!searchBtn) return;

            searchBtn.disabled = !sportSelected;
            searchBtn.title = sportSelected ? "" : "Select sport from drop down";
        }

        function formatPropsGameLabel(game) {
            const matchup = game.matchup || `${game.away_team || ""} @ ${game.home_team || ""}`.trim();
            const startLabel = formatStartTime(game.start_time || game.commence_time);
            return startLabel ? `${matchup} â€¢ ${startLabel}` : matchup || "Upcoming game";
        }

        async function loadPropsGames() {
            const sport = document.getElementById("props-sport")?.value;
            const gameSelect = document.getElementById("props-game");
            const teamSelect = document.getElementById("props-team");
            const playerSelect = document.getElementById("props-player");
            const useDummyData = document.getElementById("dummy-data-checkbox")?.checked;

            if (!sport) {
                setSelectOptions(gameSelect, [], "All Games");
                setSelectOptions(teamSelect, [], "All Teams");
                setSelectOptions(playerSelect, [], "All Players");
                return;
            }

            setPropsStatus("Loading games and teams...");
            try {
                const res = await fetch("/api/player-props/games", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sport_key: sport, use_dummy_data: useDummyData })
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                const data = await res.json();
                const games = Array.isArray(data?.games) ? data.games : [];

                const gameOptions = games.map(game => ({
                    value: game.event_id,
                    label: formatPropsGameLabel(game)
                }));
                setSelectOptions(gameSelect, gameOptions, "All Games");

                const teams = new Set();
                games.forEach(game => {
                    if (game.home_team) teams.add(game.home_team);
                    if (game.away_team) teams.add(game.away_team);
                });
                setSelectOptions(teamSelect, Array.from(teams).map(team => ({ value: team, label: team })), "All Teams");
                setSelectOptions(playerSelect, [], "All Players");
            } catch (err) {
                console.error(err);
                setPropsStatus(`Couldn't load games: ${err.message}`);
            }
        }

        async function fetchPlayerProps() {
            setPropsStatus("Loading player props...");

            const sportKey = document.getElementById("props-sport")?.value;
            if (!sportKey) {
                setPropsStatus("Pick a sport before searching player props.");
                return;
            }

            const payload = {
                sport_key: sportKey,
                team: document.getElementById("props-team")?.value || null,
                player_name: document.getElementById("props-player")?.value || null,
                event_id: document.getElementById("props-game")?.value || null,
                markets: getSelectedPropMarkets(),
                target_book: document.getElementById("props-target")?.value,
                compare_book: document.getElementById("props-compare")?.value,
                use_dummy_data: document.getElementById("dummy-data-checkbox")?.checked,
            };

            try {
                const res = await fetch("/api/player-props", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                propsData = await res.json();
                const count = Array.isArray(propsData?.plays) ? propsData.plays.length : 0;
                setPropsStatus(`Loaded ${count} player prop results.`);
                renderPlayerPropResults();
            } catch (err) {
                console.error(err);
                setPropsStatus(`Error loading player props: ${err.message}`);
                propsData = { plays: [] };
                renderPlayerPropResults();
            }
        }

        async function fetchAllSportsPlayerProps() {
            const button = document.getElementById("props-all-sports-btn");
            setPropsStatus("Scanning all sports for player prop arbitrage vs Novig...");
            if (button) button.disabled = true;

            try {
                const res = await fetch("/api/player-props/arbitrage-all", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        use_dummy_data: document.getElementById("dummy-data-checkbox")?.checked,
                        max_results: 150,
                    }),
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                propsData = await res.json();
                const count = Array.isArray(propsData?.plays) ? propsData.plays.length : 0;
                renderPlayerPropResults();

                const targetSummary = (propsData?.target_books || [])
                    .map(getBookLabel)
                    .filter(Boolean)
                    .join(", ") || "DraftKings, FanDuel, Fliff";
                const compareSummary = getBookLabel(propsData?.compare_book) || "Novig";
                setPropsSummary(`Found ${count} player prop arbitrage plays across all sports. Targets: ${targetSummary}; Hedge: ${compareSummary}.`);
                setPropsStatus("Done.");
            } catch (err) {
                console.error(err);
                setPropsStatus(`Error loading all-sports player props: ${err.message}`);
                propsData = { plays: [] };
                renderPlayerPropResults();
            } finally {
                if (button) button.disabled = false;
            }
        }

        function renderPlayerPropResults() {
            const section = document.getElementById("props-results-section");
            const body = document.getElementById("props-results-body");
            section.style.display = currentMode === "props" ? "block" : "none";
            body.innerHTML = "";

            const plays = Array.isArray(propsData?.plays) ? propsData.plays : [];
            if (!plays.length) {
                body.innerHTML = '<tr><td colspan="5" class="small-text">No player prop value plays found.</td></tr>';
                setPropsSummary("No player prop results yet.");
                return;
            }

            const targetBookLabel = document.querySelector("#props-target option:checked")?.textContent || "Target book";
            const compareBookLabel = document.querySelector("#props-compare option:checked")?.textContent || "Compare book";
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "baseball_mlb": "MLB",
                "icehockey_nhl": "NHL"
            };

            const sorted = sortPlaysByArbitrageMargin(plays, "desc");
            const playsWithStake = sorted.map(play => {
                const hedgeStakeAmounts = TableRenderers.helpers.calculateHedgeStakeAmounts(play.book_price, play.novig_reverse_price);
                return {
                    ...play,
                    targetLabel: getBookLabel(play.target_book) || targetBookLabel,
                    compareLabel: getBookLabel(play.compare_book) || compareBookLabel,
                    targetStakeText: hedgeStakeAmounts ? TableRenderers.helpers.formatStakeAmount(hedgeStakeAmounts.targetStake) : null,
                    hedgeStakeText: hedgeStakeAmounts ? TableRenderers.helpers.formatStakeAmount(hedgeStakeAmounts.hedgeStake) : null,
                };
            });

            TableRenderers.renderPropRows(body, playsWithStake, {
                targetBookLabel,
                compareBookLabel,
                sportLabels,
                marketLabelGetter: (key) => key,
                startTimeFormatter: TableRenderers.helpers.formatStartTime,
                oddsFormatter: TableRenderers.helpers.formatOddsWithColor,
                hedgeOddsFormatter: TableRenderers.helpers.formatOddsWithColor,
                emptyMessage: "No player prop value plays found.",
            });

            setPropsSummary(`Showing ${playsWithStake.length} player prop results.`);
        }

        function clearBestResults() {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            document.getElementById("results-section").style.display = "none";
            document.getElementById("empty-state").style.display = "block";
            setBestSummary("");
        }

        function renderBestValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            const section = document.getElementById("results-section");
            const emptyState = document.getElementById("empty-state");

            section.style.display = "block";
            emptyState.style.display = "none";

            if (!data || !Array.isArray(data.plays) || data.plays.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="small-text">No arbitrage opportunities found.</td></tr>';
                return;
            }

            let plays = data.plays;

            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.arb_margin_percent !== null &&
                    p.arb_margin_percent !== undefined &&
                    p.arb_margin_percent >= 0 &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );

                if (plays.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="small-text">No hedge opportunities found (arbitrage margin â‰¥ 0%).</td></tr>';
                    return;
                }
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const marketLabels = {
                "h2h": "Moneyline",
                "spreads": "Spreads",
                "totals": "Totals"
            };

            const sortedPlays = sortPlaysByArbitrageMargin(plays, "desc");

            TableRenderers.renderArbRows(body, sortedPlays, {
                includeSportColumn: true,
                sportLabels,
                marketLabels,
                targetBookLabel: document.querySelector("#best-target-book-select option:checked")?.textContent || data.target_book || "Target",
                compareBookLabel: document.querySelector("#best-compare-book-select option:checked")?.textContent || data.compare_book || "Compare",
                emptyMessage: hedgeOnly
                    ? "No hedge opportunities found (arbitrage margin â‰¥ 0%)."
                    : "No arbitrage opportunities found.",
                showLogos: true,
                oddsFormatter: TableRenderers.helpers.formatOddsWithColor,
                oddsHighlightClassGetter: TableRenderers.helpers.getOddsHighlightClass,
                startTimeFormatter: TableRenderers.helpers.formatStartTime,
                hedgeStakeCalculator: TableRenderers.helpers.calculateHedgeStakeAmounts,
                stakeFormatter: TableRenderers.helpers.formatStakeAmount,
                getTeamLogoUrl,
                parseTeamFromOutcome,
                parseTeamsFromMatchup,
            });
        }

        // Request browser notification permission
        async function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                await Notification.requestPermission();
            }
        }

        // Show browser notification for hedge opportunities
        function showHedgeAlert(play) {
            if (!("Notification" in window)) {
                console.log("Browser does not support notifications");
                return;
            }

            if (Notification.permission !== "granted") {
                return;
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            const notification = new Notification(`Hedge Opportunity Found! (${margin}%)`, {
                body: `${sportLabel}: ${teamName} ${bookOdds} vs Hedge ${hedgeOdds}\n${play.matchup || ""}`,
                icon: getTeamLogoUrl(teamName, play.sport_key) || undefined,
                tag: `hedge-${play.event_id}-${play.outcome_name}`,
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }

        function getPlayId(play) {
            return `${play.event_id}-${play.outcome_name}-${play.book_price}-${play.novig_reverse_price}`;
        }

        async function sendSMSAlert(play) {
            const phoneInput = document.getElementById("sms-phone-input");
            const phone = phoneInput ? phoneInput.value.trim() : "";

            if (!phone) {
                return;
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            const message = `Hedge Alert! ${sportLabel}: ${teamName} ${bookOdds} vs ${hedgeOdds} (${margin}% margin). ${play.matchup || ""}`;

            try {
                const response = await fetch("/api/send-sms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone: phone,
                        message: message
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("SMS send failed:", error.detail || "Unknown error");
                } else {
                    const result = await response.json();
                    console.log("SMS sent successfully. Quota remaining:", result.quotaRemaining);
                }
            } catch (error) {
                console.error("Error sending SMS:", error);
            }
        }

        function checkForHedgeAlerts(plays) {
            if (!plays || plays.length === 0) return;

            plays.forEach(play => {
                const marginPercent = play.arb_margin_percent;
                if (marginPercent !== null &&
                    marginPercent !== undefined &&
                    marginPercent >= 0 &&
                    play.novig_reverse_price !== null &&
                    play.novig_reverse_price !== undefined) {

                    const playId = getPlayId(play);
                    const meetsSmsThreshold = marginPercent >= getSmsMarginThreshold();

                    if (!alertedPlayIds.has(playId)) {
                        alertedPlayIds.add(playId);
                        showHedgeAlert(play);
                    }

                    if (meetsSmsThreshold && !smsAlertedPlayIds.has(playId)) {
                        smsAlertedPlayIds.add(playId);
                        sendSMSAlert(play);
                    }
                }
            });
        }

        async function fetchBestValuePlays() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const maxResults = Number(document.getElementById("best-max-results-input").value) || 50;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;

            if (sportCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one sport.");
                return;
            }

            if (marketCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one market.");
                return;
            }

            if (targetBook === compareBook) {
                setBestStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);
            const isWatcherRunning = watcherTimer !== null;

            if (!isWatcherRunning) {
                clearBestResults();
            }

            if (isWatcherRunning) {
                setBestStatus("Watcher: Checking for hedge opportunities...");
            } else {
                setBestStatus("Searching for arbitrage opportunities across sports and markets...");
            }
            if (useDummyData) {
                setBestStatus((isWatcherRunning ? "Watcher: Checking for hedge opportunities..." : "Searching for arbitrage opportunities across sports and markets...") + " [DUMMY DATA MODE]");
            }

            try {
                const requestMaxResults = isWatcherRunning ? maxResults : maxResults * 2;

                const res = await fetch("/api/best-value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets: markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        max_results: requestMaxResults,
                        use_dummy_data: useDummyData
                    }),
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastBestValueData = data;

                renderBestValuePlays(data, isWatcherRunning);

                if (isWatcherRunning) {
                    const hedgePlays = (data.plays || []).filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    );
                    checkForHedgeAlerts(data.plays);

                    const watcherStatusBar = document.getElementById("watcher-status-bar");
                    const intervalVal = Number(document.getElementById("watcher-interval-input").value) || 60;
                    const newAlerts = hedgePlays.filter(p => !alertedPlayIds.has(getPlayId(p))).length;
                    if (newAlerts > 0) {
                        watcherStatusBar.textContent = `ðŸ”” Found ${hedgePlays.length} hedge opportunities (${newAlerts} new alerts!). Next check in ${intervalVal}s...`;
                    } else {
                        watcherStatusBar.textContent = `Watching... Found ${hedgePlays.length} hedge opportunities. Next check in ${intervalVal}s...`;
                    }
                }

                let playsCount = (data.plays || []).length;
                if (isWatcherRunning) {
                    playsCount = data.plays.filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    ).length;
                }
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked").textContent;
                if (isWatcherRunning) {
                    setBestSummary(`Hedge Watcher: Showing ${playsCount} hedge opportunities (arbitrage margin â‰¥ 0%) across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                } else {
                    setBestSummary(`Found ${playsCount} arbitrage opportunities across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                }
                setBestStatus(isWatcherRunning ? "Watcher: Updated." : "Done.");
            } catch (e) {
                console.error(e);
                setBestStatus("Error: " + e.message);
            }
        }

        function saveFormSelections() {
            const selections = {
                sports: Array.from(document.querySelectorAll(".sport-checkbox:checked")).map(cb => cb.value),
                markets: Array.from(document.querySelectorAll(".market-checkbox:checked")).map(cb => cb.value),
                targetBook: document.getElementById("best-target-book-select").value,
                compareBook: document.getElementById("best-compare-book-select").value,
                maxResults: document.getElementById("best-max-results-input").value,
                dummyData: document.getElementById("dummy-data-checkbox").checked,
                watcherInterval: document.getElementById("watcher-interval-input").value,
                smsThreshold: document.getElementById("sms-threshold-input").value
            };
            localStorage.setItem("arbitrageFinderSelections", JSON.stringify(selections));
        }

        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("arbitrageFinderSelections");
                if (!saved) return;

                const selections = JSON.parse(saved);

                if (selections.sports && Array.isArray(selections.sports)) {
                    document.querySelectorAll(".sport-checkbox").forEach(cb => {
                        cb.checked = selections.sports.includes(cb.value);
                    });
                }

                if (selections.markets && Array.isArray(selections.markets)) {
                    document.querySelectorAll(".market-checkbox").forEach(cb => {
                        cb.checked = selections.markets.includes(cb.value);
                    });
                }

                if (selections.targetBook) {
                    document.getElementById("best-target-book-select").value = selections.targetBook;
                }
                if (selections.compareBook) {
                    document.getElementById("best-compare-book-select").value = selections.compareBook;
                }
                if (selections.maxResults) {
                    document.getElementById("best-max-results-input").value = selections.maxResults;
                }
                if (selections.dummyData !== undefined) {
                    document.getElementById("dummy-data-checkbox").checked = selections.dummyData;
                }
                if (selections.watcherInterval) {
                    document.getElementById("watcher-interval-input").value = selections.watcherInterval;
                }
                if (selections.smsThreshold !== undefined) {
                    document.getElementById("sms-threshold-input").value = selections.smsThreshold;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        async function fetchCredits() {
            try {
                const response = await fetch("/api/credits");
                if (!response.ok) {
                    throw new Error("Failed to fetch credits");
                }
                const data = await response.json();
                updateCreditsDisplay(data);
            } catch (error) {
                console.error("Error fetching credits:", error);
                document.getElementById("api-credits").textContent = "API: Error";
            }
        }

        function updateCreditsDisplay(data) {
            const apiCreditsEl = document.getElementById("api-credits");

            if (data.api_credits) {
                const credits = data.api_credits;
                const percentage = (credits.used / credits.total) * 100;
                let className = "credits-high";
                if (percentage >= 90) {
                    className = "credits-low";
                } else if (percentage >= 70) {
                    className = "credits-medium";
                }
                apiCreditsEl.textContent = `API: ${credits.display}`;
                apiCreditsEl.className = className;
            } else {
                apiCreditsEl.textContent = "API: N/A";
                apiCreditsEl.className = "";
            }
        }

        function startCreditsRefresh() {
            fetchCredits();
            setInterval(fetchCredits, 5 * 60 * 1000);
        }

        function smoothNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        function fadeInPage() {
            requestAnimationFrame(() => {
                document.body.classList.add('fade-in');
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fadeInPage);
        } else {
            fadeInPage();
        }

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                document.body.classList.remove('fade-in');
                requestAnimationFrame(() => {
                    document.body.classList.add('fade-in');
                });
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            // Smooth navigation
            document.querySelectorAll('.smooth-nav').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-href') || link.getAttribute('href');
                    if (url) {
                        smoothNavigate(url);
                    }
                });
            });

            startCreditsRefresh();
            // Populate mobile sports, then restore saved selections and attach listeners
            fetchAndRenderSportsMobile().then(() => {
                try { loadFormSelections(); } catch (e) { /* ignore */ }
                document.getElementById('toggle-all-sports-btn').addEventListener('click', () => {
                    showAllSportsModeM = !showAllSportsModeM;
                    const btn = document.getElementById('toggle-all-sports-btn');
                    btn.textContent = showAllSportsModeM ? 'Show Active Only' : 'Show All Sports';
                    btn.style.backgroundColor = showAllSportsModeM ? '#e8f5e9' : '#f0f0f0';
                    fetchAndRenderSportsMobile(showAllSportsModeM);
                });
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
            }).catch((err) => {
                console.warn('Failed to render mobile sports', err);
                try { loadFormSelections(); } catch (e) { /* ignore */ }
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
            });
            document.getElementById("best-target-book-select").addEventListener("change", saveFormSelections);
            document.getElementById("best-compare-book-select").addEventListener("change", saveFormSelections);
            document.getElementById("best-max-results-input").addEventListener("change", saveFormSelections);
            document.getElementById("dummy-data-checkbox").addEventListener("change", saveFormSelections);
            document.getElementById("watcher-interval-input").addEventListener("change", saveFormSelections);
            document.getElementById("sms-threshold-input").addEventListener("change", saveFormSelections);

            const dummyDataCheckbox = document.getElementById("dummy-data-checkbox");
            const savedDummyData = localStorage.getItem("useDummyData");
            if (savedDummyData === "true") {
                dummyDataCheckbox.checked = true;
            }

            dummyDataCheckbox.addEventListener("change", (e) => {
                localStorage.setItem("useDummyData", e.target.checked ? "true" : "false");
            });

            const smsPhoneInput = document.getElementById("sms-phone-input");
            const savedPhone = localStorage.getItem("smsPhoneNumber");
            if (savedPhone && smsPhoneInput) {
                smsPhoneInput.value = savedPhone;
            }
            if (smsPhoneInput) {
                smsPhoneInput.addEventListener("change", (e) => {
                    localStorage.setItem("smsPhoneNumber", e.target.value);
                });
            }

            document.getElementById("find-best-btn").onclick = () => fetchBestValuePlays();
            document.getElementById("clear-best-btn").onclick = clearBestResults;

            const bestTargetBook = document.getElementById("best-target-book-select");
            const bestCompareBook = document.getElementById("best-compare-book-select");

            function validateBestBookSelection() {
                if (bestTargetBook.value === bestCompareBook.value) {
                    setBestStatus("Error: Target book and comparison book cannot be the same.");
                    return false;
                }
                return true;
            }

            document.getElementById("arb-mode-btn").addEventListener("click", () => setMode("arb"));
            document.getElementById("props-mode-btn").addEventListener("click", () => setMode("props"));
            document.getElementById("props-sport").addEventListener("change", () => {
                updatePropsSearchButton();
                loadPropsGames();
            });
            document.getElementById("props-search-btn").addEventListener("click", (e) => {
                e.preventDefault();
                setMode("props");
                fetchPlayerProps();
            });

            document.getElementById("props-all-sports-btn").addEventListener("click", (e) => {
                e.preventDefault();
                setMode("props");
                fetchAllSportsPlayerProps();
            });

            document.getElementById("props-reset-btn").addEventListener("click", () => {
                document.getElementById("props-sport").value = "";
                setSelectOptions(document.getElementById("props-game"), [], "All Games");
                setSelectOptions(document.getElementById("props-team"), [], "All Teams");
                setSelectOptions(document.getElementById("props-player"), [], "All Players");
                resetMarkets();
                propsData = { plays: [] };
                renderPlayerPropResults();
                setPropsStatus("Ready.");
                setPropsSummary("Results from player props search will display here.");
                updatePropsSearchButton();
            });

            resetMarkets();
            loadPropsGames();
            updatePropsSearchButton();
            setMode("arb");

            bestTargetBook.addEventListener("change", validateBestBookSelection);
            bestCompareBook.addEventListener("change", validateBestBookSelection);

            // Filter panel toggle
            const filterToggleBtn = document.getElementById("filter-toggle-btn");
            const filterPanel = document.getElementById("filter-panel");
            const filterArrow = document.getElementById("filter-arrow");

            filterToggleBtn.addEventListener("click", () => {
                const isOpen = filterPanel.classList.contains("open");
                if (isOpen) {
                    filterPanel.classList.remove("open");
                    filterToggleBtn.classList.remove("active");
                    filterArrow.textContent = "â–¼";
                } else {
                    filterPanel.classList.add("open");
                    filterToggleBtn.classList.add("active");
                    filterArrow.textContent = "â–²";
                }
            });

            // Watcher panel toggle
            const watcherToggleBtn = document.getElementById("watcher-toggle-btn");
            const watcherPanel = document.getElementById("watcher-panel");
            const watcherOverlay = document.getElementById("watcher-overlay");
            const watcherCloseBtn = document.getElementById("watcher-close-btn");

            function openWatcher() {
                watcherPanel.classList.add("open");
                watcherOverlay.classList.add("show");
                document.body.style.overflow = "hidden";
            }

            function closeWatcher() {
                watcherPanel.classList.remove("open");
                watcherOverlay.classList.remove("show");
                document.body.style.overflow = "";
            }

            watcherToggleBtn.addEventListener("click", openWatcher);
            watcherCloseBtn.addEventListener("click", closeWatcher);
            watcherOverlay.addEventListener("click", closeWatcher);

            // Swipe to close watcher panel
            let watcherTouchStartY = 0;
            let watcherTouchEndY = 0;

            watcherPanel.addEventListener("touchstart", (e) => {
                watcherTouchStartY = e.touches[0].clientY;
            });

            watcherPanel.addEventListener("touchmove", (e) => {
                if (watcherTouchStartY === 0) return;
                const currentY = e.touches[0].clientY;
                const diff = currentY - watcherTouchStartY;
                if (diff > 0) {
                    watcherPanel.style.transform = `translateY(${diff}px)`;
                }
            });

            watcherPanel.addEventListener("touchend", (e) => {
                watcherTouchEndY = e.changedTouches[0].clientY;
                const diff = watcherTouchEndY - watcherTouchStartY;
                if (diff > 100) {
                    closeWatcher();
                }
                watcherPanel.style.transform = "";
                watcherTouchStartY = 0;
                watcherTouchEndY = 0;
            });

            // Watcher functionality
            const watcherIntervalInput = document.getElementById("watcher-interval-input");
            const startWatcherBtn = document.getElementById("start-watcher-btn");
            const stopWatcherBtn = document.getElementById("stop-watcher-btn");
            const watcherStatusBar = document.getElementById("watcher-status-bar");

            requestNotificationPermission();

            const startWatcher = () => {
                const intervalVal = Number(watcherIntervalInput.value) || 60;
                const intervalMs = Math.max(intervalVal, 30) * 1000;

                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }

                if (!validateBestBookSelection()) {
                    return;
                }

                alertedPlayIds.clear();
                smsAlertedPlayIds.clear();

                watcherStatusBar.textContent = `Starting watcher... Checking for hedge opportunities every ${intervalVal}s...`;
                startWatcherBtn.disabled = true;
                stopWatcherBtn.disabled = false;
                document.getElementById("find-best-btn").disabled = true;

                document.getElementById("results-section").style.display = "block";
                document.getElementById("empty-state").style.display = "none";

                fetchBestValuePlays();

                watcherTimer = setInterval(async () => {
                    try {
                        await fetchBestValuePlays();
                    } catch (error) {
                        console.error("Watcher error:", error);
                        watcherStatusBar.textContent = `Error: ${error.message}. Retrying in ${intervalVal}s...`;
                    }
                }, intervalMs);
            };

            stopWatcher = () => {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }
                watcherStatusBar.textContent = "Watcher stopped.";
                startWatcherBtn.disabled = false;
                stopWatcherBtn.disabled = true;
                document.getElementById("find-best-btn").disabled = false;

                if (lastBestValueData) {
                    renderBestValuePlays(lastBestValueData, false);
                }
            };

            startWatcherBtn.onclick = startWatcher;
            stopWatcherBtn.onclick = stopWatcher;

            // Test SMS functionality
            const testSmsBtn = document.getElementById("test-sms-btn");
            const testSmsStatus = document.getElementById("test-sms-status");

            async function sendTestSMS() {
                const phoneInput = document.getElementById("sms-phone-input");
                const phone = phoneInput ? phoneInput.value.trim() : "";

                if (!phone) {
                    testSmsStatus.style.display = "block";
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = "Please enter a phone number first.";
                    return;
                }

                testSmsStatus.style.display = "block";
                testSmsStatus.style.color = "#94a3b8";
                testSmsStatus.textContent = "Sending test SMS...";
                testSmsBtn.disabled = true;

                const testMessage = "Test alert from Arbitrage Bet Finder - SMS notifications are working!";

                try {
                    const response = await fetch("/api/send-sms", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            phone: phone,
                            message: testMessage
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        testSmsStatus.style.color = "#bbf7d0";
                        testSmsStatus.textContent = `âœ… Test SMS sent successfully! Quota remaining: ${result.quotaRemaining || "N/A"}`;
                    } else {
                        testSmsStatus.style.color = "#fecaca";
                        testSmsStatus.textContent = `âŒ Failed: ${result.detail || result.error || "Unknown error"}`;
                    }
                } catch (error) {
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = `âŒ Error: ${error.message}`;
                } finally {
                    testSmsBtn.disabled = false;
                }
            }

            testSmsBtn.onclick = sendTestSMS;

            // Pull to refresh
            const resultsSection = document.getElementById("results-section");
            const pullRefresh = document.getElementById("pull-refresh");
            let pullStartY = 0;
            let isPullingRefresh = false;

            resultsSection.addEventListener("touchstart", (e) => {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                }
            });

            resultsSection.addEventListener("touchmove", (e) => {
                if (pullStartY === 0) return;
                const currentY = e.touches[0].clientY;
                const diff = currentY - pullStartY;
                if (diff > 50 && window.scrollY === 0) {
                    isPullingRefresh = true;
                    pullRefresh.classList.add("active");
                }
            });

            resultsSection.addEventListener("touchend", () => {
                if (isPullingRefresh) {
                    pullRefresh.classList.remove("active");
                    fetchBestValuePlays(false);
                    isPullingRefresh = false;
                }
                pullStartY = 0;
            });

            window.addEventListener("beforeunload", () => {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                }
            });
        });
    </script>
</body>

</html>