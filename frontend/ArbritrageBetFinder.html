<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Arbitrage Bet Finder</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script>
        // Mobile device detection and redirect
        (function() {
            function isMobileDevice() {
                // Check user agent
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
                
                // Check screen width (mobile if less than 768px)
                const isSmallScreen = window.innerWidth < 768;
                
                // Check touch capability
                const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                
                // Redirect if mobile device detected and not already on mobile page
                if ((mobileRegex.test(userAgent.toLowerCase()) || (isSmallScreen && hasTouchScreen)) 
                    && !window.location.pathname.includes('-mobile.html')) {
                    // Preserve query string and hash if present
                    const newUrl = '/ArbritrageBetFinder-mobile.html' + window.location.search + window.location.hash;
                    window.location.replace(newUrl);
                }
            }
            
            // Run detection immediately
            isMobileDevice();
        })();
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.fade-out {
            opacity: 0;
        }

        body.fade-in {
            opacity: 1;
        }

        header {
            padding: 0.5rem 1rem;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            display: none;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
        }

        header.show {
            display: flex;
        }

        .top-right-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
        }

        .toggle-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
            transition: bottom 0.2s;
        }

        .toggle-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .top-right-buttons .btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .top-right-buttons .btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .top-right-buttons .btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        header h1 {
            margin: 0;
            font-size: 1.1rem;
        }

        header .small-text {
            font-size: 0.7rem;
        }

        header nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        header nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        header nav a:hover {
            color: #e5e7eb;
        }

        header nav a.active {
            color: #bbf7d0;
            font-weight: 600;
        }


        main {
            padding: 0.75rem;
            height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0.75rem;
            align-items: start;
            overflow: hidden;
            padding-top: 0.75rem;
            padding-right: 0.75rem;
            box-sizing: border-box;
            transition: padding-right 0.3s ease;
        }
        
        /* Adjust main layout when watcher panel is open */
        body.watcher-open main {
            padding-right: 320px; /* 300px panel + 20px gap */
        }

        header.show + main {
            padding-top: 3.5rem;
        }

        .filter-panel {
            padding-top: 0;
        }

        @media (max-width: 1600px) {
            main {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 1400px) {
            main {
                grid-template-columns: 260px 1fr;
            }
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            padding: 0.6rem 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card h2 {
            margin-top: 0;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        .card h3 {
            margin-top: 0;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            margin-bottom: 0.1rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        select,
        input[type="number"],
        input[type="tel"] {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border-radius: 0.4rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.8rem;
        }

        select:hover,
        input[type="number"]:hover {
            border-color: #64748b;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.2);
        }

        input[type="checkbox"] {
            margin-right: 0.35rem;
        }

        .btn {
            border: none;
            border-radius: 0.4rem;
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.4rem;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #475569;
            color: #e5e7eb;
        }

        .btn-link:hover {
            background: #334155;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status-bar {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 0.4rem;
        }

        table {
            width: 100%;
            min-width: 800px; /* Ensure table doesn't get too narrow */
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th,
        td {
            border-bottom: 1px solid #334155;
            padding: 0.3rem 0.4rem;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
        }
        
        /* Column width adjustments - use min-width for critical columns */
        th:nth-child(1),
        td:nth-child(1) {
            width: auto;
            min-width: 60px; /* Sport */
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: auto;
            min-width: 160px;
            max-width: 220px; /* Recommended Bet - shortened */
            white-space: normal; /* Allow wrapping for this column */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: auto;
            min-width: 160px; /* Hedge Bet */
            white-space: normal; /* Allow wrapping */
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: auto;
            min-width: 120px; /* Start Time */
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: auto;
            min-width: 130px; /* Arbitrage Margin - ensure it's always visible */
        }

        th:nth-child(6),
        td:nth-child(6) {
            width: auto;
            min-width: 100px; /* Compare Price */
        }

        th {
            background: #1e293b;
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.7rem;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
        }

        /* Custom scrollbar styling */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .small-text {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .odds-highlight {
            color: #000;
            font-weight: 800;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-positive {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-negative {
            background: #7f1d1d;
            color: #fecaca;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .bet-list {
            font-size: 0.75rem;
        }

        .bet-item {
            padding: 0.25rem 0;
            border-bottom: 1px dashed #334155;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 0.4rem;
            display: inline-block;
            object-fit: contain;
        }

        .team-name-with-logo {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toggle-on {
            background: #166534;
            color: #bbf7d0;
            border-color: #15803d;
        }

        .filter-panel {
            height: 100%;
            overflow: hidden;
        }

        .results-panel {
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-toggle-btn {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1002;
            background: #1e293b;
            border: 1px solid #334155;
            border-right: none;
            border-radius: 0.4rem 0 0 0.4rem;
            color: #e5e7eb;
            padding: 1rem 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .panel-toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .panel-toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .panel-toggle-btn .arrow {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .panel-toggle-btn.active .arrow {
            transform: rotate(180deg);
        }

        /* Slide-out panel animation */
        .watcher-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: transparent;
            transition: right 0.3s ease;
            z-index: 1001;
            overflow: hidden;
            padding: 0.75rem;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .watcher-panel.open {
            right: 0;
        }
        

        .watcher-panel .card {
            margin: 0;
            height: 100%;
            max-height: 100%;
        }

        .credits-display {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .credits-display .credits-low {
            color: #fecaca;
        }

        .credits-display .credits-medium {
            color: #fde68a;
        }

        .credits-display .credits-high {
            color: #bbf7d0;
        }
        
        footer {
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Adjust main padding to account for footer */
        main {
            padding-bottom: 3rem;
        }
    </style>
</head>

<body>
    <div class="top-right-buttons">
        <a href="/watcher.html" class="btn smooth-nav" data-href="/watcher.html" title="Go to Bet Watcher">Bet Watcher</a>
        <a href="/linetracker.html" class="btn smooth-nav" data-href="/linetracker.html" title="Go to Line Tracker">Line Tracker</a>
    </div>
    <button class="panel-toggle-btn" id="toggle-watcher-btn" title="Toggle Arb Watcher Panel">
        <span class="arrow">â—€</span>
    </button>
    <header id="main-header">
        <nav>
        </nav>
    </header>

    <main>
        <!-- Filter Panel -->
        <div class="filter-panel">
            <section class="card">
                <h2>Arbitrage Bet Finder</h2>
                <div class="small-text" style="margin-bottom: 0.75rem;">
                    Discover arbitrage opportunities across multiple sports and markets by comparing odds between sportsbooks
                </div>

                <label>Select Sports</label>
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="sport-checkbox" value="basketball_nba" checked />
                        <span style="margin-left: 0.5rem;">NBA</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="sport-checkbox" value="americanfootball_nfl" checked />
                        <span style="margin-left: 0.5rem;">NFL</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="sport-checkbox" value="basketball_ncaab" checked />
                        <span style="margin-left: 0.5rem;">NCAAB</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="sport-checkbox" value="americanfootball_ncaaf" checked />
                        <span style="margin-left: 0.5rem;">NCAAF</span>
                    </label>
                </div>

                <label>Select Markets</label>
                <div style="margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="market-checkbox" value="h2h" checked />
                        <span style="margin-left: 0.5rem;">Moneyline</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="market-checkbox" value="spreads" checked />
                        <span style="margin-left: 0.5rem;">Spreads</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                        <input type="checkbox" class="market-checkbox" value="totals" checked />
                        <span style="margin-left: 0.5rem;">Totals</span>
                    </label>
                </div>

                <label for="best-target-book-select">Target book</label>
                <select id="best-target-book-select">
                    <option value="draftkings">DraftKings</option>
                    <option value="fanduel">FanDuel</option>
                    <option value="fliff">Fliff</option>
                    <option value="novig">Novig</option>
                </select>

                <label for="best-compare-book-select">Compare against</label>
                <select id="best-compare-book-select">
                    <option value="novig" selected>Novig</option>
                    <option value="draftkings">DraftKings</option>
                    <option value="fanduel">FanDuel</option>
                    <option value="fliff">Fliff</option>
                </select>

                <label for="best-max-results-input">Max results</label>
                <input id="best-max-results-input" type="number" min="10" max="200" step="10" value="10" />

                <label style="display: flex; align-items: center; margin-top: 0.75rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                    <input type="checkbox" id="dummy-data-checkbox" style="margin-right: 0.5rem;" />
                    <span>Use Dummy Data (for development when API credits are exhausted)</span>
                </label>

                <label style="display: flex; align-items: center; margin-top: 0.5rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                    <input type="checkbox" id="log-results-checkbox" style="margin-right: 0.5rem;" />
                    <span>Save search results as JSON</span>
                </label>

                <div style="margin-top: 0.75rem;">
                    <button class="btn btn-primary" id="find-best-btn">Find Arbitrage Opportunities</button>
                    <button class="btn btn-secondary" id="clear-best-btn">Clear</button>
                </div>

                <div class="status-bar" id="best-status-bar">Ready.</div>
            </section>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <section class="card" id="best-results-section" style="display: none;">
                <h2>Arbitrage Opportunities</h2>
                <div class="small-text" id="best-summary-bar" style="margin-bottom: 0.4rem;"></div>
                <div class="scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Sport</th>
                                <th>Recommended Bet</th>
                                <th>Hedge Bet</th>
                                <th>Start Time</th>
                                <th>Arbitrage Margin</th>
                                <th>Compare Price</th>
                            </tr>
                        </thead>
                        <tbody id="best-results-body">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Arb Watcher Panel -->
        <div class="watcher-panel" id="watcher-panel">
            <section class="card" id="watcher-card">
                <h2>ðŸ”” Hedge Watcher</h2>
                <div class="small-text" style="margin-bottom: 0.5rem;">
                    Monitor for hedge opportunities (arbitrage margin â‰¥ 0%).
                </div>

                <label for="watcher-interval-input">Check interval (seconds)</label>
                <input id="watcher-interval-input" type="number" min="30" max="300" step="10" value="60" />
                
                <label for="sms-phone-input" style="margin-top: 0.5rem;">SMS Phone (optional)</label>
                <input id="sms-phone-input" type="tel" placeholder="5551234567" />
                
                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-primary" id="start-watcher-btn">Start Watcher</button>
                    <button class="btn btn-secondary" id="stop-watcher-btn" disabled>Stop</button>
                </div>
                
                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-secondary" id="test-sms-btn">Test SMS Alert</button>
                </div>
                
                <div class="status-bar" id="watcher-status-bar" style="margin-top: 0.4rem;">Watcher stopped.</div>
                <div class="status-bar" id="test-sms-status" style="margin-top: 0.4rem; display: none;"></div>
            </section>
        </div>
    </main>

    <!-- Credits Display -->
    <footer style="position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; padding: 0.5rem 1rem; z-index: 1000; text-align: center;">
        <div class="credits-display">
            <span id="api-credits">API: Loading...</span>
        </div>
    </footer>

    <script>
        let valuePollTimer = null;
        let lastValueData = null;
        let filterHedgeOnly = false;
        let watcherTimer = null;
        let lastBestValueData = null;
        let alertedPlayIds = new Set(); // Track plays we've already alerted on

        function formatStartTime(isoString) {
            if (!isoString) return "";
            try {
                const date = new Date(isoString);
                const options = {
                    timeZone: "America/New_York",
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "2-digit",
                    hour12: true,
                };
                return date.toLocaleString("en-US", options) + " ET";
            } catch (e) {
                return isoString;
            }
        }

        function formatMarketLabel(marketKey) {
            const mapping = {
                h2h: "ML",
                spreads: "Spreads",
                totals: "Totals"
            };
            return mapping[marketKey] || marketKey.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        }

        function formatSportLabel(sportKey) {
            const mapping = {
                basketball_nba: "NBA",
                americanfootball_nfl: "NFL",
                basketball_ncaab: "NCAAB",
                americanfootball_ncaaf: "NCAAF"
            };
            return mapping[sportKey] || sportKey.toUpperCase();
        }

        function formatBookLabel(bookKey) {
            const mapping = {
                draftkings: "DraftKings",
                fanduel: "FanDuel",
                fliff: "Fliff",
                novig: "Novig"
            };
            return mapping[bookKey] || bookKey;
        }

        function buildLogFilename(markets, sports, targetBook, compareBook) {
            const timestamp = new Date().toISOString().replace(/[:T]/g, "-").split(".")[0];
            const marketPart = (markets.length ? markets.map(formatMarketLabel) : ["AllMarkets"]).join("+");
            const sportPart = (sports.length ? sports.map(formatSportLabel) : ["AllSports"]).join("+");
            const targetLabel = formatBookLabel(targetBook);
            const compareLabel = formatBookLabel(compareBook);

            const sanitize = (value) => value.replace(/[^a-zA-Z0-9+]+/g, "");
            return `${timestamp}_${sanitize(marketPart)}_${sanitize(sportPart)}_${sanitize(targetLabel)}_vs_${sanitize(compareLabel)}.json`;
        }

        function logSearchResultsToFile(data, { sportKeys, markets, targetBook, compareBook, maxResults, useDummyData }) {
            const payload = {
                logged_at: new Date().toISOString(),
                filters: {
                    sports: sportKeys,
                    markets,
                    target_book: targetBook,
                    compare_book: compareBook,
                    max_results: maxResults,
                    use_dummy_data: useDummyData
                },
                results: data
            };

            const filename = buildLogFilename(markets, sportKeys, targetBook, compareBook);
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function getTeamLogoUrl(teamName, sportKey = null) {
            if (!teamName) return null;
            
            // Team name to ESPN team code mapping
            const teamMapping = {
                // NBA
                "atlanta hawks": "atl",
                "boston celtics": "bos",
                "brooklyn nets": "bkn",
                "charlotte hornets": "cha",
                "chicago bulls": "chi",
                "cleveland cavaliers": "cle",
                "dallas mavericks": "dal",
                "denver nuggets": "den",
                "detroit pistons": "det",
                "golden state warriors": "gs",
                "houston rockets": "hou",
                "indiana pacers": "ind",
                "los angeles clippers": "lac",
                "los angeles lakers": "lal",
                "memphis grizzlies": "mem",
                "miami heat": "mia",
                "milwaukee bucks": "mil",
                "minnesota timberwolves": "min",
                "new orleans pelicans": "no",
                "new york knicks": "ny",
                "oklahoma city thunder": "okc",
                "orlando magic": "orl",
                "philadelphia 76ers": "phi",
                "phoenix suns": "phx",
                "portland trail blazers": "por",
                "sacramento kings": "sac",
                "san antonio spurs": "sa",
                "toronto raptors": "tor",
                "utah jazz": "utah",
                "washington wizards": "wsh",
                // NFL
                "arizona cardinals": "ari",
                "atlanta falcons": "atl",
                "baltimore ravens": "bal",
                "buffalo bills": "buf",
                "carolina panthers": "car",
                "chicago bears": "chi",
                "cincinnati bengals": "cin",
                "cleveland browns": "cle",
                "dallas cowboys": "dal",
                "denver broncos": "den",
                "detroit lions": "det",
                "green bay packers": "gb",
                "houston texans": "hou",
                "indianapolis colts": "ind",
                "jacksonville jaguars": "jax",
                "kansas city chiefs": "kc",
                "las vegas raiders": "lv",
                "los angeles chargers": "lac",
                "los angeles rams": "lar",
                "miami dolphins": "mia",
                "minnesota vikings": "min",
                "new england patriots": "ne",
                "new orleans saints": "no",
                "new york giants": "nyg",
                "new york jets": "nyj",
                "philadelphia eagles": "phi",
                "pittsburgh steelers": "pit",
                "san francisco 49ers": "sf",
                "seattle seahawks": "sea",
                "tampa bay buccaneers": "tb",
                "tennessee titans": "ten",
                "washington commanders": "wsh",
                // NCAAB - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "butler bulldogs": "2086",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "connecticut huskies": "41",
                "creighton bluejays": "154",
                "duke blue devils": "150",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgetown hoyas": "46",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "gonzaga bulldogs": "2250",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "indiana hoosiers": "84",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "marquette golden eagles": "269",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "miami hurricanes": "2390",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "missouri tigers": "142",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "san diego state aztecs": "21",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "syracuse orange": "183",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "villanova wildcats": "222",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275",
                "xavier musketeers": "2752",
                // NCAAF - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "boise state broncos": "68",
                "boston college eagles": "103",
                "byu cougars": "252",
                "california golden bears": "25",
                "central florida knights": "2116",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "miami hurricanes": "2390",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "mississippi rebels": "145",
                "missouri tigers": "142",
                "nebraska cornhuskers": "158",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "tulane green wave": "2655",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "wake forest demon deacons": "154",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275"
            };
            
            // Normalize team name: lowercase, trim, and remove extra spaces
            const normalized = teamName.toLowerCase().trim().replace(/\s+/g, ' ');
            let teamCode = teamMapping[normalized];
            
            // If no mapping found, try to extract from common patterns
            if (!teamCode) {
                // First, try exact matches with common short names and variations
                const shortNameMapping = {
                    "kansas": "2305",  // Kansas Jayhawks
                    "kansas jayhawks": "2305",
                    "jayhawks": "2305",
                    "arizona": "12",   // Arizona Wildcats
                    "arizona wildcats": "12",
                    "wildcats": "12",  // Could match multiple, but Arizona is most common
                    "kentucky": "96",   // Kentucky Wildcats
                    "kentucky wildcats": "96",
                    "duke": "150",     // Duke Blue Devils
                    "duke blue devils": "150",
                    "north carolina": "153",  // North Carolina Tar Heels
                    "north carolina tar heels": "153",
                    "tar heels": "153",
                    "ucla": "26",      // UCLA Bruins
                    "ucla bruins": "26",
                    "usc": "30",       // USC Trojans
                    "usc trojans": "30",
                    "texas": "251",    // Texas Longhorns
                    "texas longhorns": "251",
                    "michigan": "130", // Michigan Wolverines
                    "michigan wolverines": "130",
                    "ohio state": "194", // Ohio State Buckeyes
                    "ohio state buckeyes": "194",
                    "alabama": "333",   // Alabama Crimson Tide
                    "alabama crimson tide": "333",
                    "georgia": "61",    // Georgia Bulldogs
                    "georgia bulldogs": "61",
                    "lsu": "99",       // LSU Tigers
                    "lsu tigers": "99",
                    "florida": "57",    // Florida Gators
                    "florida gators": "57",
                    "tennessee": "2633", // Tennessee Volunteers
                    "tennessee volunteers": "2633",
                    "oklahoma": "201",  // Oklahoma Sooners
                    "oklahoma sooners": "201",
                    "oregon": "2483",   // Oregon Ducks
                    "oregon ducks": "2483",
                    "wisconsin": "275", // Wisconsin Badgers
                    "wisconsin badgers": "275",
                    "penn state": "213", // Penn State Nittany Lions
                    "penn state nittany lions": "213",
                    "notre dame": "87"  // Notre Dame Fighting Irish
                };
                
                // Check short name mapping
                for (const [shortName, code] of Object.entries(shortNameMapping)) {
                    if (normalized === shortName || normalized.startsWith(shortName + " ") || normalized.endsWith(" " + shortName)) {
                        teamCode = code;
                        break;
                    }
                }
                
                // If still not found, try to match partial names (improved logic)
                if (!teamCode) {
                    // Extract first significant word (skip common words like "the", "at", etc.)
                    const words = normalized.split(/\s+/);
                    const firstWord = words.length > 0 ? words[0] : normalized;
                    const secondWord = words.length > 1 ? words[1] : null;
                    
                    for (const [key, code] of Object.entries(teamMapping)) {
                        // Check if normalized name is contained in key or vice versa
                        // Also check if key starts with normalized (e.g., "kansas" matches "kansas jayhawks")
                        if (normalized === key || 
                            key.startsWith(normalized + " ") || 
                            normalized.startsWith(key + " ") ||
                            key.startsWith(firstWord + " ") ||
                            (normalized.length >= 3 && key.includes(normalized)) ||
                            (key.length >= 3 && normalized.includes(key))) {
                            teamCode = code;
                            break;
                        }
                    }
                }
            }
            
            // Determine sport for ESPN URL
            let sportPath = "nba";
            if (sportKey) {
                if (sportKey.includes("ncaaf") || sportKey.includes("ncaab")) {
                    sportPath = "ncaa";
                } else if (sportKey.includes("football") || sportKey.includes("nfl")) {
                    sportPath = "nfl";
                } else if (sportKey.includes("basketball") || sportKey.includes("nba")) {
                    sportPath = "nba";
                }
            }
            
            if (teamCode) {
                return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${teamCode}.png`;
            }
            
            // Fallback: try normalized name
            const fallback = normalized.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${fallback}.png`;
        }


        function formatOdds(odds) {
            /**
             * Format odds in American format.
             * Returns the odds as a string with proper formatting.
             */
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            // American format: Add "+" prefix for positive odds
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        // Legacy function for backwards compatibility
        function formatAmericanOdds(odds) {
            return formatOdds(odds);
        }

        function createTeamNameWithLogo(teamName, sportKey = null) {
            if (!teamName) return document.createTextNode("");
            
            const container = document.createElement("span");
            container.className = "team-name-with-logo";
            
            const logo = document.createElement("img");
            logo.className = "team-logo";
            logo.src = getTeamLogoUrl(teamName, sportKey);
            logo.alt = teamName;
            logo.onerror = function() {
                // Hide logo if it fails to load
                this.style.display = "none";
            };
            
            const nameSpan = document.createElement("span");
            nameSpan.textContent = teamName;
            
            container.appendChild(logo);
            container.appendChild(nameSpan);
            
            return container;
        }

        function parseTeamFromOutcome(outcomeName) {
            // Extract team name from outcome (might include point spread info)
            // Examples: "New York Knicks", "New York Knicks @ -3.5"
            if (!outcomeName) return null;
            
            // Remove point spread info (everything after @)
            const parts = outcomeName.split(" @ ");
            return parts[0].trim();
        }

        function parseTeamsFromMatchup(matchup) {
            // Parse "Away Team @ Home Team" format
            if (!matchup) return { away: null, home: null };
            
            const parts = matchup.split(" @ ");
            if (parts.length === 2) {
                return { away: parts[0].trim(), home: parts[1].trim() };
            }
            return { away: matchup, home: null };
        }


        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setSummary(msg) {
            document.getElementById("summary-bar").textContent = msg;
        }

        function clearResults() {
            const body = document.getElementById("results-body");
            body.innerHTML = '<tr><td colspan="9" class="small-text">No results yet.</td></tr>';
            setSummary("");
            lastValueData = null;
        }

        function renderValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.plays || data.plays.length === 0) {
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || "comparison book";
                body.innerHTML = `<tr><td colspan="9" class="small-text">No arbitrage opportunities found (maybe market is empty or ${compareBookLabel} not available).</td></tr>`;
                return;
            }

            let plays = data.plays;
            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.novig_reverse_name !== null &&
                    p.novig_reverse_name !== undefined &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
            }

            if (plays.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="small-text">No plays match the current hedge filter.</td></tr>';
                return;
            }

            const currentSport = document.getElementById("sport-select").value;
            plays.forEach(play => {
                const tr = document.createElement("tr");

                const outcomeCell = document.createElement("td");
                const teamName = parseTeamFromOutcome(play.outcome_name);
                const teamWithLogo = createTeamNameWithLogo(teamName, play.sport_key || currentSport);
                outcomeCell.appendChild(teamWithLogo);
                if (play.point !== null && play.point !== undefined) {
                    const pointSpan = document.createElement("span");
                    pointSpan.textContent = " @ " + play.point;
                    outcomeCell.appendChild(pointSpan);
                }
                tr.appendChild(outcomeCell);

                const startCell = document.createElement("td");
                startCell.textContent = formatStartTime(play.start_time);
                tr.appendChild(startCell);

                const compareCell = document.createElement("td");
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                const formattedCompareOdds = formatOdds(play.novig_price);
                compareCell.innerHTML = `<strong>${formattedCompareOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                tr.appendChild(compareCell);

                const oppCell = document.createElement("td");
                if (play.novig_reverse_name) {
                    const oppTeamName = parseTeamFromOutcome(play.novig_reverse_name);
                    oppCell.appendChild(createTeamNameWithLogo(oppTeamName, play.sport_key || currentSport));
                } else {
                    oppCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(oppCell);

                const hedgeCell = document.createElement("td");
                if (play.novig_reverse_price !== null && play.novig_reverse_price !== undefined) {
                    const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                    const formattedHedgeOdds = formatOdds(play.novig_reverse_price);
                    hedgeCell.innerHTML = `<strong>${formattedHedgeOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                } else {
                    hedgeCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeCell);

                const bookCell = document.createElement("td");
                const targetBookLabel = document.querySelector("#book-select option:checked")?.textContent || data.target_book || "Target";
                const formattedBookOdds = formatOdds(play.book_price);
                bookCell.innerHTML = `<strong>${formattedBookOdds}</strong><br><span class="small-text">@ ${targetBookLabel}</span>`;
                tr.appendChild(bookCell);

                const hedgeEvCell = document.createElement("td");
                if (play.arb_margin_percent !== null && play.arb_margin_percent !== undefined) {
                    const hedgeRounded = Math.round(play.arb_margin_percent * 100) / 100;
                    const hedgeClass = hedgeRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                    hedgeEvCell.innerHTML = `<span class="${hedgeClass}">${hedgeRounded}%</span>`;
                } else {
                    hedgeEvCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeEvCell);

                const evCell = document.createElement("td");
                const evRounded = Math.round(play.ev_percent * 100) / 100;
                let badgeClass = evRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                evCell.innerHTML = `<span class="${badgeClass}">${evRounded}%</span>`;
                tr.appendChild(evCell);


                body.appendChild(tr);
            });
        }

        function renderValueFromState() {
            if (!lastValueData) return;
            renderValuePlays(lastValueData, filterHedgeOnly);
        }

        async function fetchValuePlays(singleRun = false) {
            const sport = document.getElementById("sport-select").value;
            const market = document.getElementById("market-select").value;
            const book = document.getElementById("book-select").value;
            const compareBook = document.getElementById("compare-book-select").value;
            const maxResults = Number(document.getElementById("max-results-input").value) || 25;

            if (book === compareBook) {
                setStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            if (singleRun) {
                // Don't wipe lastValueData instantly; let new data overwrite.
                setSummary("");
            }
            setStatus("Fetching arbitrage opportunities...");
            try {
                const res = await fetch("/api/value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sport,
                        market,
                        target_book: book,
                        compare_book: compareBook,
                        max_results: maxResults
                    }),
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastValueData = data;
                renderValueFromState();

                const playsCount = (data.plays || []).length;
                const compareBookLabel = document.querySelector("#compare-book-select option:checked").textContent;
                setSummary(`Showing top ${playsCount} arbitrage opportunities for ${book} in market "${market}" vs ${compareBookLabel}. Filter: ${filterHedgeOnly ? "Hedgeable only" : "All"}.`);
                setStatus("Done.");
            } catch (e) {
                console.error(e);
                setStatus("Error: " + e.message);
            }
        }

        function startValueLoop() {
            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }

            setStatus("Watching for arbitrage opportunities...");
            document.getElementById("start-loop-btn").disabled = true;
            document.getElementById("find-btn").disabled = true;
            document.getElementById("stop-loop-btn").disabled = false;

            // initial fetch
            fetchValuePlays(true);
            valuePollTimer = setInterval(() => fetchValuePlays(false), intervalMs);
        }

        function stopValueLoop() {
            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-loop-btn").disabled = false;
            document.getElementById("find-btn").disabled = false;
            document.getElementById("stop-loop-btn").disabled = true;
        }

        function toggleHedgeFilter() {
            filterHedgeOnly = !filterHedgeOnly;
            const btn = document.getElementById("filter-opp-btn");
            if (filterHedgeOnly) {
                btn.classList.add("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (ON)";
            } else {
                btn.classList.remove("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (OFF)";
            }
            renderValueFromState();
        }

        // Arbitrage Finder Functions
        function setBestStatus(msg) {
            document.getElementById("best-status-bar").textContent = msg;
        }

        function setBestSummary(msg) {
            document.getElementById("best-summary-bar").textContent = msg;
        }

        function clearBestResults() {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            document.getElementById("best-results-section").style.display = "none";
            setBestSummary("");
        }

        function renderBestValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            const section = document.getElementById("best-results-section");
            section.style.display = "block";

            if (!data || !data.plays || data.plays.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="small-text">No arbitrage opportunities found.</td></tr>';
                return;
            }

            let plays = data.plays;
            
            // Filter for hedge opportunities only (arb_margin_percent >= 0) when watcher is running
            if (hedgeOnly) {
                plays = plays.filter(p => 
                    p.arb_margin_percent !== null && 
                    p.arb_margin_percent !== undefined && 
                    p.arb_margin_percent >= 0 &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
                if (plays.length === 0) {
                    body.innerHTML = '<tr><td colspan="6" class="small-text">No hedge opportunities found (arbitrage margin â‰¥ 0%).</td></tr>';
                    return;
                }
            }
            
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const marketLabels = {
                "h2h": "Moneyline",
                "spreads": "Spreads",
                "totals": "Totals"
            };

            plays.forEach(play => {
                const tr = document.createElement("tr");

                const sportCell = document.createElement("td");
                sportCell.textContent = sportLabels[play.sport_key] || play.sport_key;
                tr.appendChild(sportCell);

                const bookCell = document.createElement("td");
                const targetBookLabel = document.querySelector("#best-target-book-select option:checked")?.textContent || data.target_book || "Target";
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                let teamName = parseTeamFromOutcome(play.outcome_name);
                const marketLabel = marketLabels[play.market] || play.market;
                const formattedOdds = formatOdds(play.book_price);
                
                // For totals markets, extract team from matchup since outcome is "Over" or "Under"
                let logoTeamName = teamName;
                if (play.market === "totals" && play.matchup) {
                    const teams = parseTeamsFromMatchup(play.matchup);
                    // Use the first team (away team) for the logo
                    logoTeamName = teams.away || teams.home || null;
                }
                
                // Create container for recommended bet with logo
                const betContainer = document.createElement("div");
                betContainer.style.display = "flex";
                betContainer.style.alignItems = "center";
                betContainer.style.gap = "0.4rem";
                
                // Add logo if we have a team name
                if (logoTeamName) {
                    const logo = document.createElement("img");
                    logo.className = "team-logo";
                    logo.src = getTeamLogoUrl(logoTeamName, play.sport_key || null);
                    logo.alt = logoTeamName;
                    logo.onerror = function() {
                        this.style.display = "none";
                    };
                    betContainer.appendChild(logo);
                }
                
                // Add bet description
                const betText = document.createElement("span");
                let betDescription = "";
                if (play.market === "totals") {
                    // For totals, use the outcome name (which already includes the point like "Over 221.0")
                    betDescription = `${play.outcome_name || "Total"}`;
                    // Add matchup teams to the description
                    if (play.matchup) {
                        betDescription += ` - ${play.matchup}`;
                    }
                } else {
                    // For other markets, use team name
                    betDescription = `${teamName || ""} ${marketLabel === "Moneyline" ? "ML" : marketLabel === "Spreads" ? "Spread" : marketLabel}`;
                    if (play.point !== null && play.point !== undefined) {
                        betDescription += ` ${play.point > 0 ? "+" : ""}${play.point}`;
                    }
                }
                betText.innerHTML = `<strong>${betDescription} <span class="odds-highlight">${formattedOdds}</span></strong><br><span class="small-text">@ ${targetBookLabel}</span>`;
                betContainer.appendChild(betText);

                bookCell.appendChild(betContainer);
                tr.appendChild(bookCell);

                const hedgeCell = document.createElement("td");
                if (play.novig_reverse_price !== null && play.novig_reverse_price !== undefined && play.novig_reverse_name) {
                    const formattedHedgeOdds = formatOdds(play.novig_reverse_price);

                    // Parse the opposite side name to format it properly
                    let oppositeTeamName = parseTeamFromOutcome(play.novig_reverse_name);
                    const marketLabel = marketLabels[play.market] || play.market;
                    
                    // Format the opposite side bet description
                    let hedgeDescription = "";
                    if (play.market === "totals") {
                        // For totals, use the outcome name directly (e.g., "Over 221.0" or "Under 221.0")
                        hedgeDescription = play.novig_reverse_name;
                    } else if (play.market === "spreads") {
                        // For spreads, format as "Team Spread +/-X"
                        hedgeDescription = `${oppositeTeamName || ""} ${marketLabel === "Spreads" ? "Spread" : marketLabel}`;
                        if (play.point !== null && play.point !== undefined) {
                            // For spreads, the opposite side has the opposite point
                            const oppositePoint = -play.point;
                            hedgeDescription += ` ${oppositePoint > 0 ? "+" : ""}${oppositePoint}`;
                        }
                    } else {
                        // For moneylines, format as "Team ML"
                        hedgeDescription = `${oppositeTeamName || ""} ML`;
                    }
                    
                    hedgeCell.innerHTML = `<strong>${hedgeDescription} <span class="odds-highlight">${formattedHedgeOdds}</span></strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                } else {
                    hedgeCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeCell);

                const startCell = document.createElement("td");
                startCell.textContent = formatStartTime(play.start_time);
                tr.appendChild(startCell);

                const hedgeEvCell = document.createElement("td");
                if (play.arb_margin_percent !== null && play.arb_margin_percent !== undefined) {
                    const hedgeRounded = Math.round(play.arb_margin_percent * 100) / 100;
                    const hedgeClass = hedgeRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                    hedgeEvCell.innerHTML = `<span class="${hedgeClass}">${hedgeRounded}%</span>`;
                } else {
                    hedgeEvCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeEvCell);

                const compareCell = document.createElement("td");
                const formattedCompareOdds = formatOdds(play.novig_price);
                compareCell.innerHTML = `<strong>${formattedCompareOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                tr.appendChild(compareCell);

                body.appendChild(tr);
            });
        }

        // Request browser notification permission
        async function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                await Notification.requestPermission();
            }
        }

        // Show browser notification for hedge opportunities
        function showHedgeAlert(play) {
            if (!("Notification" in window)) {
                console.log("Browser does not support notifications");
                return;
            }

            if (Notification.permission !== "granted") {
                return;
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            const notification = new Notification(`Hedge Opportunity Found! (${margin}%)`, {
                body: `${sportLabel}: ${teamName} ${bookOdds} vs Hedge ${hedgeOdds}\n${play.matchup || ""}`,
                icon: getTeamLogoUrl(teamName, play.sport_key) || undefined,
                tag: `hedge-${play.event_id}-${play.outcome_name}`, // Prevent duplicate notifications
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }

        // Generate unique ID for a play to track alerts
        function getPlayId(play) {
            return `${play.event_id}-${play.outcome_name}-${play.book_price}-${play.novig_reverse_price}`;
        }

        // Send SMS alert
        async function sendSMSAlert(play) {
            const phoneInput = document.getElementById("sms-phone-input");
            const phone = phoneInput ? phoneInput.value.trim() : "";
            
            if (!phone) {
                return; // No phone number configured, skip SMS
            }
            
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };
            
            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";
            
            // Format message (SMS has 160 char limit, so keep it concise)
            const message = `Hedge Alert! ${sportLabel}: ${teamName} ${bookOdds} vs ${hedgeOdds} (${margin}% margin). ${play.matchup || ""}`;
            
            try {
                const response = await fetch("/api/send-sms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone: phone,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error("SMS send failed:", error.detail || "Unknown error");
                } else {
                    const result = await response.json();
                    console.log("SMS sent successfully. Quota remaining:", result.quotaRemaining);
                }
            } catch (error) {
                console.error("Error sending SMS:", error);
            }
        }

        // Check for new hedge opportunities and alert
        function checkForHedgeAlerts(plays) {
            if (!plays || plays.length === 0) return;

            plays.forEach(play => {
                // Only alert for plays with arbitrage margin >= 0
                if (play.arb_margin_percent !== null && 
                    play.arb_margin_percent !== undefined && 
                    play.arb_margin_percent >= 0 &&
                    play.novig_reverse_price !== null &&
                    play.novig_reverse_price !== undefined) {
                    
                    const playId = getPlayId(play);
                    
                    // Only alert if we haven't seen this play before
                    if (!alertedPlayIds.has(playId)) {
                        alertedPlayIds.add(playId);
                        showHedgeAlert(play);
                        sendSMSAlert(play); // Send SMS alert
                    }
                }
            });
        }

        async function fetchBestValuePlays() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const maxResults = Number(document.getElementById("best-max-results-input").value) || 50;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const shouldLogResults = document.getElementById("log-results-checkbox").checked;

            if (sportCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one sport.");
                return;
            }

            if (marketCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one market.");
                return;
            }

            if (targetBook === compareBook) {
                setBestStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);
            const isWatcherRunning = watcherTimer !== null;
            const shouldLogThisSearch = shouldLogResults && !isWatcherRunning;

            // Only clear results if watcher is not running (to avoid flickering during updates)
            if (!isWatcherRunning) {
                clearBestResults();
            }

            if (isWatcherRunning) {
                setBestStatus("Watcher: Checking for hedge opportunities...");
            } else {
                setBestStatus("Searching for arbitrage opportunities across sports and markets...");
            }
            if (useDummyData) {
                setBestStatus((isWatcherRunning ? "Watcher: Checking for hedge opportunities..." : "Searching for arbitrage opportunities across sports and markets...") + " [DUMMY DATA MODE]");
            }

            try {
                // When watcher is running, we can request fewer results since we only care about hedge opportunities
                // The API already sorts by arb_margin_percent, so top results are most likely to be hedge opportunities
                const requestMaxResults = isWatcherRunning ? maxResults : maxResults * 2;
                
                const res = await fetch("/api/best-value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets: markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        max_results: requestMaxResults,
                        use_dummy_data: useDummyData
                    }),
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastBestValueData = data;

                if (shouldLogThisSearch) {
                    logSearchResultsToFile(data, {
                        sportKeys,
                        markets,
                        targetBook,
                        compareBook,
                        maxResults: requestMaxResults,
                        useDummyData
                    });
                }

                // If watcher is running, filter to show only hedge opportunities
                renderBestValuePlays(data, isWatcherRunning);

                // Check for hedge alerts if watcher is running
                if (isWatcherRunning) {
                    const hedgePlays = (data.plays || []).filter(p => 
                        p.arb_margin_percent !== null && 
                        p.arb_margin_percent !== undefined && 
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    );
                    checkForHedgeAlerts(data.plays);
                    
                    const watcherStatusBar = document.getElementById("watcher-status-bar");
                    const intervalVal = Number(document.getElementById("watcher-interval-input").value) || 60;
                    const newAlerts = hedgePlays.filter(p => !alertedPlayIds.has(getPlayId(p))).length;
                    if (newAlerts > 0) {
                        watcherStatusBar.textContent = `ðŸ”” Found ${hedgePlays.length} hedge opportunities (${newAlerts} new alerts!). Next check in ${intervalVal}s...`;
                    } else {
                        watcherStatusBar.textContent = `Watching... Found ${hedgePlays.length} hedge opportunities. Next check in ${intervalVal}s...`;
                    }
                }

                let playsCount = (data.plays || []).length;
                if (isWatcherRunning) {
                    // Count only hedge opportunities when watcher is running
                    playsCount = data.plays.filter(p => 
                        p.arb_margin_percent !== null && 
                        p.arb_margin_percent !== undefined && 
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    ).length;
                }
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked").textContent;
                if (isWatcherRunning) {
                    setBestSummary(`Hedge Watcher: Showing ${playsCount} hedge opportunities (arbitrage margin â‰¥ 0%) across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                } else {
                    setBestSummary(`Found ${playsCount} arbitrage opportunities across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                }
                setBestStatus(isWatcherRunning ? "Watcher: Updated." : "Done.");
            } catch (e) {
                console.error(e);
                setBestStatus("Error: " + e.message);
            }
        }

        // Save form selections to localStorage
        function saveFormSelections() {
            const selections = {
                sports: Array.from(document.querySelectorAll(".sport-checkbox:checked")).map(cb => cb.value),
                markets: Array.from(document.querySelectorAll(".market-checkbox:checked")).map(cb => cb.value),
                targetBook: document.getElementById("best-target-book-select").value,
                compareBook: document.getElementById("best-compare-book-select").value,
                maxResults: document.getElementById("best-max-results-input").value,
                dummyData: document.getElementById("dummy-data-checkbox").checked,
                logResults: document.getElementById("log-results-checkbox").checked,
                watcherInterval: document.getElementById("watcher-interval-input").value
            };
            localStorage.setItem("arbitrageFinderSelections", JSON.stringify(selections));
        }

        // Load form selections from localStorage
        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("arbitrageFinderSelections");
                if (!saved) return;
                
                const selections = JSON.parse(saved);
                
                // Restore sports checkboxes
                if (selections.sports && Array.isArray(selections.sports)) {
                    document.querySelectorAll(".sport-checkbox").forEach(cb => {
                        cb.checked = selections.sports.includes(cb.value);
                    });
                }
                
                // Restore markets checkboxes
                if (selections.markets && Array.isArray(selections.markets)) {
                    document.querySelectorAll(".market-checkbox").forEach(cb => {
                        cb.checked = selections.markets.includes(cb.value);
                    });
                }
                
                // Restore selects
                if (selections.targetBook) {
                    document.getElementById("best-target-book-select").value = selections.targetBook;
                }
                if (selections.compareBook) {
                    document.getElementById("best-compare-book-select").value = selections.compareBook;
                }
                if (selections.maxResults) {
                    document.getElementById("best-max-results-input").value = selections.maxResults;
                }
                if (selections.dummyData !== undefined) {
                    document.getElementById("dummy-data-checkbox").checked = selections.dummyData;
                }
                if (selections.logResults !== undefined) {
                    document.getElementById("log-results-checkbox").checked = selections.logResults;
                }
                if (selections.watcherInterval) {
                    document.getElementById("watcher-interval-input").value = selections.watcherInterval;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        // Credits display functions
        async function fetchCredits() {
            try {
                const response = await fetch("/api/credits");
                if (!response.ok) {
                    throw new Error("Failed to fetch credits");
                }
                const data = await response.json();
                updateCreditsDisplay(data);
            } catch (error) {
                console.error("Error fetching credits:", error);
                document.getElementById("api-credits").textContent = "API: Error";
            }
        }

        function updateCreditsDisplay(data) {
            const apiCreditsEl = document.getElementById("api-credits");

            if (data.api_credits) {
                const credits = data.api_credits;
                const percentage = (credits.used / credits.total) * 100;
                let className = "credits-high";
                if (percentage >= 90) {
                    className = "credits-low";
                } else if (percentage >= 70) {
                    className = "credits-medium";
                }
                apiCreditsEl.textContent = `API: ${credits.display}`;
                apiCreditsEl.className = className;
            } else {
                apiCreditsEl.textContent = "API: N/A";
                apiCreditsEl.className = "";
            }
        }

        // Refresh credits every 5 minutes
        function startCreditsRefresh() {
            fetchCredits(); // Initial fetch
            setInterval(fetchCredits, 5 * 60 * 1000); // Refresh every 5 minutes
        }

        // Smooth page navigation with fade transition
        function smoothNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 300); // Match the CSS transition duration
        }

        // Fade in on page load
        function fadeInPage() {
            requestAnimationFrame(() => {
                document.body.classList.add('fade-in');
            });
        }

        // Handle both initial load and back/forward navigation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fadeInPage);
        } else {
            fadeInPage();
        }

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was loaded from cache (back/forward navigation)
                document.body.classList.remove('fade-in');
                requestAnimationFrame(() => {
                    document.body.classList.add('fade-in');
                });
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            // Set up smooth navigation for all smooth-nav links
            document.querySelectorAll('.smooth-nav').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-href') || link.getAttribute('href');
                    if (url) {
                        smoothNavigate(url);
                    }
                });
            });

            // Mark the current page button as active (Bet Watcher button should not be active on this page)
            const watcherButton = document.querySelector('.top-right-buttons .smooth-nav[data-href="/watcher.html"]');
            if (watcherButton) {
                watcherButton.classList.remove('active');
            }

            // Start credits refresh
            startCreditsRefresh();

            // Load saved form selections
            loadFormSelections();

            // Save form selections when they change
            document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                el.addEventListener("change", saveFormSelections);
            });
            document.getElementById("best-target-book-select").addEventListener("change", saveFormSelections);
            document.getElementById("best-compare-book-select").addEventListener("change", saveFormSelections);
            document.getElementById("best-max-results-input").addEventListener("change", saveFormSelections);
            document.getElementById("dummy-data-checkbox").addEventListener("change", saveFormSelections);
            document.getElementById("log-results-checkbox").addEventListener("change", saveFormSelections);
            document.getElementById("watcher-interval-input").addEventListener("change", saveFormSelections);

            // Load dummy data setting from localStorage
            const dummyDataCheckbox = document.getElementById("dummy-data-checkbox");
            const savedDummyData = localStorage.getItem("useDummyData");
            if (savedDummyData === "true") {
                dummyDataCheckbox.checked = true;
            }
            
            // Save dummy data setting to localStorage when changed
            dummyDataCheckbox.addEventListener("change", (e) => {
                localStorage.setItem("useDummyData", e.target.checked ? "true" : "false");
            });

            // Load and save SMS phone number from localStorage
            const smsPhoneInput = document.getElementById("sms-phone-input");
            const savedPhone = localStorage.getItem("smsPhoneNumber");
            if (savedPhone && smsPhoneInput) {
                smsPhoneInput.value = savedPhone;
            }
            if (smsPhoneInput) {
                smsPhoneInput.addEventListener("change", (e) => {
                    localStorage.setItem("smsPhoneNumber", e.target.value);
                });
            }
            
            // Arbitrage Finder buttons
            document.getElementById("find-best-btn").onclick = () => fetchBestValuePlays();
            document.getElementById("clear-best-btn").onclick = clearBestResults;

            // Arbitrage finder book validation
            const bestTargetBook = document.getElementById("best-target-book-select");
            const bestCompareBook = document.getElementById("best-compare-book-select");
            
            function validateBestBookSelection() {
                if (bestTargetBook.value === bestCompareBook.value) {
                    setBestStatus("Error: Target book and comparison book cannot be the same.");
                    return false;
                }
                return true;
            }
            
            bestTargetBook.addEventListener("change", validateBestBookSelection);
            bestCompareBook.addEventListener("change", validateBestBookSelection);

            // Watcher functionality
            const watcherIntervalInput = document.getElementById("watcher-interval-input");
            const startWatcherBtn = document.getElementById("start-watcher-btn");
            const stopWatcherBtn = document.getElementById("stop-watcher-btn");
            const watcherStatusBar = document.getElementById("watcher-status-bar");

            // Request notification permission on page load
            requestNotificationPermission();

            function startWatcher() {
                const intervalVal = Number(watcherIntervalInput.value) || 60;
                const intervalMs = Math.max(intervalVal, 30) * 1000; // min 30 seconds

                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }

                // Validate book selection
                if (!validateBestBookSelection()) {
                    return;
                }

                // Clear previous alerts when starting fresh
                alertedPlayIds.clear();

                watcherStatusBar.textContent = `Starting watcher... Checking for hedge opportunities every ${intervalVal}s...`;
                startWatcherBtn.disabled = true;
                stopWatcherBtn.disabled = false;
                document.getElementById("find-best-btn").disabled = true;

                // Show results section
                document.getElementById("best-results-section").style.display = "block";

                // Initial fetch
                fetchBestValuePlays();

                // Set up polling with error handling
                watcherTimer = setInterval(async () => {
                    try {
                        await fetchBestValuePlays();
                    } catch (error) {
                        console.error("Watcher error:", error);
                        watcherStatusBar.textContent = `Error: ${error.message}. Retrying in ${intervalVal}s...`;
                    }
                }, intervalMs);
            }

            function stopWatcher() {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }
                watcherStatusBar.textContent = "Watcher stopped.";
                startWatcherBtn.disabled = false;
                stopWatcherBtn.disabled = true;
                document.getElementById("find-best-btn").disabled = false;

                // Re-render results without hedge filter when watcher stops
                if (lastBestValueData) {
                    renderBestValuePlays(lastBestValueData, false);
                }
            }

            startWatcherBtn.onclick = startWatcher;
            stopWatcherBtn.onclick = stopWatcher;

            // Test SMS functionality
            const testSmsBtn = document.getElementById("test-sms-btn");
            const testSmsStatus = document.getElementById("test-sms-status");
            
            async function sendTestSMS() {
                const phoneInput = document.getElementById("sms-phone-input");
                const phone = phoneInput ? phoneInput.value.trim() : "";
                
                if (!phone) {
                    testSmsStatus.style.display = "block";
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = "Please enter a phone number first.";
                    return;
                }
                
                testSmsStatus.style.display = "block";
                testSmsStatus.style.color = "#94a3b8";
                testSmsStatus.textContent = "Sending test SMS...";
                testSmsBtn.disabled = true;
                
                const testMessage = "Test alert from Arbitrage Bet Finder - SMS notifications are working!";
                
                try {
                    const response = await fetch("/api/send-sms", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            phone: phone,
                            message: testMessage
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        testSmsStatus.style.color = "#bbf7d0";
                        testSmsStatus.textContent = `âœ… Test SMS sent successfully! Quota remaining: ${result.quotaRemaining || "N/A"}`;
                    } else {
                        testSmsStatus.style.color = "#fecaca";
                        testSmsStatus.textContent = `âŒ Failed: ${result.detail || result.error || "Unknown error"}`;
                    }
                } catch (error) {
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = `âŒ Error: ${error.message}`;
                } finally {
                    testSmsBtn.disabled = false;
                }
            }
            
            testSmsBtn.onclick = sendTestSMS;

            // Clean up on page unload
            window.addEventListener("beforeunload", () => {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                }
            });

            // Toggle panel functionality
            const toggleWatcherBtn = document.getElementById("toggle-watcher-btn");
            const watcherPanel = document.getElementById("watcher-panel");

            // Load toggle states from localStorage
            const watcherVisible = localStorage.getItem("watcherVisible") === "true";

            // Set initial states
            if (watcherVisible) {
                watcherPanel.classList.add("open");
                toggleWatcherBtn.classList.add("active");
                document.body.classList.add("watcher-open");
            }

            // Toggle watcher panel
            toggleWatcherBtn.onclick = () => {
                const isOpen = watcherPanel.classList.contains("open");
                if (isOpen) {
                    watcherPanel.classList.remove("open");
                    toggleWatcherBtn.classList.remove("active");
                    document.body.classList.remove("watcher-open");
                    localStorage.setItem("watcherVisible", "false");
                } else {
                    watcherPanel.classList.add("open");
                    toggleWatcherBtn.classList.add("active");
                    document.body.classList.add("watcher-open");
                    localStorage.setItem("watcherVisible", "true");
                }
            };


        });
    </script>
</body>

</html>