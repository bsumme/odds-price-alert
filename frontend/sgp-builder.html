<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Same-Game Parlay Builder</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }

        header {
            padding: 1rem 1.5rem;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            margin: 0;
            font-size: 1.3rem;
        }

        header nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.85rem;
            margin-left: 0.75rem;
        }

        header nav a:hover {
            color: #e5e7eb;
        }

        header nav a.active {
            color: #bbf7d0;
            font-weight: 600;
        }

        .odds-format-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            padding: 0.5rem 0.75rem;
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
        }

        .odds-format-toggle label {
            font-size: 0.85rem;
            color: #cbd5e1;
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .odds-format-toggle input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        main {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: minmax(0, 420px) minmax(0, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .card {
            background: #1e293b;
            border-radius: 0.75rem;
            border: 1px solid #334155;
            padding: 1rem 1.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.6rem;
            margin-bottom: 0.15rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.9rem;
        }

        select:hover,
        input[type="number"]:hover {
            border-color: #64748b;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.2);
        }

        input[type="checkbox"] {
            margin-right: 0.35rem;
        }

        .btn {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.9rem;
            font-size: 0.9rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-top: 0.75rem;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status-bar {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .small-text {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .sgp-list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 0.75rem;
        }

        .sgp-card {
            background: #111827;
            border: 1px solid #334155;
            border-radius: 0.65rem;
            padding: 0.75rem 0.9rem;
        }

        .sgp-header {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: baseline;
            margin-bottom: 0.35rem;
        }

        .sgp-legs {
            margin: 0.35rem 0;
            padding-left: 1rem;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-positive {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-negative {
            background: #7f1d1d;
            color: #fecaca;
        }

        .odds-chip {
            display: inline-block;
            padding: 0.1rem 0.45rem;
            border-radius: 0.4rem;
            font-weight: 700;
        }

        .odds-plus-strong {
            background: #14532d;
            color: #bbf7d0;
        }

        .odds-plus {
            background: #166534;
            color: #bbf7d0;
        }

        .odds-plus-light {
            background: #15803d;
            color: #dcfce7;
        }

        .odds-favorite-strong {
            background: #7f1d1d;
            color: #fecdd3;
        }

        .odds-favorite {
            background: #991b1b;
            color: #fecaca;
        }

        .odds-favorite-light {
            background: #b91c1c;
            color: #fee2e2;
        }

        .odds-neutral {
            background: #374151;
            color: #e5e7eb;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>Same-Game Parlay Builder</h1>
            <div class="small-text">Pick a game, combine main markets and player props, and see the best boosted parlays.</div>
        </div>
        <nav>
            <a href="/BensSportsBookApp.html">Arbitrage Finder</a>
            <a href="/sgp-builder.html" class="active">SGP Builder</a>
            <a href="/playerprops.html">Player Props</a>
            <a href="/settings.html">Settings</a>
            <div class="odds-format-toggle">
                <label>
                    <input type="radio" name="odds-format" value="american" checked />
                    <span>American</span>
                </label>
                <label>
                    <input type="radio" name="odds-format" value="decimal" />
                    <span>Decimal</span>
                </label>
            </div>
        </nav>
    </header>

    <main>
        <section class="card">
            <h2>Build a Same-Game Parlay</h2>
            <div class="small-text" style="margin-bottom: 0.5rem;">
                Choose a matchup, then blend player props with core markets for one game to see the best boosted combination.
            </div>

            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <label style="margin: 0;">Sport</label>
                <button id="toggle-all-sports-btn"
                    style="padding: 0.3rem 0.6rem; font-size: 0.85rem; cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">
                    Show All Sports
                </button>
            </div>
            <select id="sport-select">
                <option value="">Select a sport</option>
            </select>

            <label for="game-select">Pick a game</label>
            <select id="game-select" disabled>
                <option value="">Select a sport first</option>
            </select>
            <div class="small-text" id="game-helper-text">Pick a sport to see upcoming games.</div>

            <label for="target-book-select">Target book</label>
            <select id="target-book-select">
                <option value="draftkings">DraftKings</option>
                <option value="fanduel">FanDuel</option>
                <option value="fliff">Fliff</option>
                <option value="novig">Novig</option>
            </select>

            <label for="compare-book-select">Compare against</label>
            <select id="compare-book-select">
                <option value="novig" selected>Novig</option>
                <option value="draftkings">DraftKings</option>
                <option value="fanduel">FanDuel</option>
                <option value="fliff">Fliff</option>
            </select>

            <label style="display: flex; align-items: center; margin-top: 0.75rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                <input type="checkbox" id="dummy-data-checkbox" style="margin-right: 0.5rem;" />
                <span>Use Dummy Data</span>
            </label>

            <label for="sgp-boost-input" style="margin-top: 0.75rem;">Promo boost % (20-100, default 30)</label>
            <input id="sgp-boost-input" type="number" min="20" max="100" step="5" value="30" />

            <label style="display: flex; align-items: center; gap: 0.35rem; margin-top: 0.6rem;">
                <input type="checkbox" id="avoid-correlation-checkbox" checked />
                <span>Avoid correlated legs (prefer diverse player props)</span>
            </label>

            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 0.6rem;">
                <label class="small-text" style="display: flex; gap: 0.35rem; align-items: center;">
                    Min total odds
                    <input id="sgp-min-odds-input" type="number" value="100" style="width: 6rem;" />
                </label>
                <label class="small-text" style="display: flex; gap: 0.35rem; align-items: center;">
                    Max total odds
                    <input id="sgp-max-odds-input" type="number" value="20000" style="width: 6rem;" />
                </label>
            </div>

            <button class="btn btn-primary" id="build-sgp-btn" disabled style="margin-top: 0.5rem;">Build SGP</button>
            <div class="status-bar" id="sgp-status-bar">Select a sport and game to start building.</div>
        </section>

        <section class="card">
            <h2>Recommended Parlays</h2>
            <div class="small-text" id="summary-bar">No same-game parlay generated yet.</div>
            <div id="sgp-results" class="small-text" style="margin-top: 0.5rem;">Pick a game to see suggestions.</div>
        </section>
    </main>

    <script>
        const ALL_PLAYER_PROPS_VALUE = "all_player_props";
        let currentGames = [];
        let showAllSports = false;

        function setSgpStatus(message) {
            const el = document.getElementById('sgp-status-bar');
            if (el) el.textContent = message;
        }

        function setSummary(message) {
            const el = document.getElementById('summary-bar');
            if (el) el.textContent = message;
        }

        function setResults(html) {
            const container = document.getElementById('sgp-results');
            if (container) container.innerHTML = html;
        }

        function formatGameLabel(game) {
            const date = game.commence_time ? new Date(game.commence_time) : null;
            const dateText = date
                ? date.toLocaleString("en-US", {
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "2-digit",
                }) + " ET"
                : "";
            return dateText ? `${game.matchup} — ${dateText}` : game.matchup;
        }

        function formatStartTime(isoString) {
            if (!isoString) return "";
            const trimmed = String(isoString).trim();
            if (!trimmed) return "";
            const date = new Date(trimmed);
            if (Number.isNaN(date.getTime())) return trimmed;
            const options = {
                timeZone: "America/New_York",
                month: "short",
                day: "numeric",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            };
            return date.toLocaleString("en-US", options) + " ET";
        }

        function americanToDecimal(odds) {
            if (odds === null || odds === undefined) return null;
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) return null;
            if (numOdds > 0) {
                return 1.0 + numOdds / 100.0;
            } else {
                return 1.0 + 100.0 / Math.abs(numOdds);
            }
        }

        function getOddsFormat() {
            return localStorage.getItem("oddsFormat") || "american";
        }

        function setOddsFormat(format) {
            localStorage.setItem("oddsFormat", format);
        }

        function formatOdds(odds) {
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            const format = getOddsFormat();
            if (format === "decimal") {
                const decimal = americanToDecimal(numOdds);
                return decimal ? decimal.toFixed(2) : String(odds);
            }
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        function getOddsColorClass(odds) {
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (numOdds === null || numOdds === undefined || isNaN(numOdds)) {
                return "";
            }

            const absOdds = Math.abs(numOdds);

            if (absOdds <= 115) return "odds-neutral";

            if (numOdds > 0) {
                if (numOdds >= 350) return "odds-plus-strong";
                if (numOdds >= 200) return "odds-plus";
                if (numOdds >= 120) return "odds-plus-light";
                return "odds-neutral";
            }

            if (numOdds <= -350) return "odds-favorite-strong";
            if (numOdds <= -200) return "odds-favorite";
            if (numOdds <= -120) return "odds-favorite-light";
            return "odds-neutral";
        }

        function formatOddsWithColor(odds) {
            const formatted = formatOdds(odds);
            const className = getOddsColorClass(odds);
            if (!className) return formatted;
            return `<span class="odds-chip ${className}">${formatted}</span>`;
        }

        function formatEvBadge(evPercent) {
            if (evPercent === null || evPercent === undefined || Number.isNaN(evPercent)) {
                return '<span class="small-text">-</span>';
            }

            const rounded = Math.round(evPercent * 100) / 100;
            const evClass = rounded >= 0 ? "badge badge-positive" : "badge badge-negative";
            return `<span class="${evClass}">${rounded}%</span>`;
        }

        function clampBoostPercent(value) {
            if (Number.isNaN(value)) return 30;
            return Math.min(100, Math.max(20, value));
        }

        function parseOddsRangeInput(element, fallback) {
            const parsed = Number.parseInt(element?.value, 10);
            if (Number.isNaN(parsed)) {
                if (element) element.value = fallback;
                return fallback;
            }
            return parsed;
        }

        function getSgpOddsRange() {
            const minInput = document.getElementById("sgp-min-odds-input");
            const maxInput = document.getElementById("sgp-max-odds-input");

            const minOdds = parseOddsRangeInput(minInput, 100);
            const maxOdds = parseOddsRangeInput(maxInput, 20000);

            if (minOdds > maxOdds && maxInput) {
                maxInput.value = minOdds;
                return { minOdds, maxOdds: minOdds };
            }

            return { minOdds, maxOdds };
        }

        function describeSgp(label, sgp) {
            if (!sgp) return "";
            let html = `<div class="sgp-card"><div class="sgp-header"><div><strong>${label}</strong> — ${sgp.matchup}`;
            if (sgp.start_time) {
                html += ` • ${formatStartTime(sgp.start_time)}`;
            }
            html += `</div><div class="small-text">Boosted ${sgp.boost_percent}%: <strong>${formatOdds(sgp.boosted_american_odds)}</strong></div></div>`;
            html += '<ol class="sgp-legs">';
            sgp.legs.forEach((leg) => {
                const hedgeText = leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom: 0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOddsWithColor(leg.book_price)})</div>
                    <div class="small-text">${leg.market || ''} • Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';
            const baseOdds = (sgp.combined_american_odds !== null && sgp.combined_american_odds !== undefined)
                ? formatOdds(sgp.combined_american_odds)
                : '—';
            const baseDecimal = sgp.combined_decimal_odds ? `${sgp.combined_decimal_odds.toFixed(2)}x` : '—';
            const boostedOdds = (sgp.boosted_american_odds !== null && sgp.boosted_american_odds !== undefined)
                ? formatOdds(sgp.boosted_american_odds)
                : '—';
            const boostedDecimal = sgp.boosted_decimal_odds ? `${sgp.boosted_decimal_odds.toFixed(2)}x` : '—';
            html += `<div class="small-text">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div class="small-text">Boosted (${sgp.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;
            if (sgp.note) {
                html += `<div class="small-text" style="color: #fbbf24;">${sgp.note}</div>`;
            }
            html += '</div>';
            return html;
        }

        function renderSgpResults(data) {

            const warningsHtml = (data && data.warnings && data.warnings.length)
                ? `<div class="small-text" style="color: #fbbf24; margin-top: 0.35rem;">${data.warnings.join(' ')}</div>`
                : '';

            if (!data || (!data.best_sgp && !data.uncorrelated_sgp)) {
                setSummary((data && data.warnings && data.warnings.join(' ')) || 'No same-game parlay recommendation available for this sport right now.');
                setResults(warningsHtml);
                return;
            }

            let html = '<ul class="sgp-list">';
            if (data.best_sgp) {
                html += `<li>${describeSgp('Top SGP', data.best_sgp)}</li>`;
            }
            if (data.uncorrelated_sgp) {
                html += `<li>${describeSgp('Uncorrelated SGP', data.uncorrelated_sgp)}</li>`;
            }
            html += '</ul>';

            html += warningsHtml;

            setResults(html);

            const entries = [data.best_sgp, data.uncorrelated_sgp].filter(Boolean);
            setSummary(`Showing ${entries.length} same-game parlay option${entries.length === 1 ? '' : 's'}.`);
        }

        function updateBuildButtonState() {
            const sport = document.getElementById("sport-select").value;
            const gameId = document.getElementById("game-select").value;
            const btn = document.getElementById("build-sgp-btn");
            const helper = document.getElementById("game-helper-text");

            const disabled = !sport;
            btn.disabled = disabled;
            helper.textContent = disabled
                ? "Pick a sport to build an SGP from player props and main markets."
                : "Ready to build for your selected matchup or scan all games.";
        }

        async function loadGames() {
            const sport = document.getElementById("sport-select").value;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const helper = document.getElementById("game-helper-text");
            const select = document.getElementById("game-select");

            select.disabled = true;
            select.innerHTML = '<option value="">Loading…</option>';

            if (!sport) {
                helper.textContent = "Pick a sport to see upcoming games.";
                select.innerHTML = '<option value="">Select a sport first</option>';
                updateBuildButtonState();
                return;
            }

            helper.textContent = "Loading games...";
            currentGames = [];

            try {
                const res = await fetch("/api/player-props/games", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sport,
                        use_dummy_data: useDummyData,
                    }),
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                const data = await res.json();
                currentGames = data.games || [];
                select.innerHTML = '<option value="">All games (best overall)</option>';

                if (!currentGames.length) {
                    helper.textContent = "No upcoming games with player props found for this sport.";
                } else {
                    helper.textContent = "Pick a specific matchup or scan every game to find the best SGP across the sport.";
                    const fragment = document.createDocumentFragment();
                    currentGames.forEach(game => {
                        const option = document.createElement("option");
                        option.value = game.event_id;
                        option.textContent = formatGameLabel(game);
                        fragment.appendChild(option);
                    });
                    select.appendChild(fragment);
                }
            } catch (err) {
                console.error(err);
                helper.textContent = `Couldn't load games: ${err.message}`;
                select.innerHTML = '<option value="">Select a sport first</option>';
            } finally {
                select.disabled = false;
                updateBuildButtonState();
            }
        }

        function clampBoostInput() {
            const boostInput = document.getElementById("sgp-boost-input");
            const boostPercent = clampBoostPercent(parseFloat(boostInput.value));
            boostInput.value = boostPercent;
            return boostPercent;
        }

        async function buildSgpForSelectedGame() {
            const sport = document.getElementById("sport-select").value;
            const eventId = document.getElementById("game-select").value || null;
            const targetBook = document.getElementById("target-book-select").value;
            const compareBook = document.getElementById("compare-book-select").value;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const avoidCorrelation = document.getElementById("avoid-correlation-checkbox").checked;
            const boostPercent = clampBoostInput();
            const { minOdds, maxOdds } = getSgpOddsRange();

            if (!sport) {
                setSgpStatus("Select a sport first.");
                return;
            }
            if (targetBook === compareBook) {
                setSgpStatus("Target book and comparison book must differ for SGP building.");
                return;
            }

            const selectedGame = currentGames.find(g => g.event_id === eventId);
            const sportLabel = document.querySelector('#sport-select option:checked')?.textContent || sport;
            const scopeLabel = selectedGame ? formatGameLabel(selectedGame) : `${sportLabel} (all games)`;
            setSgpStatus(`Building SGP from player props and main markets for ${scopeLabel}...`);

            try {
                const res = await fetch("/api/sgp-builder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sport,
                        event_id: eventId,
                        target_book: targetBook,
                        compare_book: compareBook,
                        boost_percent: boostPercent,
                        use_dummy_data: useDummyData,
                        avoid_correlation: avoidCorrelation,
                        min_total_american_odds: minOdds,
                        max_total_american_odds: maxOdds,
                    })
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }

                const data = await res.json();
                renderSgpResults(data);
                setSgpStatus(`Updated SGP recommendations for ${scopeLabel}.`);
            } catch (err) {
                console.error(err);
                setSgpStatus(`SGP builder failed: ${err.message}`);
            }
        }

        async function fetchAndPopulateSports(showAll = false) {
            try {
                const res = await fetch('/api/sports');
                if (!res.ok) throw new Error('Failed to fetch sports');
                const list = await res.json();
                const sel = document.getElementById('sport-select');
                if (!sel) return;
                sel.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = '';
                defaultOpt.textContent = 'Select a sport';
                sel.appendChild(defaultOpt);
                for (const s of list) {
                    if (!s || !s.key) continue;
                    if (!showAll && !s.active) continue;
                    const opt = document.createElement('option');
                    opt.value = s.key;
                    opt.textContent = s.title || s.key;
                    sel.appendChild(opt);
                }
            } catch (err) {
                console.warn('Could not load sports schema for SGP builder', err);
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('input[name="odds-format"]').forEach(r => {
                r.disabled = false;
            });

            const savedFormat = localStorage.getItem("oddsFormat") || "american";
            document.querySelectorAll('input[name="odds-format"]').forEach(radio => {
                if (radio.value === savedFormat) {
                    radio.checked = true;
                }
                radio.addEventListener("change", (e) => {
                    if (e.target.checked) {
                        setOddsFormat(e.target.value);
                        // Rerender results to respect the new odds format
                        const sport = document.getElementById("sport-select").value;
                        if (sport && document.getElementById("game-select").value) {
                            buildSgpForSelectedGame();
                        }
                    }
                });
            });

            fetchAndPopulateSports();
            loadGames();

            document.getElementById('toggle-all-sports-btn').addEventListener('click', () => {
                showAllSports = !showAllSports;
                const btn = document.getElementById('toggle-all-sports-btn');
                btn.textContent = showAllSports ? 'Show Active Only' : 'Show All Sports';
                btn.style.backgroundColor = showAllSports ? '#e8f5e9' : '#f0f0f0';
                fetchAndPopulateSports(showAllSports);
            });

            document.getElementById("sport-select").addEventListener("change", () => {
                loadGames();
            });

            document.getElementById("dummy-data-checkbox").addEventListener("change", loadGames);
            document.getElementById("game-select").addEventListener("change", updateBuildButtonState);

            document.getElementById("target-book-select").addEventListener("change", updateBuildButtonState);
            document.getElementById("compare-book-select").addEventListener("change", updateBuildButtonState);

            document.getElementById("build-sgp-btn").onclick = buildSgpForSelectedGame;
        });
    </script>
</body>

</html>
