<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Featured SGP Builder</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --border: #1f2937;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #22c55e;
            --warning: #fbbf24;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        h1,
        h2,
        h3 {
            margin: 0 0 0.4rem 0;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            margin-bottom: 1rem;
        }

        header p {
            color: var(--muted);
            margin: 0.25rem 0 0 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        label {
            display: block;
            margin: 0.35rem 0 0.1rem 0;
            font-weight: 600;
        }

        select,
        input[type="number"],
        button {
            width: 100%;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: #0b1224;
            color: var(--text);
            font-size: 0.95rem;
        }

        button {
            cursor: pointer;
            background: #1f2937;
            border-color: #334155;
            transition: background 0.15s ease;
        }

        button:hover {
            background: #273449;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            border-color: #3b82f6;
        }

        .btn-secondary {
            background: #334155;
            border-color: #475569;
        }

        .status {
            margin-top: 0.6rem;
            padding: 0.6rem;
            background: #0b1224;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
        }

        .game-card {
            border: 1px solid var(--border);
            background: #0b1224;
            border-radius: 6px;
            padding: 0.75rem;
            cursor: pointer;
            transition: border 0.15s ease, transform 0.15s ease;
        }

        .game-card:hover {
            border-color: #475569;
            transform: translateY(-2px);
        }

        .game-card h3 {
            margin-bottom: 0.25rem;
        }

        .pill {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: rgba(34, 197, 94, 0.12);
            color: var(--accent);
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 999px;
            font-size: 0.8rem;
            margin-right: 0.35rem;
        }

        .muted {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .pool-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border);
            background: #0b1224;
            padding: 0.6rem;
            border-radius: 5px;
            margin-bottom: 0.4rem;
            gap: 0.5rem;
        }

        .pool-item button {
            width: auto;
            padding: 0.35rem 0.6rem;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .result-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            background: #0b1224;
        }

        .small-text {
            font-size: 0.9rem;
            color: var(--muted);
        }

        ol {
            margin: 0.35rem 0 0 1rem;
            padding-left: 1rem;
        }

        .tag-list {
            margin-top: 0.4rem;
        }

        .error-text {
            color: var(--danger);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="page">
        <header>
            <h1>Featured Same-Game Parlay Builder</h1>
            <p>Pick from tonight's headline matchups or search by sport, then let the SGP builder hunt for the best legs using
                the comparison book as your guide.</p>
        </header>

        <div class="grid">
            <section class="card">
                <h2>Builder Settings</h2>
                <label for="target-book">Target book</label>
                <select id="target-book">
                    <option value="draftkings">DraftKings</option>
                    <option value="fanduel">FanDuel</option>
                    <option value="fliff">Fliff</option>
                    <option value="novig">Novig</option>
                </select>

                <label for="compare-book">Compare against</label>
                <select id="compare-book">
                    <option value="novig" selected>Novig</option>
                    <option value="draftkings">DraftKings</option>
                    <option value="fanduel">FanDuel</option>
                    <option value="fliff">Fliff</option>
                </select>

                <label for="boost-input">Promo boost % (20-100)</label>
                <input id="boost-input" type="number" min="20" max="100" value="30" />

                <label class="small-text" style="display:flex; align-items:center; gap:0.4rem; margin-top:0.5rem;">
                    <input type="checkbox" id="avoid-correlation" checked style="width:auto;" />
                    <span>Avoid correlated legs</span>
                </label>

                <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                    <label class="small-text" style="flex:1; display:flex; align-items:center; gap:0.3rem;">
                        Min odds
                        <input id="min-odds" type="number" value="100" style="width:7rem;" />
                    </label>
                    <label class="small-text" style="flex:1; display:flex; align-items:center; gap:0.3rem;">
                        Max odds
                        <input id="max-odds" type="number" value="20000" style="width:7rem;" />
                    </label>
                </div>

                <label class="small-text" style="display:flex; align-items:center; gap:0.35rem; margin-top:0.6rem;">
                    <input type="checkbox" id="use-dummy" style="width:auto;" />
                    <span>Use dummy data</span>
                </label>

                <button id="build-btn" class="btn-primary" style="margin-top:0.8rem;">Build SGPs for selected games</button>
                <div id="status" class="status">Loading featured games…</div>
            </section>

            <section class="card">
                <h2>Featured games tonight</h2>
                <div class="small-text">Automatically pulled from the main markets across the top leagues. Click to add to your pool.</div>
                <div id="featured-games" class="game-grid" style="margin-top:0.75rem;"></div>
                <div id="featured-empty" class="small-text" style="margin-top:0.5rem; display:none;">No featured games available right now.</div>
            </section>

            <section class="card">
                <h2>Find more by sport</h2>
                <label for="sport-select">Sport</label>
                <select id="sport-select"></select>
                <button id="load-sport" class="btn-secondary" style="margin-top:0.6rem;">Show games</button>
                <div id="sport-games" class="game-grid" style="margin-top:0.75rem;"></div>
                <div id="sport-empty" class="small-text" style="margin-top:0.5rem; display:none;">Pick a sport to browse its schedule.</div>
            </section>

            <section class="card">
                <h2>Selected game pool</h2>
                <div id="pool"></div>
                <div id="pool-empty" class="small-text">Add a featured game or filter by sport to build an SGP.</div>
            </section>
        </div>

        <section class="card" style="margin-top:1rem;">
            <h2>SGP results</h2>
            <div id="results" class="results small-text">No SGPs built yet.</div>
        </section>
    </div>

    <script>
        const featuredContainer = document.getElementById("featured-games");
        const featuredEmpty = document.getElementById("featured-empty");
        const sportContainer = document.getElementById("sport-games");
        const sportEmpty = document.getElementById("sport-empty");
        const poolContainer = document.getElementById("pool");
        const poolEmpty = document.getElementById("pool-empty");
        const resultsContainer = document.getElementById("results");
        const statusBar = document.getElementById("status");

        let featuredGames = [];
        let sportGames = [];
        let selectedGames = [];
        const resultsByGame = new Map();

        function formatStartTime(isoString) {
            if (!isoString) return "Start time TBD";
            try {
                const date = new Date(isoString);
                return date.toLocaleString(undefined, {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                    hour: "numeric",
                    minute: "2-digit"
                });
            } catch (e) {
                return isoString;
            }
        }

        function formatOdds(value) {
            if (value === null || value === undefined) return "—";
            return value > 0 ? `+${value}` : `${value}`;
        }

        function clampBoostPercent(value) {
            if (Number.isNaN(value)) return 30;
            return Math.min(100, Math.max(20, value));
        }

        function parseOddsInput(input, fallback) {
            const parsed = Number.parseInt(input.value, 10);
            if (Number.isNaN(parsed)) {
                input.value = fallback;
                return fallback;
            }
            return parsed;
        }

        function setStatus(message) {
            statusBar.textContent = message;
        }

        function createGameCard(game) {
            const card = document.createElement("div");
            card.className = "game-card";
            card.innerHTML = `
                <div class="pill">${game.sport_key}</div>
                <h3>${game.matchup}</h3>
                <div class="muted">${formatStartTime(game.commence_time)}</div>
                <div class="tag-list">${(game.available_markets || []).map(m => `<span class="pill">${m}</span>`).join("")}</div>
            `;
            card.addEventListener("click", () => addGameToPool(game));
            return card;
        }

        function renderFeaturedGames() {
            featuredContainer.innerHTML = "";
            featuredEmpty.style.display = featuredGames.length ? "none" : "block";
            featuredGames.forEach((game) => {
                featuredContainer.appendChild(createGameCard(game));
            });
        }

        function renderSportGames() {
            sportContainer.innerHTML = "";
            sportEmpty.style.display = sportGames.length ? "none" : "block";
            sportGames.forEach((game) => {
                sportContainer.appendChild(createGameCard(game));
            });
        }

        function renderPool() {
            poolContainer.innerHTML = "";
            poolEmpty.style.display = selectedGames.length ? "none" : "block";
            selectedGames.forEach((game) => {
                const row = document.createElement("div");
                row.className = "pool-item";
                row.innerHTML = `
                    <div>
                        <div><strong>${game.matchup}</strong></div>
                        <div class="small-text">${game.sport_key} • ${formatStartTime(game.commence_time)}</div>
                    </div>
                `;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "Remove";
                removeBtn.className = "btn-secondary";
                removeBtn.addEventListener("click", () => removeFromPool(game.event_id));
                row.appendChild(removeBtn);
                poolContainer.appendChild(row);
            });
        }

        function addGameToPool(game) {
            if (!game || !game.event_id) return;
            if (selectedGames.some(g => g.event_id === game.event_id)) {
                setStatus(`${game.matchup} is already in your pool.`);
                return;
            }
            selectedGames.push(game);
            renderPool();
            setStatus(`Added ${game.matchup} to the SGP pool.`);
        }

        function removeFromPool(eventId) {
            selectedGames = selectedGames.filter(g => g.event_id !== eventId);
            renderPool();
            setStatus("Updated game pool.");
        }

        function describeSgp(label, sgp) {
            if (!sgp) return "";
            let html = `<div style="margin-top: 0.35rem;"><strong>${label}</strong> (${sgp.legs.length} legs) — ${sgp.matchup}`;
            if (sgp.start_time) {
                html += ` • ${formatStartTime(sgp.start_time)}`;
            }
            html += '</div><ol>';
            sgp.legs.forEach((leg) => {
                const hedgeText = (leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined)
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom:0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOdds(leg.book_price)})</div>
                    <div class="small-text">${leg.market || ''} • Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';
            const baseOdds = (sgp.combined_american_odds !== null && sgp.combined_american_odds !== undefined)
                ? formatOdds(sgp.combined_american_odds)
                : '—';
            const baseDecimal = sgp.combined_decimal_odds ? `${sgp.combined_decimal_odds.toFixed(2)}x` : '—';
            const boostedOdds = (sgp.boosted_american_odds !== null && sgp.boosted_american_odds !== undefined)
                ? formatOdds(sgp.boosted_american_odds)
                : '—';
            const boostedDecimal = sgp.boosted_decimal_odds ? `${sgp.boosted_decimal_odds.toFixed(2)}x` : '—';
            html += `<div class="small-text">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div class="small-text">Boosted (${sgp.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;
            if (sgp.note) {
                html += `<div class="small-text" style="color: var(--warning);">${sgp.note}</div>`;
            }
            return html;
        }

        function renderResultCard(game, data) {
            const card = document.createElement("div");
            card.className = "result-card";
            const header = document.createElement("div");
            header.innerHTML = `<strong>${game.matchup}</strong> • ${formatStartTime(game.commence_time)} • ${game.sport_key}`;
            card.appendChild(header);

            if (!data || (!data.best_sgp && !data.uncorrelated_sgp)) {
                const warning = (data && data.warnings && data.warnings.join(" ")) || "No SGP recommendations found.";
                card.innerHTML += `<div class="small-text error-text" style="margin-top:0.35rem;">${warning}</div>`;
                return card;
            }

            if (data.best_sgp) {
                card.innerHTML += describeSgp("Top SGP", data.best_sgp);
            }
            if (data.uncorrelated_sgp) {
                card.innerHTML += describeSgp("Uncorrelated SGP", data.uncorrelated_sgp);
            }
            if (data.warnings && data.warnings.length) {
                card.innerHTML += `<div class="small-text" style="margin-top:0.35rem; color: var(--warning);">${data.warnings.join(" ")}</div>`;
            }
            return card;
        }

        function renderResults() {
            resultsContainer.innerHTML = "";
            if (!resultsByGame.size) {
                resultsContainer.textContent = "No SGPs built yet.";
                return;
            }

            for (const [eventId, payload] of resultsByGame.entries()) {
                const game = selectedGames.find(g => g.event_id === eventId);
                if (!game) continue;
                resultsContainer.appendChild(renderResultCard(game, payload));
            }
        }

        async function loadSports() {
            try {
                const res = await fetch("/api/sports");
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                const select = document.getElementById("sport-select");
                select.innerHTML = "";
                data.forEach((sport) => {
                    const option = document.createElement("option");
                    option.value = sport.key;
                    option.textContent = sport.title || sport.key;
                    select.appendChild(option);
                });
                sportEmpty.style.display = "block";
            } catch (err) {
                console.error(err);
                sportEmpty.textContent = "Unable to load sports right now.";
                sportEmpty.style.display = "block";
            }
        }

        async function loadFeaturedGames() {
            featuredContainer.innerHTML = "";
            featuredEmpty.style.display = "none";
            try {
                const useDummy = document.getElementById("use-dummy").checked;
                const res = await fetch(`/api/featured-games?use_dummy_data=${useDummy}`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                featuredGames = data.games || [];
                renderFeaturedGames();
                setStatus("Featured games updated.");
            } catch (err) {
                console.error(err);
                featuredGames = [];
                renderFeaturedGames();
                setStatus(`Failed to load featured games: ${err.message}`);
            }
        }

        async function loadSportGames() {
            const sportKey = document.getElementById("sport-select").value;
            const useDummy = document.getElementById("use-dummy").checked;
            if (!sportKey) {
                sportGames = [];
                renderSportGames();
                return;
            }
            setStatus(`Fetching games for ${sportKey}...`);
            try {
                const res = await fetch("/api/player-props/games", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sport_key: sportKey, use_dummy_data: useDummy })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                sportGames = (data.games || []).map(game => ({
                    ...game,
                    sport_key: sportKey,
                    available_markets: []
                }));
                renderSportGames();
                setStatus(`Loaded ${sportGames.length} game(s) for ${sportKey}.`);
            } catch (err) {
                console.error(err);
                sportGames = [];
                renderSportGames();
                setStatus(`Failed to load games: ${err.message}`);
            }
        }

        async function buildSgps() {
            if (!selectedGames.length) {
                setStatus("Add at least one game to build an SGP.");
                return;
            }

            const targetBook = document.getElementById("target-book").value;
            const compareBook = document.getElementById("compare-book").value;
            const boostInput = document.getElementById("boost-input");
            const avoidCorrelation = document.getElementById("avoid-correlation").checked;
            const minOddsInput = document.getElementById("min-odds");
            const maxOddsInput = document.getElementById("max-odds");
            const useDummy = document.getElementById("use-dummy").checked;

            if (targetBook === compareBook) {
                setStatus("Target book and comparison book must be different.");
                return;
            }

            const boostPercent = clampBoostPercent(parseFloat(boostInput.value));
            boostInput.value = boostPercent;
            const minOdds = parseOddsInput(minOddsInput, 100);
            const maxOdds = parseOddsInput(maxOddsInput, 20000);

            resultsByGame.clear();
            renderResults();
            setStatus("Building SGPs from your pool...");

            for (const game of selectedGames) {
                try {
                    setStatus(`Building for ${game.matchup}...`);
                    const res = await fetch("/api/sgp-builder", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            sport_key: game.sport_key,
                            event_id: game.event_id,
                            target_book: targetBook,
                            compare_book: compareBook,
                            boost_percent: boostPercent,
                            use_dummy_data: useDummy,
                            avoid_correlation: avoidCorrelation,
                            min_total_american_odds: minOdds,
                            max_total_american_odds: maxOdds,
                        })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    resultsByGame.set(game.event_id, data);
                    renderResults();
                } catch (err) {
                    console.error(err);
                    resultsByGame.set(game.event_id, {
                        warnings: [err.message || "Failed to build SGP"]
                    });
                    renderResults();
                }
            }

            setStatus("Finished building SGPs for your pool.");
        }

        document.getElementById("load-sport").addEventListener("click", loadSportGames);
        document.getElementById("build-btn").addEventListener("click", buildSgps);
        document.getElementById("use-dummy").addEventListener("change", () => {
            loadFeaturedGames();
            if (document.getElementById("sport-select").value) {
                loadSportGames();
            }
        });

        loadSports();
        loadFeaturedGames();
    </script>
</body>

</html>
