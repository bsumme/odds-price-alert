<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>BensSportsBookApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script>
        // Mobile device detection and redirect
        (function () {
            function isMobileDevice() {
                // Check user agent
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;

                // Check screen width (mobile if less than 768px)
                const isSmallScreen = window.innerWidth < 768;

                // Check touch capability
                const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                // Redirect if mobile device detected and not already on mobile page
                if ((mobileRegex.test(userAgent.toLowerCase()) || (isSmallScreen && hasTouchScreen))
                    && !window.location.pathname.includes('-mobile.html')) {
                    // Preserve query string and hash if present
                    const newUrl = '/ArbritrageBetFinder-mobile.html' + window.location.search + window.location.hash;
                    window.location.replace(newUrl);
                }
            }

            // Run detection immediately
            isMobileDevice();
        })();
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.fade-out {
            opacity: 0;
        }

        body.fade-in {
            opacity: 1;
        }

        header {
            padding: 1rem 1.25rem;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        header .small-text {
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        header nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        header nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 0.35rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid transparent;
        }

        header nav a:hover {
            color: #e5e7eb;
            border-color: #1f2937;
            background: #111827;
        }

        header nav a.active {
            color: #bbf7d0;
            font-weight: 600;
            border-color: #166534;
            background: #0b1220;
        }

        .toggle-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
            transition: bottom 0.2s;
        }

        .toggle-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }


        main {
            padding: 4.5rem 0.75rem 0.75rem 0.75rem;
            height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0.75rem;
            align-items: start;
            overflow: hidden;
            padding-right: 0.75rem;
            box-sizing: border-box;
            transition: padding-right 0.3s ease;
        }

        /* Adjust main layout when watcher panel is open */
        body.watcher-open main {
            padding-right: 320px;
            /* 300px panel + 20px gap */
        }

        .filter-panel {
            padding-top: 0;
        }

        @media (max-width: 1600px) {
            main {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 1400px) {
            main {
                grid-template-columns: 260px 1fr;
            }
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            padding: 0.6rem 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .filter-card-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        .filter-actions {
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.6) 0%, #1e293b 40%);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            border-top: 1px solid #334155;
        }

        .card h2 {
            margin-top: 0;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        .card h3 {
            margin-top: 0;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            margin-bottom: 0.1rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        select,
        input[type="number"],
        input[type="tel"] {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border-radius: 0.4rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.8rem;
        }

        select:hover,
        input[type="number"]:hover {
            border-color: #64748b;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.2);
        }

        input[type="checkbox"] {
            margin-right: 0.35rem;
        }

        .btn {
            border: none;
            border-radius: 0.4rem;
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.4rem;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #475569;
            color: #e5e7eb;
        }

        .btn-link:hover {
            background: #334155;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status-bar {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 0.4rem;
        }

        .log-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.4rem;
            padding: 0.5rem;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #cbd5e1;
            max-height: 180px;
            overflow: auto;
            white-space: pre-wrap;
        }

        table {
            width: 100%;
            min-width: 800px;
            /* Ensure table doesn't get too narrow */
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th,
        td {
            border-bottom: 1px solid #334155;
            padding: 0.3rem 0.4rem;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
        }

        /* Column width adjustments - use min-width for critical columns */
        th:nth-child(1),
        td:nth-child(1) {
            width: auto;
            min-width: 60px;
            /* Sport */
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: auto;
            min-width: 160px;
            max-width: 220px;
            /* Recommended Bet - shortened */
            white-space: normal;
            /* Allow wrapping for this column */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: auto;
            min-width: 160px;
            /* Hedge Bet */
            white-space: normal;
            /* Allow wrapping */
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: auto;
            min-width: 130px;
            /* Arbitrage Margin - ensure it's always visible */
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: auto;
            min-width: 120px;
            /* Start Time */
        }

        th {
            background: #1e293b;
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.7rem;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
        }

        /* Custom scrollbar styling */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .small-text {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .odds-highlight {
            font-weight: 800;
        }

        .odds-hedge-neutral {
            color: #cbd5e1;
        }

        .odds-hedge-light-green {
            color: #4ade80;
        }

        .odds-hedge-dark-green {
            color: #166534;
        }

        .odds-hedge-light-red {
            color: #f87171;
        }

        .odds-hedge-dark-red {
            color: #7f1d1d;
        }

        .bet-cell {
            min-width: 220px;
        }

        .bet-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bet-text {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-positive {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-negative {
            background: #7f1d1d;
            color: #fecaca;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .bet-list {
            font-size: 0.75rem;
        }

        .bet-item {
            padding: 0.25rem 0;
            border-bottom: 1px dashed #334155;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 0.4rem;
            display: inline-block;
            object-fit: contain;
        }

        .team-name-with-logo {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toggle-on {
            background: #166534;
            color: #bbf7d0;
            border-color: #15803d;
        }

        .filter-panel {
            height: 100%;
            overflow: hidden;
        }

        .results-panel {
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-toggle-btn {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1002;
            background: #1e293b;
            border: 1px solid #334155;
            border-right: none;
            border-radius: 0.4rem 0 0 0.4rem;
            color: #e5e7eb;
            padding: 1rem 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .panel-toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .panel-toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .panel-toggle-btn .arrow {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .panel-toggle-btn.active .arrow {
            transform: rotate(180deg);
        }

        /* Slide-out panel animation */
        .watcher-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: transparent;
            transition: right 0.3s ease;
            z-index: 1001;
            overflow: hidden;
            padding: 0.75rem;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .watcher-panel.open {
            right: 0;
        }


        .watcher-panel .card {
            margin: 0;
            height: 100%;
            max-height: 100%;
        }

        .credits-display {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .credits-display .credits-low {
            color: #fecaca;
        }

        .credits-display .credits-medium {
            color: #fde68a;
        }

        .credits-display .credits-high {
            color: #bbf7d0;
        }

        footer {
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Adjust main padding to account for footer */
        main {
            padding-bottom: 3rem;
        }
    </style>
</head>

<body>
    <button class="panel-toggle-btn" id="toggle-watcher-btn" title="Toggle Arb Watcher Panel">
        <span class="arrow">â—€</span>
    </button>
    <header id="main-header">
        <div>
            <h1>BensSportsBookApp</h1>
            <div class="small-text">Compare sportsbook odds and uncover risk-free opportunities.</div>
        </div>
        <nav>
            <a href="/BensSportsBookApp.html" class="active">Arbitrage Finder</a>
            <a href="/watcher.html">Watcher</a>
            <a href="/linetracker.html">Line Tracker</a>
            <a href="/value.html">Value Finder</a>
            <a href="/playerprops.html">Player Props</a>
            <a href="/widgets.html">Widgets</a>
            <a href="/settings.html">Settings</a>
        </nav>
    </header>

    <main>
        <!-- Filter Panel -->
        <div class="filter-panel">
            <section class="card">
                <div class="filter-card-content">
                    <h2>Arbitrage Bet Finder</h2>
                    <div class="small-text" style="margin-bottom: 0.75rem;">
                        Discover arbitrage opportunities across multiple sports and markets by comparing odds between
                        sportsbooks
                    </div>

                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label>Select Sports</label>
                        <button id="toggle-all-sports-btn"
                            style="padding: 0.3rem 0.6rem; font-size: 0.85rem; cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">Show
                            All Sports</button>
                    </div>
                    <div id="sports-container" style="margin-bottom: 0.5rem;">
                        <!-- Sports checkboxes will be populated from /api/sports -->
                    </div>

                    <label>Select Markets</label>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="h2h" checked />
                            <span style="margin-left: 0.5rem;">Moneyline</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="spreads" checked />
                            <span style="margin-left: 0.5rem;">Spreads</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="totals" checked />
                            <span style="margin-left: 0.5rem;">Totals</span>
                        </label>
                    </div>

                    <label for="best-target-book-select">Target book</label>
                    <select id="best-target-book-select">
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                        <option value="novig">Novig</option>
                    </select>

                    <label for="best-compare-book-select">Compare against</label>
                    <select id="best-compare-book-select">
                        <option value="novig" selected>Novig</option>
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                    </select>

                    <label for="best-max-results-input" style="display: none;">Max results</label>
                    <input id="best-max-results-input" type="number" min="10" max="200" step="10" value="10"
                        style="display: none;" />

                    <label
                        style="display: none; align-items: center; margin-top: 0.75rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                        <input type="checkbox" id="dummy-data-checkbox" style="margin-right: 0.5rem;" />
                        <span>Use Dummy Data (for development when API credits are exhausted)</span>
                    </label>

                    <label
                        style="display: none; align-items: center; margin-top: 0.5rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                        <input type="checkbox" id="log-results-checkbox" style="margin-right: 0.5rem;" />
                        <span>Save search results as JSON</span>
                    </label>

                    <label for="promo-boost-input" style="margin-top: 0.5rem;">Promo boost % (20-100, default 30)</label>
                    <input id="promo-boost-input" type="number" min="20" max="100" step="5" value="30" />

                    <!-- Parlay Calculator -->
                    <div
                        style="margin-top: 1rem; padding: 0.75rem; background: #1a2332; border: 1px solid #2d3d4f; border-radius: 4px;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #e2e8f0;">Parlay Calculator</h3>
                        <div id="parlay-legs-container" style="margin-bottom: 0.5rem;">
                            <div class="parlay-leg" style="margin-bottom: 0.3rem;">
                                <input type="number" class="parlay-odds-input" placeholder="Odds (e.g., -110, +200)"
                                    step="any"
                                    style="width: 100%; padding: 0.3rem; font-size: 0.85rem; background: #0f172a; border: 1px solid #334155; border-radius: 3px; color: #e2e8f0;" />
                            </div>
                        </div>
                        <button id="add-parlay-leg-btn"
                            style="width: 100%; padding: 0.3rem; font-size: 0.85rem; background: #334155; color: #e2e8f0; border: 1px solid #475569; border-radius: 3px; cursor: pointer; margin-bottom: 0.3rem;">+
                            Add Leg</button>
                        <button id="remove-parlay-leg-btn"
                            style="width: 100%; padding: 0.3rem; font-size: 0.85rem; background: #334155; color: #e2e8f0; border: 1px solid #475569; border-radius: 3px; cursor: pointer; margin-bottom: 0.5rem;">-
                            Remove Leg</button>
                        <div id="parlay-result"
                            style="padding: 0.4rem; background: #0f172a; border: 1px solid #334155; border-radius: 3px; text-align: center; color: #10b981; font-size: 0.9rem; font-weight: bold;">
                            Parlay Odds: â€”
                        </div>
                    </div>

                    <div class="filter-actions">
                        <div style="margin-top: 0.25rem;">
                            <button class="btn btn-primary" id="find-best-btn">Find Arbitrage Opportunities</button>
                            <button class="btn btn-secondary" id="clear-best-btn">Clear</button>
                        </div>

                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" id="build-parlay-btn">Build Best Parlay</button>
                            <a class="btn btn-secondary" href="/sgp-builder.html" style="text-align: center; text-decoration: none;">Open SGP Builder</a>
                        </div>

                        <div class="small-text" style="margin-top: 0.5rem;">
                            Same-game parlays now live in a dedicated page with logos and featured matchups.
                        </div>

                        <div class="status-bar" id="best-status-bar">Ready.</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Results Panel -->
        <div class="results-panel">
            <section class="card" id="best-results-section" style="display: none;">
                <h2>Arbitrage Opportunities</h2>
                <div class="small-text" id="best-summary-bar" style="margin-bottom: 0.4rem;"></div>
                <div class="scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Sport</th>
                                <th>Recommended Bet</th>
                                <th>Hedge Bet</th>
                                <th>Arbitrage Margin</th>
                                <th>Start Time</th>
                            </tr>
                        </thead>
                        <tbody id="best-results-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="card" id="builder-results-section">
                <h2>Parlay Builder</h2>
                <div class="small-text" id="builder-status-bar" style="margin-bottom: 0.4rem;">Ready.</div>
                <div id="parlay-builder-output" class="small-text" style="margin-bottom: 0.75rem;">Use the builder buttons to generate high-value parlays based on hedge EV.</div>
                <div class="small-text">
                    Looking for same-game parlays? Head to the <a href="/sgp-builder.html">dedicated SGP page</a> for featured matchups and logos.
                </div>
            </section>

        </div>

        <!-- Arb Watcher Panel -->
        <div class="watcher-panel" id="watcher-panel">
            <section class="card" id="watcher-card">
                <h2>ðŸ”” Hedge Watcher</h2>
                <div class="small-text" style="margin-bottom: 0.5rem;">
                    Monitor for hedge opportunities (arbitrage margin â‰¥ 0%).
                </div>

                <label for="watcher-interval-input">Check interval (seconds)</label>
                <input id="watcher-interval-input" type="number" min="30" max="300" step="10" value="60" />

                <label for="sms-phone-input" style="margin-top: 0.5rem;">SMS Phone (optional)</label>
                <input id="sms-phone-input" type="tel" placeholder="5551234567" />

                <label for="sms-threshold-input" style="margin-top: 0.5rem;">Min arbitrage margin for SMS (%)</label>
                <input id="sms-threshold-input" type="number" step="0.1" value="0" />
                <div class="small-text">Only send text alerts when arbitrage margin meets or exceeds this value.</div>

                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-primary" id="start-watcher-btn">Start Watcher</button>
                    <button class="btn btn-secondary" id="stop-watcher-btn" disabled>Stop</button>
                </div>

                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-secondary" id="test-sms-btn">Test SMS Alert</button>
                </div>

                <div class="status-bar" id="watcher-status-bar" style="margin-top: 0.4rem;">Watcher stopped.</div>
                <div class="status-bar" id="test-sms-status" style="margin-top: 0.4rem; display: none;"></div>

                <hr style="border: 1px solid #334155; margin: 0.75rem 0;">
                <div class="small-text" style="margin-bottom: 0.5rem;">
                    Start the Python hedge watcher directly from this panel. Headless mode keeps it hidden;
                    the detached subprocess option launches the CLI without blocking the web app.
                </div>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 0.35rem;">
                        <input type="radio" name="server-watcher-mode" value="headless" checked>
                        <span>Headless background</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.35rem;">
                        <input type="radio" name="server-watcher-mode" value="subprocess">
                        <span>Detached subprocess</span>
                    </label>
                </div>

                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-primary" id="start-server-watcher-btn">Start Python Watcher</button>
                    <button class="btn btn-secondary" id="stop-server-watcher-btn" disabled>Stop Python Watcher</button>
                </div>

                <div class="status-bar" id="server-watcher-status" style="margin-top: 0.4rem;">Server watcher not
                    running.</div>
                <div class="log-box" id="server-watcher-log" aria-live="polite" style="margin-top: 0.35rem;">No watcher
                    logs yet.</div>
                <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
                    <label style="display:flex; align-items:center; gap:0.35rem;">
                        <input type="checkbox" id="auto-poll-server-watcher-checkbox">
                        <span>Auto-poll server watcher status</span>
                    </label>
                </div>
                <div class="log-box" id="client-log" aria-live="polite"
                    style="margin-top: 0.35rem; max-height:10rem; overflow:auto;">Client log initialized.</div>
            </section>
        </div>
    </main>

    <!-- Credits Display -->
    <footer
        style="position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; padding: 0.5rem 1rem; z-index: 1000; text-align: center;">
        <div class="credits-display">
            <span id="api-credits">API: Loading...</span>
        </div>
    </footer>

    <script>
        let valuePollTimer = null;
        let lastValueData = null;
        let filterHedgeOnly = false;
        let watcherTimer = null;
        let lastBestValueData = null;
        let alertedPlayIds = new Set(); // Track plays we've already alerted on
        let smsAlertedPlayIds = new Set(); // Track plays that have triggered an SMS

        // Client-side network/log helper
        function appendClientLog(msg) {
            try {
                const el = document.getElementById('client-log');
                const ts = new Date().toLocaleTimeString();
                el.textContent = `${ts} - ${msg}\n` + el.textContent;
            } catch (e) {
                // ignore
            }
            console.log('[client-log]', msg);
        }

        async function loggedFetch(url, options = {}, tag = '') {
            const method = (options.method || 'GET').toUpperCase();
            const safeBody = options.body ? (typeof options.body === 'string' ? options.body.slice(0, 200) : JSON.stringify(options.body).slice(0, 200)) : '';
            appendClientLog(`${tag} -> ${method} ${url} ${safeBody ? '| body=' + safeBody : ''}`);
            let res;
            try {
                res = await fetch(url, options);
            } catch (err) {
                appendClientLog(`${tag} <= ERROR ${err.message || err}`);
                throw err;
            }
            appendClientLog(`${tag} <= ${res.status} ${res.statusText}`);
            return res;
        }

        function formatStartTime(isoString) {
            if (!isoString) return "";

            const trimmed = String(isoString).trim();
            if (!trimmed) return "";

            const date = new Date(trimmed);
            if (Number.isNaN(date.getTime())) {
                return trimmed;
            }

            const options = {
                timeZone: "America/New_York",
                month: "short",
                day: "numeric",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            };
            return date.toLocaleString("en-US", options) + " ET";
        }

        function formatMarketLabel(marketKey) {
            const mapping = {
                h2h: "ML",
                spreads: "Spreads",
                totals: "Totals"
            };
            return mapping[marketKey] || marketKey.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        }

        function formatSportLabel(sportKey) {
            const mapping = {
                basketball_nba: "NBA",
                americanfootball_nfl: "NFL",
                icehockey_nhl: "NHL",
                basketball_ncaab: "NCAAB",
                americanfootball_ncaaf: "NCAAF"
                , mma_mixed_martial_arts: "UFC / MMA"
            };
            return mapping[sportKey] || sportKey.toUpperCase();
        }

        // Fetch sports schema from server and render checkboxes
        let showAllSportsMode = false;

        async function fetchAndRenderSports(showAll = false) {
            try {
                const res = await loggedFetch('/api/sports', {}, 'sports');
                if (!res.ok) {
                    appendClientLog('sports <= failed to load schema');
                    return;
                }
                const list = await res.json();
                const container = document.getElementById('sports-container');
                if (!container) return;
                container.innerHTML = '';
                for (const s of list) {
                    if (!s || !s.key) continue;
                    if (!showAll && !s.active) continue; // only show active sports by default
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.marginTop = '0.3rem';

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'sport-checkbox';
                    input.value = s.key;
                    input.checked = showAll ? false : true; // uncheck all when showing all sports
                    input.style.marginRight = '0.4rem';

                    const span = document.createElement('span');
                    span.style.marginLeft = '0.5rem';
                    span.textContent = s.title || s.key;

                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                }
                appendClientLog('Loaded sports schema and rendered checkboxes');
            } catch (err) {
                appendClientLog('Failed to load sports schema: ' + (err.message || err));
            }
        }

        function formatBookLabel(bookKey) {
            const mapping = {
                draftkings: "DraftKings",
                fanduel: "FanDuel",
                fliff: "Fliff",
                novig: "Novig"
            };
            return mapping[bookKey] || bookKey;
        }

        function convertOddsToDecimal(odds) {
            if (typeof odds !== 'number') return null;
            if (odds === 0) return null;
            if (odds > 0) {
                return 1 + odds / 100;
            } else {
                return 1 + 100 / Math.abs(odds);
            }
        }

        function convertDecimalToAmericanOdds(decimal) {
            if (decimal <= 1) return null;
            if (decimal === 1.5) return 0;
            if (decimal > 2) {
                return Math.round((decimal - 1) * 100);
            } else {
                return Math.round(-100 / (decimal - 1));
            }
        }

        function updateParlayCalculator() {
            const inputs = document.querySelectorAll('.parlay-odds-input');
            let totalDecimalOdds = 1;
            let validLegs = 0;

            for (const input of inputs) {
                const value = parseFloat(input.value);
                if (!isNaN(value) && value !== 0) {
                    const decimal = convertOddsToDecimal(value);
                    if (decimal && decimal > 0) {
                        totalDecimalOdds *= decimal;
                        validLegs++;
                    }
                }
            }

            const resultDiv = document.getElementById('parlay-result');
            if (validLegs < 2) {
                resultDiv.textContent = 'Parlay Odds: â€” (need at least 2 legs)';
            } else {
                const americanOdds = convertDecimalToAmericanOdds(totalDecimalOdds);
                resultDiv.textContent = `Parlay Odds: ${americanOdds > 0 ? '+' : ''}${americanOdds} (${totalDecimalOdds.toFixed(2)}x)`;
            }
        }

        function addParlayLeg() {
            const container = document.getElementById('parlay-legs-container');
            const newLeg = document.createElement('div');
            newLeg.className = 'parlay-leg';
            newLeg.style.marginBottom = '0.3rem';
            newLeg.innerHTML = '<input type="number" class="parlay-odds-input" placeholder="Odds (e.g., -110, +200)" step="any" style="width: 100%; padding: 0.3rem; font-size: 0.85rem; background: #0f172a; border: 1px solid #334155; border-radius: 3px; color: #e2e8f0;" />';
            container.appendChild(newLeg);
            newLeg.querySelector('.parlay-odds-input').addEventListener('input', updateParlayCalculator);
            updateParlayCalculator();
        }

        function removeParlayLeg() {
            const container = document.getElementById('parlay-legs-container');
            const legs = container.querySelectorAll('.parlay-leg');
            if (legs.length > 1) {
                legs[legs.length - 1].remove();
                updateParlayCalculator();
            }
        }

        function getPromoBoostPercent() {
            const boostInput = document.getElementById('promo-boost-input');
            if (!boostInput) return 30;
            const raw = Number(boostInput.value);
            if (Number.isNaN(raw)) return 30;
            return Math.min(100, Math.max(20, raw));
        }

        function setBuilderStatus(message) {
            const bar = document.getElementById('builder-status-bar');
            if (bar) {
                bar.textContent = message;
            }
        }

        function getSmsMarginThreshold() {
            const thresholdInput = document.getElementById("sms-threshold-input");
            const value = thresholdInput ? Number(thresholdInput.value) : 0;
            return Number.isNaN(value) ? 0 : value;
        }

        function buildLogFilename(markets, sports, targetBook, compareBook) {
            const timestamp = new Date().toISOString().replace(/[:T]/g, "-").split(".")[0];
            const marketPart = (markets.length ? markets.map(formatMarketLabel) : ["AllMarkets"]).join("+");
            const sportPart = (sports.length ? sports.map(formatSportLabel) : ["AllSports"]).join("+");
            const targetLabel = formatBookLabel(targetBook);
            const compareLabel = formatBookLabel(compareBook);

            const sanitize = (value) => value.replace(/[^a-zA-Z0-9+]+/g, "");
            return `${timestamp}_${sanitize(marketPart)}_${sanitize(sportPart)}_${sanitize(targetLabel)}_vs_${sanitize(compareLabel)}.json`;
        }

        function logSearchResultsToFile(data, { sportKeys, markets, targetBook, compareBook, maxResults, useDummyData }) {
            const payload = {
                logged_at: new Date().toISOString(),
                filters: {
                    sports: sportKeys,
                    markets,
                    target_book: targetBook,
                    compare_book: compareBook,
                    max_results: maxResults,
                    use_dummy_data: useDummyData
                },
                results: data
            };

            const filename = buildLogFilename(markets, sportKeys, targetBook, compareBook);
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function getTeamLogoUrl(teamName, sportKey = null) {
            if (!teamName) return null;

            // Team name to ESPN team code mapping
            const teamMapping = {
                // NBA
                "atlanta hawks": "atl",
                "boston celtics": "bos",
                "brooklyn nets": "bkn",
                "charlotte hornets": "cha",
                "chicago bulls": "chi",
                "cleveland cavaliers": "cle",
                "dallas mavericks": "dal",
                "denver nuggets": "den",
                "detroit pistons": "det",
                "golden state warriors": "gs",
                "houston rockets": "hou",
                "indiana pacers": "ind",
                "los angeles clippers": "lac",
                "los angeles lakers": "lal",
                "memphis grizzlies": "mem",
                "miami heat": "mia",
                "milwaukee bucks": "mil",
                "minnesota timberwolves": "min",
                "new orleans pelicans": "no",
                "new york knicks": "ny",
                "oklahoma city thunder": "okc",
                "orlando magic": "orl",
                "philadelphia 76ers": "phi",
                "phoenix suns": "phx",
                "portland trail blazers": "por",
                "sacramento kings": "sac",
                "san antonio spurs": "sa",
                "toronto raptors": "tor",
                "utah jazz": "utah",
                "washington wizards": "wsh",
                // NFL
                "arizona cardinals": "ari",
                "atlanta falcons": "atl",
                "baltimore ravens": "bal",
                "buffalo bills": "buf",
                "carolina panthers": "car",
                "chicago bears": "chi",
                "cincinnati bengals": "cin",
                "cleveland browns": "cle",
                "dallas cowboys": "dal",
                "denver broncos": "den",
                "detroit lions": "det",
                "green bay packers": "gb",
                "houston texans": "hou",
                "indianapolis colts": "ind",
                "jacksonville jaguars": "jax",
                "kansas city chiefs": "kc",
                "las vegas raiders": "lv",
                "los angeles chargers": "lac",
                "los angeles rams": "lar",
                "miami dolphins": "mia",
                "minnesota vikings": "min",
                "new england patriots": "ne",
                "new orleans saints": "no",
                "new york giants": "nyg",
                "new york jets": "nyj",
                "philadelphia eagles": "phi",
                "pittsburgh steelers": "pit",
                "san francisco 49ers": "sf",
                "seattle seahawks": "sea",
                "tampa bay buccaneers": "tb",
                "tennessee titans": "ten",
                "washington commanders": "wsh",
                // NCAAB - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "butler bulldogs": "2086",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "connecticut huskies": "41",
                "creighton bluejays": "154",
                "duke blue devils": "150",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgetown hoyas": "46",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "gonzaga bulldogs": "2250",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "indiana hoosiers": "84",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "marquette golden eagles": "269",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "miami hurricanes": "2390",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "missouri tigers": "142",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "san diego state aztecs": "21",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "syracuse orange": "183",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "villanova wildcats": "222",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275",
                "xavier musketeers": "2752",
                // NCAAF - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "boise state broncos": "68",
                "boston college eagles": "103",
                "byu cougars": "252",
                "california golden bears": "25",
                "central florida knights": "2116",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "miami hurricanes": "2390",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "mississippi rebels": "145",
                "missouri tigers": "142",
                "nebraska cornhuskers": "158",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "tulane green wave": "2655",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "wake forest demon deacons": "154",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275"
            };

            // Normalize team name: lowercase, trim, and remove extra spaces
            const normalized = teamName.toLowerCase().trim().replace(/\s+/g, ' ');
            let teamCode = teamMapping[normalized];

            // If no mapping found, try to extract from common patterns
            if (!teamCode) {
                // First, try exact matches with common short names and variations
                const shortNameMapping = {
                    "kansas": "2305",  // Kansas Jayhawks
                    "kansas jayhawks": "2305",
                    "jayhawks": "2305",
                    "arizona": "12",   // Arizona Wildcats
                    "arizona wildcats": "12",
                    "wildcats": "12",  // Could match multiple, but Arizona is most common
                    "kentucky": "96",   // Kentucky Wildcats
                    "kentucky wildcats": "96",
                    "duke": "150",     // Duke Blue Devils
                    "duke blue devils": "150",
                    "north carolina": "153",  // North Carolina Tar Heels
                    "north carolina tar heels": "153",
                    "tar heels": "153",
                    "ucla": "26",      // UCLA Bruins
                    "ucla bruins": "26",
                    "usc": "30",       // USC Trojans
                    "usc trojans": "30",
                    "texas": "251",    // Texas Longhorns
                    "texas longhorns": "251",
                    "michigan": "130", // Michigan Wolverines
                    "michigan wolverines": "130",
                    "ohio state": "194", // Ohio State Buckeyes
                    "ohio state buckeyes": "194",
                    "alabama": "333",   // Alabama Crimson Tide
                    "alabama crimson tide": "333",
                    "georgia": "61",    // Georgia Bulldogs
                    "georgia bulldogs": "61",
                    "lsu": "99",       // LSU Tigers
                    "lsu tigers": "99",
                    "florida": "57",    // Florida Gators
                    "florida gators": "57",
                    "tennessee": "2633", // Tennessee Volunteers
                    "tennessee volunteers": "2633",
                    "oklahoma": "201",  // Oklahoma Sooners
                    "oklahoma sooners": "201",
                    "oregon": "2483",   // Oregon Ducks
                    "oregon ducks": "2483",
                    "wisconsin": "275", // Wisconsin Badgers
                    "wisconsin badgers": "275",
                    "penn state": "213", // Penn State Nittany Lions
                    "penn state nittany lions": "213",
                    "notre dame": "87"  // Notre Dame Fighting Irish
                };

                // Check short name mapping
                for (const [shortName, code] of Object.entries(shortNameMapping)) {
                    if (normalized === shortName || normalized.startsWith(shortName + " ") || normalized.endsWith(" " + shortName)) {
                        teamCode = code;
                        break;
                    }
                }

                // If still not found, try to match partial names (improved logic)
                if (!teamCode) {
                    // Extract first significant word (skip common words like "the", "at", etc.)
                    const words = normalized.split(/\s+/);
                    const firstWord = words.length > 0 ? words[0] : normalized;
                    const secondWord = words.length > 1 ? words[1] : null;

                    for (const [key, code] of Object.entries(teamMapping)) {
                        // Check if normalized name is contained in key or vice versa
                        // Also check if key starts with normalized (e.g., "kansas" matches "kansas jayhawks")
                        if (normalized === key ||
                            key.startsWith(normalized + " ") ||
                            normalized.startsWith(key + " ") ||
                            key.startsWith(firstWord + " ") ||
                            (normalized.length >= 3 && key.includes(normalized)) ||
                            (key.length >= 3 && normalized.includes(key))) {
                            teamCode = code;
                            break;
                        }
                    }
                }
            }

            // Determine sport for ESPN URL
            let sportPath = "nba";
            if (sportKey) {
                if (sportKey.includes("ncaaf") || sportKey.includes("ncaab")) {
                    sportPath = "ncaa";
                } else if (sportKey.includes("football") || sportKey.includes("nfl")) {
                    sportPath = "nfl";
                } else if (sportKey.includes("hockey")) {
                    sportPath = "nhl";
                } else if (sportKey.includes("basketball") || sportKey.includes("nba")) {
                    sportPath = "nba";
                }
            }

            if (teamCode) {
                return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${teamCode}.png`;
            }

            // Fallback: try normalized name
            const fallback = normalized.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${fallback}.png`;
        }


        function formatOdds(odds) {
            /**
             * Format odds in American format.
             * Returns the odds as a string with proper formatting.
             */
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            // American format: Add "+" prefix for positive odds
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        function getOddsHighlightClass(odds) {
            if (odds === null || odds === undefined) return "odds-hedge-neutral";

            const numericOdds = typeof odds === "string" ? parseInt(odds, 10) : Number(odds);
            if (Number.isNaN(numericOdds)) return "odds-hedge-neutral";

            if (numericOdds <= -200) return "odds-hedge-dark-red";
            if (numericOdds < -115) return "odds-hedge-light-red";
            if (numericOdds >= 200) return "odds-hedge-dark-green";
            if (numericOdds > 115) return "odds-hedge-light-green";

            return "odds-hedge-neutral";
        }

        function renderParlayBuilderResults(data) {
            const container = document.getElementById('parlay-builder-output');
            if (!container) return;

            if (!data || !Array.isArray(data.parlay_legs) || data.parlay_legs.length === 0) {
                container.textContent = (data && data.notes && data.notes.join(' ')) || 'No parlay suggestion could be built right now.';
                return;
            }

            let html = `<div><strong>Suggested Parlay (${data.parlay_legs.length} legs)</strong></div>`;
            html += '<ol style="padding-left: 1.2rem; margin: 0.35rem 0;">';
            data.parlay_legs.forEach((leg) => {
                const hedgeText = leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom: 0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOdds(leg.book_price)})</div>
                    <div class="small-text">${leg.matchup || ''} â€¢ ${leg.market || ''} â€¢ Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';

            const baseOdds = (data.combined_american_odds !== null && data.combined_american_odds !== undefined)
                ? formatOdds(data.combined_american_odds)
                : 'â€”';
            const baseDecimal = data.combined_decimal_odds ? `${data.combined_decimal_odds.toFixed(2)}x` : 'â€”';
            const boostedOdds = (data.boosted_american_odds !== null && data.boosted_american_odds !== undefined)
                ? formatOdds(data.boosted_american_odds)
                : 'â€”';
            const boostedDecimal = data.boosted_decimal_odds ? `${data.boosted_decimal_odds.toFixed(2)}x` : 'â€”';

            html += `<div style="margin-top: 0.35rem;">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div>Boosted (${data.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;

            if (data.notes && data.notes.length) {
                html += `<div class="small-text" style="color: #fbbf24; margin-top: 0.25rem;">${data.notes.join(' ')}</div>`;
            }

            container.innerHTML = html;
        }

        function describeSgp(label, sgp) {
            if (!sgp) return '';
            let html = `<div style="margin-top: 0.4rem;"><strong>${label}</strong> (${sgp.legs.length} legs) â€” ${sgp.matchup}`;
            if (sgp.start_time) {
                html += ` â€¢ ${sgp.start_time}`;
            }
            html += '</div><ol style="padding-left: 1.2rem; margin: 0.35rem 0;">';
            sgp.legs.forEach((leg) => {
                const hedgeText = leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom: 0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOdds(leg.book_price)})</div>
                    <div class="small-text">${leg.market || ''} â€¢ Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';
            const baseOdds = (sgp.combined_american_odds !== null && sgp.combined_american_odds !== undefined)
                ? formatOdds(sgp.combined_american_odds)
                : 'â€”';
            const baseDecimal = sgp.combined_decimal_odds ? `${sgp.combined_decimal_odds.toFixed(2)}x` : 'â€”';
            const boostedOdds = (sgp.boosted_american_odds !== null && sgp.boosted_american_odds !== undefined)
                ? formatOdds(sgp.boosted_american_odds)
                : 'â€”';
            const boostedDecimal = sgp.boosted_decimal_odds ? `${sgp.boosted_decimal_odds.toFixed(2)}x` : 'â€”';
            html += `<div class="small-text">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div class="small-text">Boosted (${sgp.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;
            if (sgp.note) {
                html += `<div class="small-text" style="color: #fbbf24;">${sgp.note}</div>`;
            }
            return html;
        }

        // Legacy function for backwards compatibility
        function formatAmericanOdds(odds) {
            return formatOdds(odds);
        }

        function createTeamNameWithLogo(teamName, sportKey = null) {
            if (!teamName) return document.createTextNode("");

            const container = document.createElement("span");
            container.className = "team-name-with-logo";

            const logo = document.createElement("img");
            logo.className = "team-logo";
            logo.src = getTeamLogoUrl(teamName, sportKey);
            logo.alt = teamName;
            logo.onerror = function () {
                // Hide logo if it fails to load
                this.style.display = "none";
            };

            const nameSpan = document.createElement("span");
            nameSpan.textContent = teamName;

            container.appendChild(logo);
            container.appendChild(nameSpan);

            return container;
        }

        function parseTeamFromOutcome(outcomeName) {
            // Extract team name from outcome (might include point spread info)
            // Examples: "New York Knicks", "New York Knicks @ -3.5"
            if (!outcomeName) return null;

            // Remove point spread info (everything after @)
            const parts = outcomeName.split(" @ ");
            return parts[0].trim();
        }

        function parseTeamsFromMatchup(matchup) {
            // Parse "Away Team @ Home Team" format
            if (!matchup) return { away: null, home: null };

            const parts = matchup.split(" @ ");
            if (parts.length === 2) {
                return { away: parts[0].trim(), home: parts[1].trim() };
            }
            return { away: matchup, home: null };
        }


        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setSummary(msg) {
            document.getElementById("summary-bar").textContent = msg;
        }

        function clearResults() {
            const body = document.getElementById("results-body");
            body.innerHTML = '<tr><td colspan="9" class="small-text">No results yet.</td></tr>';
            setSummary("");
            lastValueData = null;
        }

        function renderValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.plays || data.plays.length === 0) {
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || "comparison book";
                body.innerHTML = `<tr><td colspan="9" class="small-text">No arbitrage opportunities found (maybe market is empty or ${compareBookLabel} not available).</td></tr>`;
                return;
            }

            let plays = data.plays;
            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.novig_reverse_name !== null &&
                    p.novig_reverse_name !== undefined &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
            }

            if (plays.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="small-text">No plays match the current hedge filter.</td></tr>';
                return;
            }

            const currentSport = document.getElementById("sport-select").value;
            plays.forEach(play => {
                const tr = document.createElement("tr");

                const outcomeCell = document.createElement("td");
                const teamName = parseTeamFromOutcome(play.outcome_name);
                const teamWithLogo = createTeamNameWithLogo(teamName, play.sport_key || currentSport);
                outcomeCell.appendChild(teamWithLogo);
                if (play.point !== null && play.point !== undefined) {
                    const pointSpan = document.createElement("span");
                    pointSpan.textContent = " @ " + play.point;
                    outcomeCell.appendChild(pointSpan);
                }
                tr.appendChild(outcomeCell);

                const startCell = document.createElement("td");
                startCell.textContent = formatStartTime(play.start_time);
                tr.appendChild(startCell);

                const compareCell = document.createElement("td");
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                const formattedCompareOdds = formatOdds(play.novig_price);
                compareCell.innerHTML = `<strong>${formattedCompareOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                tr.appendChild(compareCell);

                const oppCell = document.createElement("td");
                if (play.novig_reverse_name) {
                    const oppTeamName = parseTeamFromOutcome(play.novig_reverse_name);
                    oppCell.appendChild(createTeamNameWithLogo(oppTeamName, play.sport_key || currentSport));
                } else {
                    oppCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(oppCell);

                const hedgeCell = document.createElement("td");
                if (play.novig_reverse_price !== null && play.novig_reverse_price !== undefined) {
                    const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                    const formattedHedgeOdds = formatOdds(play.novig_reverse_price);
                    hedgeCell.innerHTML = `<strong>${formattedHedgeOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                } else {
                    hedgeCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeCell);

                const bookCell = document.createElement("td");
                const targetBookLabel = document.querySelector("#book-select option:checked")?.textContent || data.target_book || "Target";
                const formattedBookOdds = formatOdds(play.book_price);
                bookCell.innerHTML = `<strong>${formattedBookOdds}</strong><br><span class="small-text">@ ${targetBookLabel}</span>`;
                tr.appendChild(bookCell);

                const hedgeEvCell = document.createElement("td");
                if (play.arb_margin_percent !== null && play.arb_margin_percent !== undefined) {
                    const hedgeRounded = Math.round(play.arb_margin_percent * 100) / 100;
                    const hedgeClass = hedgeRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                    hedgeEvCell.innerHTML = `<span class="${hedgeClass}">${hedgeRounded}%</span>`;
                } else {
                    hedgeEvCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeEvCell);

                const evCell = document.createElement("td");
                const evRounded = Math.round(play.ev_percent * 100) / 100;
                let badgeClass = evRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                evCell.innerHTML = `<span class="${badgeClass}">${evRounded}%</span>`;
                tr.appendChild(evCell);


                body.appendChild(tr);
            });
        }

        function renderValueFromState() {
            if (!lastValueData) return;
            renderValuePlays(lastValueData, filterHedgeOnly);
        }

        async function fetchValuePlays(singleRun = false) {
            const sport = document.getElementById("sport-select").value;
            const market = document.getElementById("market-select").value;
            const book = document.getElementById("book-select").value;
            const compareBook = document.getElementById("compare-book-select").value;
            const maxResults = Number(document.getElementById("max-results-input").value) || 25;

            if (book === compareBook) {
                setStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            if (singleRun) {
                // Don't wipe lastValueData instantly; let new data overwrite.
                setSummary("");
            }
            setStatus("Fetching arbitrage opportunities...");
            try {
                const res = await fetch("/api/value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sport,
                        market,
                        target_book: book,
                        compare_book: compareBook,
                        max_results: maxResults
                    }),
                });
                if (!res.ok) {
                    if (res.status === 404) {
                        const message = "Search was correct, but no markets were found at the moment.";
                        alert(message);
                        setBestStatus(message);
                        return;
                    }

                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastValueData = data;
                renderValueFromState();

                const playsCount = (data.plays || []).length;
                const compareBookLabel = document.querySelector("#compare-book-select option:checked").textContent;
                setSummary(`Showing top ${playsCount} arbitrage opportunities for ${book} in market "${market}" vs ${compareBookLabel}. Filter: ${filterHedgeOnly ? "Hedgeable only" : "All"}.`);
                setStatus("Done.");
            } catch (e) {
                console.error(e);
                setStatus("Error: " + e.message);
            }
        }

        function startValueLoop() {
            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }

            setStatus("Watching for arbitrage opportunities...");
            document.getElementById("start-loop-btn").disabled = true;
            document.getElementById("find-btn").disabled = true;
            document.getElementById("stop-loop-btn").disabled = false;

            // initial fetch
            fetchValuePlays(true);
            valuePollTimer = setInterval(() => fetchValuePlays(false), intervalMs);
        }

        function stopValueLoop() {
            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-loop-btn").disabled = false;
            document.getElementById("find-btn").disabled = false;
            document.getElementById("stop-loop-btn").disabled = true;
        }

        function toggleHedgeFilter() {
            filterHedgeOnly = !filterHedgeOnly;
            const btn = document.getElementById("filter-opp-btn");
            if (filterHedgeOnly) {
                btn.classList.add("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (ON)";
            } else {
                btn.classList.remove("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (OFF)";
            }
            renderValueFromState();
        }

        // Arbitrage Finder Functions
        function setBestStatus(msg) {
            document.getElementById("best-status-bar").textContent = msg;
        }

        function setBestSummary(msg) {
            document.getElementById("best-summary-bar").textContent = msg;
        }

        function clearBestResults() {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            document.getElementById("best-results-section").style.display = "none";
            setBestSummary("");
        }

        function renderBestValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            const section = document.getElementById("best-results-section");
            section.style.display = "block";

            if (!data || !data.plays || data.plays.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="small-text">No arbitrage opportunities found.</td></tr>';
                return;
            }

            let plays = data.plays;

            // Filter for hedge opportunities only (arb_margin_percent >= 0) when watcher is running
            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.arb_margin_percent !== null &&
                    p.arb_margin_percent !== undefined &&
                    p.arb_margin_percent >= 0 &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
                if (plays.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="small-text">No hedge opportunities found (arbitrage margin â‰¥ 0%).</td></tr>';
                    return;
                }
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const marketLabels = {
                "h2h": "Moneyline",
                "spreads": "Spreads",
                "totals": "Totals"
            };

            plays.forEach(play => {
                const tr = document.createElement("tr");

                const sportCell = document.createElement("td");
                sportCell.textContent = sportLabels[play.sport_key] || play.sport_key;
                tr.appendChild(sportCell);

                const recommendedCell = document.createElement("td");
                recommendedCell.className = "bet-cell";
                const hedgeCell = document.createElement("td");
                hedgeCell.className = "bet-cell";
                const targetBookLabel = document.querySelector("#best-target-book-select option:checked")?.textContent || data.target_book || "Target";
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                const betOddsClass = getOddsHighlightClass(play.book_price);
                let teamName = parseTeamFromOutcome(play.outcome_name);
                const marketLabel = marketLabels[play.market] || play.market;
                const formattedOdds = formatOdds(play.book_price);

                // For totals markets, extract team from matchup since outcome is "Over" or "Under"
                let logoTeamName = teamName;
                if (play.market === "totals" && play.matchup) {
                    const teams = parseTeamsFromMatchup(play.matchup);
                    // Use the first team (away team) for the logo
                    logoTeamName = teams.away || teams.home || null;
                }

                const targetRow = document.createElement("div");
                targetRow.className = "bet-row";

                if (logoTeamName) {
                    const logo = document.createElement("img");
                    logo.className = "team-logo";
                    logo.src = getTeamLogoUrl(logoTeamName, play.sport_key || null);
                    logo.alt = logoTeamName;
                    logo.onerror = function () {
                        this.style.display = "none";
                    };
                    targetRow.appendChild(logo);
                }

                const betText = document.createElement("div");
                betText.className = "bet-text";
                let betDescription = "";
                if (play.market === "totals") {
                    betDescription = `${play.outcome_name || "Total"}`;
                    if (play.matchup) {
                        betDescription += ` - ${play.matchup}`;
                    }
                } else {
                    betDescription = `${teamName || ""} ${marketLabel === "Moneyline" ? "ML" : marketLabel === "Spreads" ? "Spread" : marketLabel}`;
                    if (play.point !== null && play.point !== undefined) {
                        betDescription += ` ${play.point > 0 ? "+" : ""}${play.point}`;
                    }
                }
                betText.innerHTML = `<div><strong>${betDescription} <span class="odds-highlight ${betOddsClass}">${formattedOdds}</span></strong></div><div class="small-text">@ ${targetBookLabel}</div>`;
                targetRow.appendChild(betText);

                recommendedCell.appendChild(targetRow);
                tr.appendChild(recommendedCell);

                if (play.novig_reverse_price !== null && play.novig_reverse_price !== undefined && play.novig_reverse_name) {
                    const hedgeRow = document.createElement("div");
                    hedgeRow.className = "bet-row";

                    const formattedHedgeOdds = formatOdds(play.novig_reverse_price);
                    const hedgeOddsClass = getOddsHighlightClass(play.novig_reverse_price);
                    let oppositeTeamName = parseTeamFromOutcome(play.novig_reverse_name);
                    const hedgeMarketLabel = marketLabels[play.market] || play.market;

                    let hedgeDescription = "";
                    if (play.market === "totals") {
                        hedgeDescription = play.novig_reverse_name;
                    } else if (play.market === "spreads") {
                        hedgeDescription = `${oppositeTeamName || ""} ${hedgeMarketLabel === "Spreads" ? "Spread" : hedgeMarketLabel}`;
                        if (play.point !== null && play.point !== undefined) {
                            const oppositePoint = -play.point;
                            hedgeDescription += ` ${oppositePoint > 0 ? "+" : ""}${oppositePoint}`;
                        }
                    } else {
                        hedgeDescription = `${oppositeTeamName || ""} ML`;
                    }

                    const hedgeText = document.createElement("div");
                    hedgeText.className = "bet-text";
                    hedgeText.innerHTML = `<div><strong>${hedgeDescription} <span class="odds-highlight ${hedgeOddsClass}">${formattedHedgeOdds}</span></strong></div><div class="small-text">@ ${compareBookLabel}</div>`;

                    hedgeRow.appendChild(hedgeText);
                    hedgeCell.appendChild(hedgeRow);
                } else {
                    hedgeCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeCell);

                const hedgeEvCell = document.createElement("td");
                if (play.arb_margin_percent !== null && play.arb_margin_percent !== undefined) {
                    const hedgeRounded = Math.round(play.arb_margin_percent * 100) / 100;
                    const hedgeClass = hedgeRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                    hedgeEvCell.innerHTML = `<span class="${hedgeClass}">${hedgeRounded}%</span>`;
                } else {
                    hedgeEvCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeEvCell);

                const startCell = document.createElement("td");
                startCell.textContent = formatStartTime(play.start_time);
                tr.appendChild(startCell);

                body.appendChild(tr);
            });
        }

        // Request browser notification permission
        async function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                await Notification.requestPermission();
            }
        }

        // Show browser notification for hedge opportunities
        function showHedgeAlert(play) {
            if (!("Notification" in window)) {
                console.log("Browser does not support notifications");
                return;
            }

            if (Notification.permission !== "granted") {
                return;
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            const notification = new Notification(`Hedge Opportunity Found! (${margin}%)`, {
                body: `${sportLabel}: ${teamName} ${bookOdds} vs Hedge ${hedgeOdds}\n${play.matchup || ""}`,
                icon: getTeamLogoUrl(teamName, play.sport_key) || undefined,
                tag: `hedge-${play.event_id}-${play.outcome_name}`, // Prevent duplicate notifications
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }

        // Generate unique ID for a play to track alerts
        function getPlayId(play) {
            return `${play.event_id}-${play.outcome_name}-${play.book_price}-${play.novig_reverse_price}`;
        }

        // Send SMS alert
        async function sendSMSAlert(play) {
            const phoneInput = document.getElementById("sms-phone-input");
            const phone = phoneInput ? phoneInput.value.trim() : "";

            if (!phone) {
                return; // No phone number configured, skip SMS
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            // Format message (SMS has 160 char limit, so keep it concise)
            const message = `Hedge Alert! ${sportLabel}: ${teamName} ${bookOdds} vs ${hedgeOdds} (${margin}% margin). ${play.matchup || ""}`;

            try {
                const response = await fetch("/api/send-sms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone: phone,
                        message: message
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("SMS send failed:", error.detail || "Unknown error");
                } else {
                    const result = await response.json();
                    console.log("SMS sent successfully. Quota remaining:", result.quotaRemaining);
                }
            } catch (error) {
                console.error("Error sending SMS:", error);
            }
        }

        // Check for new hedge opportunities and alert
        function checkForHedgeAlerts(plays) {
            if (!plays || plays.length === 0) return;

            plays.forEach(play => {
                const marginPercent = play.arb_margin_percent;
                // Only alert for plays with arbitrage margin >= 0
                if (marginPercent !== null &&
                    marginPercent !== undefined &&
                    marginPercent >= 0 &&
                    play.novig_reverse_price !== null &&
                    play.novig_reverse_price !== undefined) {

                    const playId = getPlayId(play);
                    const meetsSmsThreshold = marginPercent >= getSmsMarginThreshold();

                    // Only alert if we haven't seen this play before
                    if (!alertedPlayIds.has(playId)) {
                        alertedPlayIds.add(playId);
                        showHedgeAlert(play);
                    }

                    if (meetsSmsThreshold && !smsAlertedPlayIds.has(playId)) {
                        smsAlertedPlayIds.add(playId);
                        sendSMSAlert(play); // Send SMS alert
                    }
                }
            });
        }

        async function buildParlayRecommendation() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const boostPercent = getPromoBoostPercent();

            if (sportCheckboxes.length === 0) {
                setBuilderStatus("Select at least one sport to build a parlay.");
                return;
            }
            if (marketCheckboxes.length === 0) {
                setBuilderStatus("Select at least one market to build a parlay.");
                return;
            }
            if (targetBook === compareBook) {
                setBuilderStatus("Target book and comparison book must differ for parlay building.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);

            setBuilderStatus("Building parlay from highest hedge EV plays...");

            try {
                const res = await loggedFetch("/api/parlay-builder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        parlay_size: 3,
                        boost_percent: boostPercent,
                        use_dummy_data: useDummyData
                    })
                }, 'parlay-builder');

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || (`HTTP ${res.status}`));
                }

                const data = await res.json();
                renderParlayBuilderResults(data);
                setBuilderStatus(`Built parlay using ${data.parlay_legs?.length || 0} legs with a ${boostPercent}% boost.`);
            } catch (err) {
                setBuilderStatus(`Parlay builder failed: ${err.message || err}`);
            }
        }

        async function fetchBestValuePlays() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const maxResults = Number(document.getElementById("best-max-results-input").value) || 50;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const shouldLogResults = document.getElementById("log-results-checkbox").checked;

            if (sportCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one sport.");
                return;
            }

            if (marketCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one market.");
                return;
            }

            if (targetBook === compareBook) {
                setBestStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);
            const isWatcherRunning = watcherTimer !== null;
            const shouldLogThisSearch = shouldLogResults && !isWatcherRunning;

            // Only clear results if watcher is not running (to avoid flickering during updates)
            if (!isWatcherRunning) {
                clearBestResults();
            }

            if (isWatcherRunning) {
                setBestStatus("Watcher: Checking for hedge opportunities...");
            } else {
                setBestStatus("Searching for arbitrage opportunities across sports and markets...");
            }
            if (useDummyData) {
                setBestStatus((isWatcherRunning ? "Watcher: Checking for hedge opportunities..." : "Searching for arbitrage opportunities across sports and markets...") + " [DUMMY DATA MODE]");
            }

            try {
                // When watcher is running, we can request fewer results since we only care about hedge opportunities
                // The API already sorts by arb_margin_percent, so top results are most likely to be hedge opportunities
                const requestMaxResults = isWatcherRunning ? maxResults : maxResults * 2;

                const res = await loggedFetch("/api/best-value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets: markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        max_results: requestMaxResults,
                        use_dummy_data: useDummyData
                    }),
                }, 'best-value-plays');
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastBestValueData = data;

                if (shouldLogThisSearch) {
                    logSearchResultsToFile(data, {
                        sportKeys,
                        markets,
                        targetBook,
                        compareBook,
                        maxResults: requestMaxResults,
                        useDummyData
                    });
                }

                // If watcher is running, filter to show only hedge opportunities
                renderBestValuePlays(data, isWatcherRunning);

                // Check for hedge alerts if watcher is running
                if (isWatcherRunning) {
                    const hedgePlays = (data.plays || []).filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    );
                    checkForHedgeAlerts(data.plays);

                    const watcherStatusBar = document.getElementById("watcher-status-bar");
                    const intervalVal = Number(document.getElementById("watcher-interval-input").value) || 60;
                    const newAlerts = hedgePlays.filter(p => !alertedPlayIds.has(getPlayId(p))).length;
                    if (newAlerts > 0) {
                        watcherStatusBar.textContent = `ðŸ”” Found ${hedgePlays.length} hedge opportunities (${newAlerts} new alerts!). Next check in ${intervalVal}s...`;
                    } else {
                        watcherStatusBar.textContent = `Watching... Found ${hedgePlays.length} hedge opportunities. Next check in ${intervalVal}s...`;
                    }
                }

                let playsCount = (data.plays || []).length;
                if (isWatcherRunning) {
                    // Count only hedge opportunities when watcher is running
                    playsCount = data.plays.filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    ).length;
                }
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked").textContent;
                if (isWatcherRunning) {
                    setBestSummary(`Hedge Watcher: Showing ${playsCount} hedge opportunities (arbitrage margin â‰¥ 0%) across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                } else {
                    setBestSummary(`Found ${playsCount} arbitrage opportunities across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by Arbitrage Margin (vs ${compareBookLabel}).`);
                }
                setBestStatus(isWatcherRunning ? "Watcher: Updated." : "Done.");
            } catch (e) {
                console.error(e);
                setBestStatus("Error: " + e.message);
            }
        }

        // Save form selections to localStorage
        function saveFormSelections() {
            const selections = {
                sports: Array.from(document.querySelectorAll(".sport-checkbox:checked")).map(cb => cb.value),
                markets: Array.from(document.querySelectorAll(".market-checkbox:checked")).map(cb => cb.value),
                targetBook: document.getElementById("best-target-book-select").value,
                compareBook: document.getElementById("best-compare-book-select").value,
                maxResults: document.getElementById("best-max-results-input").value,
                dummyData: document.getElementById("dummy-data-checkbox").checked,
                logResults: document.getElementById("log-results-checkbox").checked,
                watcherInterval: document.getElementById("watcher-interval-input").value,
                smsThreshold: document.getElementById("sms-threshold-input").value
            };
            localStorage.setItem("arbitrageFinderSelections", JSON.stringify(selections));
        }

        // Load form selections from localStorage
        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("arbitrageFinderSelections");
                if (!saved) return;

                const selections = JSON.parse(saved);

                // Restore sports checkboxes
                if (selections.sports && Array.isArray(selections.sports)) {
                    document.querySelectorAll(".sport-checkbox").forEach(cb => {
                        cb.checked = selections.sports.includes(cb.value);
                    });
                }

                // Restore markets checkboxes
                if (selections.markets && Array.isArray(selections.markets)) {
                    document.querySelectorAll(".market-checkbox").forEach(cb => {
                        cb.checked = selections.markets.includes(cb.value);
                    });
                }

                // Restore selects
                if (selections.targetBook) {
                    document.getElementById("best-target-book-select").value = selections.targetBook;
                }
                if (selections.compareBook) {
                    document.getElementById("best-compare-book-select").value = selections.compareBook;
                }
                if (selections.maxResults) {
                    document.getElementById("best-max-results-input").value = selections.maxResults;
                }
                if (selections.dummyData !== undefined) {
                    document.getElementById("dummy-data-checkbox").checked = selections.dummyData;
                }
                if (selections.logResults !== undefined) {
                    document.getElementById("log-results-checkbox").checked = selections.logResults;
                }
                if (selections.watcherInterval) {
                    document.getElementById("watcher-interval-input").value = selections.watcherInterval;
                }
                if (selections.smsThreshold !== undefined) {
                    document.getElementById("sms-threshold-input").value = selections.smsThreshold;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        // Credits display functions
        async function fetchCredits() {
            try {
                const response = await fetch("/api/credits");
                if (!response.ok) {
                    throw new Error("Failed to fetch credits");
                }
                const data = await response.json();
                updateCreditsDisplay(data);
            } catch (error) {
                console.error("Error fetching credits:", error);
                document.getElementById("api-credits").textContent = "API: Error";
            }
        }

        function updateCreditsDisplay(data) {
            const apiCreditsEl = document.getElementById("api-credits");

            if (data.api_credits) {
                const credits = data.api_credits;
                const percentage = (credits.used / credits.total) * 100;
                let className = "credits-high";
                if (percentage >= 90) {
                    className = "credits-low";
                } else if (percentage >= 70) {
                    className = "credits-medium";
                }
                apiCreditsEl.textContent = `API: ${credits.display}`;
                apiCreditsEl.className = className;
            } else {
                apiCreditsEl.textContent = "API: N/A";
                apiCreditsEl.className = "";
            }
        }

        // Refresh credits every 5 minutes
        function startCreditsRefresh() {
            fetchCredits(); // Initial fetch
            setInterval(fetchCredits, 5 * 60 * 1000); // Refresh every 5 minutes
        }

        // Smooth page navigation with fade transition
        function smoothNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 300); // Match the CSS transition duration
        }

        // Fade in on page load
        function fadeInPage() {
            requestAnimationFrame(() => {
                document.body.classList.add('fade-in');
            });
        }

        // Handle both initial load and back/forward navigation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fadeInPage);
        } else {
            fadeInPage();
        }

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was loaded from cache (back/forward navigation)
                document.body.classList.remove('fade-in');
                requestAnimationFrame(() => {
                    document.body.classList.add('fade-in');
                });
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            // Set up smooth navigation for all smooth-nav links
            document.querySelectorAll('.smooth-nav').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-href') || link.getAttribute('href');
                    if (url) {
                        smoothNavigate(url);
                    }
                });
            });

            // Mark the current page button as active (Bet Watcher button should not be active on this page)
            const watcherButton = document.querySelector('.top-right-buttons .smooth-nav[data-href="/watcher.html"]');
            if (watcherButton) {
                watcherButton.classList.remove('active');
            }

            // Start credits refresh
            startCreditsRefresh();

            // Load sports schema, then restore saved form selections and attach listeners
            fetchAndRenderSports().then(() => {
                try {
                    loadFormSelections();
                    document.getElementById('toggle-all-sports-btn').addEventListener('click', () => {
                        showAllSportsMode = !showAllSportsMode;
                        const btn = document.getElementById('toggle-all-sports-btn');
                        btn.textContent = showAllSportsMode ? 'Show Active Only' : 'Show All Sports';
                        btn.style.backgroundColor = showAllSportsMode ? '#e8f5e9' : '#f0f0f0';
                        fetchAndRenderSports(showAllSportsMode);
                    });
                } catch (e) {
                    appendClientLog('loadFormSelections failed: ' + (e.message || e));
                }

                // Save form selections when they change
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
                document.getElementById("best-target-book-select").addEventListener("change", saveFormSelections);
                document.getElementById("best-compare-book-select").addEventListener("change", saveFormSelections);
                document.getElementById("best-max-results-input").addEventListener("change", saveFormSelections);
                document.getElementById("dummy-data-checkbox").addEventListener("change", saveFormSelections);
                document.getElementById("log-results-checkbox").addEventListener("change", saveFormSelections);
                document.getElementById("watcher-interval-input").addEventListener("change", saveFormSelections);
                document.getElementById("sms-threshold-input").addEventListener("change", saveFormSelections);
            }).catch((err) => {
                appendClientLog('Failed to render sports schema: ' + (err.message || err));
                // Fallback: still attempt to load selections and attach listeners to any existing controls
                try { loadFormSelections(); } catch (e) { /* ignore */ }
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
            });

            const autoPollCheckbox = document.getElementById('auto-poll-server-watcher-checkbox');
            // Load saved preference (default: off)
            const savedAutoPoll = localStorage.getItem('autoPollServerWatcher');
            if (savedAutoPoll === 'true') {
                autoPollCheckbox.checked = true;
            }
            function startServerWatcherPolling() {
                try {
                    refreshServerWatcherStatus();
                } catch (e) {
                    // ignore
                }
                if (serverWatcherStatusTimer) clearInterval(serverWatcherStatusTimer);
                serverWatcherStatusTimer = setInterval(refreshServerWatcherStatus, 15000);
                appendClientLog('Started auto-polling server watcher status');
            }
            function stopServerWatcherPolling() {
                if (serverWatcherStatusTimer) {
                    clearInterval(serverWatcherStatusTimer);
                    serverWatcherStatusTimer = null;
                }
                appendClientLog('Stopped auto-polling server watcher status');
            }
            autoPollCheckbox.addEventListener('change', (e) => {
                const on = e.target.checked;
                localStorage.setItem('autoPollServerWatcher', on ? 'true' : 'false');
                if (on) startServerWatcherPolling(); else stopServerWatcherPolling();
            });
            if (autoPollCheckbox.checked) startServerWatcherPolling();

            // Load dummy data setting from localStorage
            const dummyDataCheckbox = document.getElementById("dummy-data-checkbox");
            const savedDummyData = localStorage.getItem("useDummyData");
            if (savedDummyData === "true") {
                dummyDataCheckbox.checked = true;
            }

            // Save dummy data setting to localStorage when changed
            dummyDataCheckbox.addEventListener("change", (e) => {
                localStorage.setItem("useDummyData", e.target.checked ? "true" : "false");
            });

            // Load and save SMS phone number from localStorage
            const smsPhoneInput = document.getElementById("sms-phone-input");
            const savedPhone = localStorage.getItem("smsPhoneNumber");
            if (savedPhone && smsPhoneInput) {
                smsPhoneInput.value = savedPhone;
            }
            if (smsPhoneInput) {
                smsPhoneInput.addEventListener("change", (e) => {
                    localStorage.setItem("smsPhoneNumber", e.target.value);
                });
            }

            // Arbitrage Finder buttons
            document.getElementById("find-best-btn").onclick = fetchBestValuePlays;
            document.getElementById("clear-best-btn").onclick = clearBestResults;
            document.getElementById("build-parlay-btn").onclick = buildParlayRecommendation;

            // Parlay Calculator
            document.getElementById("add-parlay-leg-btn").onclick = addParlayLeg;
            document.getElementById("remove-parlay-leg-btn").onclick = removeParlayLeg;
            document.querySelectorAll('.parlay-odds-input').forEach(input => {
                input.addEventListener('input', updateParlayCalculator);
            });

            // Arbitrage finder book validation
            const bestTargetBook = document.getElementById("best-target-book-select");
            const bestCompareBook = document.getElementById("best-compare-book-select");

            function validateBestBookSelection() {
                if (bestTargetBook.value === bestCompareBook.value) {
                    setBestStatus("Error: Target book and comparison book cannot be the same.");
                    return false;
                }
                return true;
            }

            bestTargetBook.addEventListener("change", validateBestBookSelection);
            bestCompareBook.addEventListener("change", validateBestBookSelection);

            // Watcher functionality
            const watcherIntervalInput = document.getElementById("watcher-interval-input");
            const startWatcherBtn = document.getElementById("start-watcher-btn");
            const stopWatcherBtn = document.getElementById("stop-watcher-btn");
            const watcherStatusBar = document.getElementById("watcher-status-bar");
            const startServerWatcherBtn = document.getElementById("start-server-watcher-btn");
            const stopServerWatcherBtn = document.getElementById("stop-server-watcher-btn");
            const serverWatcherStatusBar = document.getElementById("server-watcher-status");
            const serverWatcherLog = document.getElementById("server-watcher-log");
            const serverWatcherModes = document.querySelectorAll("input[name='server-watcher-mode']");
            let serverWatcherStatusTimer = null;

            // Request notification permission on page load
            requestNotificationPermission();

            function startWatcher() {
                const intervalVal = Number(watcherIntervalInput.value) || 60;
                const intervalMs = Math.max(intervalVal, 30) * 1000; // min 30 seconds

                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }

                // Validate book selection
                if (!validateBestBookSelection()) {
                    return;
                }

                // Clear previous alerts when starting fresh
                alertedPlayIds.clear();
                smsAlertedPlayIds.clear();

                watcherStatusBar.textContent = `Starting watcher... Checking for hedge opportunities every ${intervalVal}s...`;
                startWatcherBtn.disabled = true;
                stopWatcherBtn.disabled = false;
                document.getElementById("find-best-btn").disabled = true;

                // Show results section
                document.getElementById("best-results-section").style.display = "block";

                // Initial fetch
                fetchBestValuePlays();

                // Set up polling with error handling
                watcherTimer = setInterval(async () => {
                    try {
                        await fetchBestValuePlays();
                    } catch (error) {
                        console.error("Watcher error:", error);
                        watcherStatusBar.textContent = `Error: ${error.message}. Retrying in ${intervalVal}s...`;
                    }
                }, intervalMs);
            }

            function stopWatcher() {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }
                watcherStatusBar.textContent = "Watcher stopped.";
                startWatcherBtn.disabled = false;
                stopWatcherBtn.disabled = true;
                document.getElementById("find-best-btn").disabled = false;

                // Re-render results without hedge filter when watcher stops
                if (lastBestValueData) {
                    renderBestValuePlays(lastBestValueData, false);
                }
            }

            startWatcherBtn.onclick = startWatcher;
            stopWatcherBtn.onclick = stopWatcher;

            function getSelectedServerWatcherMode() {
                const selected = Array.from(serverWatcherModes).find((input) => input.checked);
                return selected ? selected.value : "headless";
            }

            function renderServerWatcherStatus(status) {
                if (!status) return;
                const running = Boolean(status.running);
                const mode = status.mode || getSelectedServerWatcherMode();
                const startedAt = status.started_at ? new Date(status.started_at) : null;
                const startedLabel = startedAt ? startedAt.toLocaleString() : null;
                const startedSuffix = startedLabel ? `, started ${startedLabel}` : "";
                const baseText = running
                    ? `Server watcher running (${mode}${startedSuffix}).`
                    : "Server watcher not running.";

                serverWatcherStatusBar.textContent = baseText;
                startServerWatcherBtn.disabled = running;
                stopServerWatcherBtn.disabled = !running;

                if (status.logs && Array.isArray(status.logs) && status.logs.length > 0) {
                    const recent = status.logs.slice(-12).join("\n");
                    serverWatcherLog.textContent = recent;
                } else {
                    serverWatcherLog.textContent = "No watcher logs yet.";
                }
            }

            async function refreshServerWatcherStatus() {
                try {
                    const res = await loggedFetch("/api/hedge-watcher/status", {}, 'watcher-status');
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.detail || "Unable to fetch watcher status");
                    }
                    renderServerWatcherStatus(data);
                } catch (error) {
                    appendClientLog(`watcher-status <= ERROR ${error.message}`);
                    serverWatcherStatusBar.textContent = `Server watcher status unavailable: ${error.message}`;
                    serverWatcherLog.textContent = "";
                    startServerWatcherBtn.disabled = false;
                    stopServerWatcherBtn.disabled = true;
                }
            }

            async function startServerWatcher() {
                const sportKeys = Array.from(document.querySelectorAll(".sport-checkbox:checked")).map(cb => cb.value);
                const markets = Array.from(document.querySelectorAll(".market-checkbox:checked")).map(cb => cb.value);
                const intervalVal = Math.max(Number(watcherIntervalInput.value) || 60, 30);
                const maxResults = Number(document.getElementById("best-max-results-input").value) || 10;
                const smsThreshold = Number(document.getElementById("sms-threshold-input").value) || 0;
                const targetBook = bestTargetBook.value;
                const compareBook = bestCompareBook.value;

                if (!validateBestBookSelection()) {
                    return;
                }
                if (sportKeys.length === 0 || markets.length === 0) {
                    serverWatcherStatusBar.textContent = "Select at least one sport and market first.";
                    return;
                }

                const payload = {
                    mode: getSelectedServerWatcherMode(),
                    target_book: targetBook,
                    compare_book: compareBook,
                    sport_keys: sportKeys,
                    markets: markets,
                    interval_seconds: intervalVal,
                    max_results: maxResults,
                    min_margin_percent: smsThreshold,
                    use_dummy_data: document.getElementById("dummy-data-checkbox").checked
                };

                serverWatcherStatusBar.textContent = "Starting server watcher...";
                startServerWatcherBtn.disabled = true;

                try {
                    const res = await loggedFetch("/api/hedge-watcher/start", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }, 'watcher-start');
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.detail || "Failed to start server watcher");
                    }
                    renderServerWatcherStatus(data);
                } catch (error) {
                    appendClientLog(`watcher-start <= ERROR ${error.message}`);
                    serverWatcherStatusBar.textContent = `Failed to start watcher: ${error.message}`;
                    startServerWatcherBtn.disabled = false;
                }
            }

            async function stopServerWatcher() {
                serverWatcherStatusBar.textContent = "Stopping server watcher...";
                try {
                    const res = await loggedFetch("/api/hedge-watcher/stop", { method: "POST" }, 'watcher-stop');
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.detail || "Failed to stop watcher");
                    }
                    renderServerWatcherStatus(data);
                } catch (error) {
                    appendClientLog(`watcher-stop <= ERROR ${error.message}`);
                    serverWatcherStatusBar.textContent = `Failed to stop watcher: ${error.message}`;
                }
            }

            startServerWatcherBtn.onclick = startServerWatcher;
            stopServerWatcherBtn.onclick = stopServerWatcher;

            // Test SMS functionality
            const testSmsBtn = document.getElementById("test-sms-btn");
            const testSmsStatus = document.getElementById("test-sms-status");

            async function sendTestSMS() {
                const phoneInput = document.getElementById("sms-phone-input");
                const phone = phoneInput ? phoneInput.value.trim() : "";

                if (!phone) {
                    testSmsStatus.style.display = "block";
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = "Please enter a phone number first.";
                    return;
                }

                testSmsStatus.style.display = "block";
                testSmsStatus.style.color = "#94a3b8";
                testSmsStatus.textContent = "Sending test SMS...";
                testSmsBtn.disabled = true;

                const testMessage = "Test alert from Arbitrage Bet Finder - SMS notifications are working!";

                try {
                    const response = await fetch("/api/send-sms", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            phone: phone,
                            message: testMessage
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        testSmsStatus.style.color = "#bbf7d0";
                        testSmsStatus.textContent = `âœ… Test SMS sent successfully! Quota remaining: ${result.quotaRemaining || "N/A"}`;
                    } else {
                        testSmsStatus.style.color = "#fecaca";
                        testSmsStatus.textContent = `âŒ Failed: ${result.detail || result.error || "Unknown error"}`;
                    }
                } catch (error) {
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = `âŒ Error: ${error.message}`;
                } finally {
                    testSmsBtn.disabled = false;
                }
            }

            testSmsBtn.onclick = sendTestSMS;

            // Clean up on page unload
            window.addEventListener("beforeunload", () => {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                }
            });

            // Toggle panel functionality
            const toggleWatcherBtn = document.getElementById("toggle-watcher-btn");
            const watcherPanel = document.getElementById("watcher-panel");

            // Load toggle states from localStorage
            const watcherVisible = localStorage.getItem("watcherVisible") === "true";

            // Set initial states
            if (watcherVisible) {
                watcherPanel.classList.add("open");
                toggleWatcherBtn.classList.add("active");
                document.body.classList.add("watcher-open");
            }

            // Toggle watcher panel
            toggleWatcherBtn.onclick = () => {
                const isOpen = watcherPanel.classList.contains("open");
                if (isOpen) {
                    watcherPanel.classList.remove("open");
                    toggleWatcherBtn.classList.remove("active");
                    document.body.classList.remove("watcher-open");
                    localStorage.setItem("watcherVisible", "false");
                } else {
                    watcherPanel.classList.add("open");
                    toggleWatcherBtn.classList.add("active");
                    document.body.classList.add("watcher-open");
                    localStorage.setItem("watcherVisible", "true");
                }
            };


        });
    </script>
</body>

</html>