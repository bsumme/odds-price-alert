<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>BensSportsBookApp</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script>
        // Mobile device detection and redirect
        (function () {
            function isMobileDevice() {
                // Check user agent
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;

                // Check screen width (mobile if less than 768px)
                const isSmallScreen = window.innerWidth < 768;

                // Check touch capability
                const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                // Redirect if mobile device detected and not already on mobile page
                if ((mobileRegex.test(userAgent.toLowerCase()) || (isSmallScreen && hasTouchScreen))
                    && !window.location.pathname.includes('-mobile.html')) {
                    // Preserve query string and hash if present
                    const newUrl = '/ArbritrageBetFinder-mobile.html' + window.location.search + window.location.hash;
                    window.location.replace(newUrl);
                }
            }

            // Run detection immediately
            isMobileDevice();
        })();
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.fade-out {
            opacity: 0;
        }

        body.fade-in {
            opacity: 1;
        }

        header {
            padding: 1rem 1.25rem;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        header .small-text {
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        header nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        header nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 0.35rem 0.6rem;
            border-radius: 0.4rem;
            border: 1px solid transparent;
        }

        header nav a:hover {
            color: #e5e7eb;
            border-color: #1f2937;
            background: #111827;
        }

        header nav a.active {
            color: #bbf7d0;
            font-weight: 600;
            border-color: #166534;
            background: #0b1220;
        }

        .toggle-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
            transition: bottom 0.2s;
        }

        .toggle-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .mode-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .mode-toggle button {
            flex: 1;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            border-radius: 0.55rem;
            padding: 0.65rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-toggle button.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }


        main {
            padding: 4.5rem 0.75rem 0.75rem 0.75rem;
            height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0.75rem;
            align-items: start;
            overflow: hidden;
            padding-right: 0.75rem;
            box-sizing: border-box;
            transition: padding-right 0.3s ease;
        }

        /* Adjust main layout when watcher panel is open */
        body.watcher-open main {
            padding-right: 320px;
            /* 300px panel + 20px gap */
        }

        .filter-panel {
            padding-top: 0;
        }

        @media (max-width: 1600px) {
            main {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 1400px) {
            main {
                grid-template-columns: 260px 1fr;
            }
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            padding: 0.6rem 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .filter-card-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        .filter-actions {
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.6) 0%, #1e293b 40%);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            border-top: 1px solid #334155;
        }

        .card h2 {
            margin-top: 0;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        .card h3 {
            margin-top: 0;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            margin-bottom: 0.1rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        select,
        input[type="number"],
        input[type="tel"] {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border-radius: 0.4rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.8rem;
        }

        select:hover,
        input[type="number"]:hover {
            border-color: #64748b;
        }

        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #166534;
            box-shadow: 0 0 0 3px rgba(22, 101, 52, 0.2);
        }

        input[type="checkbox"] {
            margin-right: 0.35rem;
        }

        .btn {
            border: none;
            border-radius: 0.4rem;
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.4rem;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #475569;
            color: #e5e7eb;
        }

        .btn-link:hover {
            background: #334155;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status-bar {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 0.4rem;
        }

        .log-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.4rem;
            padding: 0.5rem;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.75rem;
            color: #cbd5e1;
            min-height: 10rem;
            max-height: 16rem;
            overflow: auto;
            white-space: pre-wrap;
        }

        @media (min-width: 1024px) {
            .log-box {
                min-height: 14rem;
                max-height: 28rem;
            }
        }

        table {
            width: 100%;
            min-width: 800px;
            /* Ensure table doesn't get too narrow */
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th,
        td {
            border-bottom: 1px solid #334155;
            padding: 0.3rem 0.4rem;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
        }

        /* Column width adjustments - use min-width for critical columns */
        th:nth-child(1),
        td:nth-child(1) {
            width: auto;
            min-width: 60px;
            /* Sport */
        }

        th:nth-child(2),
        td:nth-child(2) {
            width: auto;
            min-width: 160px;
            max-width: 220px;
            /* Recommended Bet - shortened */
            white-space: normal;
            /* Allow wrapping for this column */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: auto;
            min-width: 160px;
            /* Hedge Bet */
            white-space: normal;
            /* Allow wrapping */
        }

        th:nth-child(4),
        td:nth-child(4) {
            width: auto;
            min-width: 130px;
            /* Arbitrage Margin - ensure it's always visible */
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: auto;
            min-width: 120px;
            /* Start Time */
        }

        th {
            background: #1e293b;
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.7rem;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
        }

        /* Custom scrollbar styling */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .small-text {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .hedge-stake {
            color: #cbd5e1;
            display: inline-block;
            margin-top: 0.2rem;
        }

        .odds-highlight {
            font-weight: 800;
        }

        .odds-hedge-neutral {
            color: #cbd5e1;
        }

        .odds-hedge-light-green {
            color: #4ade80;
        }

        .odds-hedge-dark-green {
            color: #166534;
        }

        .odds-hedge-light-red {
            color: #f87171;
        }

        .odds-hedge-dark-red {
            color: #7f1d1d;
        }

        .bet-cell {
            min-width: 220px;
        }

        .bet-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bet-text {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-positive {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-negative {
            background: #7f1d1d;
            color: #fecaca;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .bet-list {
            font-size: 0.75rem;
        }

        .bet-item {
            padding: 0.25rem 0;
            border-bottom: 1px dashed #334155;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 0.4rem;
            display: inline-block;
            object-fit: contain;
        }

        .team-name-with-logo {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toggle-on {
            background: #166534;
            color: #bbf7d0;
            border-color: #15803d;
        }

        .filter-panel {
            height: 100%;
            overflow: hidden;
        }

        .results-panel {
            min-width: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-toggle-btn {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1002;
            background: #1e293b;
            border: 1px solid #334155;
            border-right: none;
            border-radius: 0.4rem 0 0 0.4rem;
            color: #e5e7eb;
            padding: 1rem 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .panel-toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .panel-toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .panel-toggle-btn .arrow {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .panel-toggle-btn.active .arrow {
            transform: rotate(180deg);
        }

        /* Slide-out panel animation */
        .watcher-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: transparent;
            transition: right 0.3s ease;
            z-index: 1001;
            overflow: hidden;
            padding: 0.75rem;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
        }

        .watcher-panel.open {
            right: 0;
        }


        .watcher-panel .card {
            margin: 0;
            height: 100%;
            max-height: 100%;
        }

        .credits-display {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .credits-display .credits-low {
            color: #fecaca;
        }

        .credits-display .credits-medium {
            color: #fde68a;
        }

        .credits-display .credits-high {
            color: #bbf7d0;
        }

        footer {
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Adjust main padding to account for footer */
        main {
            padding-bottom: 3rem;
        }
    </style>
</head>

<body>
    <script src="/nav-trim.js"></script>
    <script src="/table-renderers.js"></script>
    <button class="panel-toggle-btn" id="toggle-watcher-btn" title="Toggle Arb Watcher Panel">
        <span class="arrow">â—€</span>
    </button>
    <header id="main-header">
        <div>
            <h1>BensSportsBookApp</h1>
            <div class="small-text">Compare sportsbook odds and uncover risk-free opportunities.</div>
        </div>
        <nav>
            <a href="/BensSportsBookApp.html" class="active">Arbitrage Finder</a>
            <a href="/sgp-builder.html" class="smooth-nav">SGP Builder</a>
            <a href="/settings.html" class="smooth-nav">Settings</a>
        </nav>
    </header>

    <main>
        <div style="grid-column: 1 / -1; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem;">
            <div class="mode-toggle" style="margin: 0;">
                <button id="arb-mode-btn" class="active" aria-pressed="true">Main Markets</button>
                <button id="props-mode-btn" aria-pressed="false">Player Props</button>
            </div>
            <div class="small-text">Swap between arbitrage finder and player props search without leaving the main page.</div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel" id="arb-filter-panel">
            <section class="card">
                <div class="filter-card-content">
                    <h2>Arbitrage Bet Finder</h2>
                    <div class="small-text" style="margin-bottom: 0.75rem;">
                        Discover arbitrage opportunities across multiple sports and markets by comparing odds between
                        sportsbooks
                    </div>

                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label>Select Sports</label>
                        <button id="toggle-all-sports-btn"
                            style="padding: 0.3rem 0.6rem; font-size: 0.85rem; cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;">Show
                            All Sports</button>
                    </div>
                    <div id="sports-container" style="margin-bottom: 0.5rem;">
                        <!-- Sports checkboxes will be populated from /api/sports -->
                    </div>

                    <label>Select Markets</label>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="h2h" checked />
                            <span style="margin-left: 0.5rem;">Moneyline</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="spreads" checked />
                            <span style="margin-left: 0.5rem;">Spreads</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-top: 0.3rem;">
                            <input type="checkbox" class="market-checkbox" value="totals" checked />
                            <span style="margin-left: 0.5rem;">Totals</span>
                        </label>
                    </div>

                    <label for="best-target-book-select">Target book</label>
                    <select id="best-target-book-select">
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                        <option value="novig">Novig</option>
                    </select>

                    <label for="best-compare-book-select">Compare against</label>
                    <select id="best-compare-book-select">
                        <option value="novig" selected>Novig</option>
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                    </select>

                    <label for="best-max-results-input" style="display: none;">Max results</label>
                    <input id="best-max-results-input" type="number" min="10" max="200" step="10" value="10"
                        style="display: none;" />

                    <label
                        style="display: none; align-items: center; margin-top: 0.75rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                        <input type="checkbox" id="dummy-data-checkbox" style="margin-right: 0.5rem;" />
                        <span>Use Dummy Data (for development when API credits are exhausted)</span>
                    </label>

                    <label
                        style="display: none; align-items: center; margin-top: 0.5rem; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px;">
                        <input type="checkbox" id="log-results-checkbox" style="margin-right: 0.5rem;" />
                        <span>Save search results as JSON</span>
                    </label>

                    <label for="promo-boost-input" style="margin-top: 0.5rem;">Promo boost % (20-100, default
                        30)</label>
                    <input id="promo-boost-input" type="number" min="20" max="100" step="5" value="30" />

                    <div class="filter-actions">
                        <div style="margin-top: 0.25rem;">
                            <button class="btn btn-primary" id="find-best-btn" onclick="fetchBestValuePlays()">
                                Find Arbitrage Opportunities
                            </button>

                            <button class="btn btn-secondary" id="clear-best-btn">Clear</button>
                        </div>

                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" id="build-parlay-btn">Build Best Parlay</button>
                            <a class="btn btn-secondary" href="/sgp-builder.html"
                                style="text-align: center; text-decoration: none;">Open SGP Builder</a>
                        </div>

                        <div class="small-text" style="margin-top: 0.5rem;">
                            Build same-game parlays in the dedicated SGP Builder after picking a matchup.
                        </div>

                        <div class="small-text" style="margin-top: 0.5rem;">Filter total SGP odds</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <label class="small-text" style="display: flex; gap: 0.35rem; align-items: center;">
                                Min
                                <input id="sgp-min-odds-input" type="number" value="100" style="width: 6rem;" />
                            </label>
                            <label class="small-text" style="display: flex; gap: 0.35rem; align-items: center;">
                                Max
                                <input id="sgp-max-odds-input" type="number" value="20000" style="width: 6rem;" />
                            </label>
                        </div>

                        <div class="status-bar" id="best-status-bar">Ready.</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Player Props Filter Panel -->
        <div class="filter-panel" id="props-filter-panel" style="display: none;">
            <section class="card">
                <div class="filter-card-content">
                    <h2>Player Props Search</h2>
                    <div class="small-text" style="margin-bottom: 0.75rem;">Run focused player prop scans while keeping the same look and feel.</div>

                    <label for="props-sport">Sport</label>
                    <select id="props-sport">
                        <option value="">Select a sport</option>
                        <option value="basketball_nba">NBA</option>
                        <option value="americanfootball_nfl">NFL</option>
                        <option value="baseball_mlb">MLB</option>
                        <option value="icehockey_nhl">NHL</option>
                    </select>

                    <label for="props-game">Upcoming Games</label>
                    <select id="props-game">
                        <option value="">All Games</option>
                    </select>
                    <div class="small-text">Select a matchup to scope searches to a single game.</div>

                    <label for="props-team">Team</label>
                    <select id="props-team">
                        <option value="">All Teams</option>
                    </select>

                    <label for="props-player">Player</label>
                    <select id="props-player">
                        <option value="">All Players</option>
                    </select>

                    <label>Markets</label>
                    <div class="pill-group" id="props-markets" style="margin-bottom: 0.5rem;">
                        <label><input type="checkbox" value="all_player_props" checked>All player props</label>
                        <label><input type="checkbox" value="player_points" checked>Points</label>
                        <label><input type="checkbox" value="player_rebounds" checked>Rebounds</label>
                        <label><input type="checkbox" value="player_assists" checked>Assists</label>
                        <label><input type="checkbox" value="player_threes" checked>Threes</label>
                    </div>

                    <label for="props-target">Target book</label>
                    <select id="props-target">
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                        <option value="novig">Novig</option>
                    </select>

                    <label for="props-compare" style="margin-top: 0.4rem;">Compare against</label>
                    <select id="props-compare">
                        <option value="novig" selected>Novig</option>
                        <option value="draftkings">DraftKings</option>
                        <option value="fanduel">FanDuel</option>
                        <option value="fliff">Fliff</option>
                    </select>

                    <div class="filter-actions">
                        <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="props-search-btn">Find Player Props</button>
                            <button class="btn btn-secondary" id="props-all-sports-btn">Search All Sports</button>
                            <button class="btn btn-secondary" id="props-reset-btn">Reset</button>
                        </div>
                        <div class="status-bar" id="props-status-bar">Ready.</div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Results Panel -->
        <div class="results-panel" id="arb-results-panel">
            <section class="card" id="best-results-section" style="display: none;">
                <h2>Arbitrage Opportunities</h2>
                <div class="small-text" id="best-summary-bar" style="margin-bottom: 0.4rem;"></div>
                <div style="display: flex; justify-content: flex-end; margin: 0.4rem 0 0.5rem 0;">
                    <button class="btn btn-secondary" id="best-odds-sort-btn" style="margin: 0;">
                        Sort Recommended Odds: High â†’ Low
                    </button>
                </div>
                <div class="scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Sport</th>
                                <th>Recommended Bet</th>
                                <th>Hedge Bet</th>
                                <th>Arbitrage Margin</th>
                                <th>Start Time</th>
                            </tr>
                        </thead>
                        <tbody id="best-results-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="card" id="builder-results-section" style="display: none;">
                <h2>Parlay Builder</h2>
                <div class="small-text" id="builder-status-bar" style="margin-bottom: 0.4rem;">Ready.</div>
                <div id="parlay-builder-output" class="small-text" style="margin-bottom: 0.75rem;">Use the builder
                    buttons to generate high-value parlays based on hedge EV.</div>
                <div class="small-text">
                    Looking for same-game parlays? Head to the <a href="/sgp-builder.html">dedicated SGP page</a> to
                    choose a game and stack boosted legs.
                </div>
            </section>

        </div>

        <div class="results-panel" id="props-results-panel" style="display: none;">
            <section class="card">
                <h2>Player Props Results</h2>
                <div class="small-text" id="props-summary-bar" style="margin-bottom: 0.4rem;">Use the filters above to find arbitrage opportunities for player props</div>
                <div class="scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Selection</th>
                                <th>Recommended Bet</th>
                                <th>Opposing Bet</th>
                                <th>Edge</th>
                                <th>Start / Game</th>
                            </tr>
                        </thead>
                        <tbody id="props-results-body">
                            <tr><td colspan="5" class="small-text">Use the filters above to find arbitrage opportunities for player props</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="toggle-buttons" id="builder-toggle-container" style="display: none;">
            <button class="toggle-btn" id="builder-results-toggle" aria-expanded="false">Show Parlay Builder Results</button>
        </div>

        <!-- Arb Watcher Panel -->
        <div class="watcher-panel" id="watcher-panel">
            <section class="card" id="watcher-card">
                <h2>ðŸ”” Hedge Watcher</h2>
                <div class="small-text" style="margin-bottom: 0.5rem;">
                    Monitor for hedge opportunities (arbitrage margin â‰¥ 0%).
                </div>

                <label for="watcher-interval-input">Check interval (seconds)</label>
                <input id="watcher-interval-input" type="number" min="30" max="300" step="10" value="60" />

                <label for="sms-phone-input" style="margin-top: 0.5rem;">SMS Phone (optional)</label>
                <input id="sms-phone-input" type="tel" placeholder="5551234567" />

                <label for="sms-threshold-input" style="margin-top: 0.5rem;">Min arbitrage margin for SMS (%)</label>
                <input id="sms-threshold-input" type="number" step="0.1" value="0" />
                <div class="small-text">Only send text alerts when arbitrage margin meets or exceeds this value.</div>

                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-primary" id="start-watcher-btn">Start Watcher</button>
                    <button class="btn btn-secondary" id="stop-watcher-btn" disabled>Stop</button>
                </div>

                <div style="margin-top: 0.5rem;">
                    <button class="btn btn-secondary" id="test-sms-btn">Test SMS Alert</button>
                </div>

                <div class="status-bar" id="watcher-status-bar" style="margin-top: 0.4rem;">Watcher stopped.</div>
                <div class="status-bar" id="test-sms-status" style="margin-top: 0.4rem; display: none;"></div>

                <div class="log-box" id="client-log" aria-live="polite" style="margin-top: 0.35rem;">
                    Client log initialized.
                </div>
            </section>
        </div>
    </main>

    <!-- Credits Display -->
    <footer
        style="position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 1px solid #334155; padding: 0.5rem 1rem; z-index: 1000; text-align: center;">
        <div class="credits-display">
            <span id="api-credits">API: Loading...</span>
        </div>
    </footer>

    <script>
        let valuePollTimer = null;
        let lastValueData = null;
        let filterHedgeOnly = false;
        let watcherTimer = null;
        let lastBestValueData = null;
        let alertedPlayIds = new Set(); // Track plays we've already alerted on
        let smsAlertedPlayIds = new Set(); // Track plays that have triggered an SMS
        const RECOMMENDED_ODDS_SORT_KEY = "recommendedOddsSortDirection";
        let recommendedOddsSortDirection = loadRecommendedOddsSortDirection();
        let arbitrageSortMode = "arb-margin";
        let currentMode = "arb";
        let propsData = null;
        let hasRunPropsSearch = false;
        const DEFAULT_PROPS_EMPTY_MESSAGE = "Use the filters above to find arbitrage opportunities for player props";
        // Placeholder to ensure stopWatcher is always defined in the current scope
        let stopWatcher = () => {};
        const BOOK_LABELS = {
            draftkings: "DraftKings",
            fanduel: "FanDuel",
            fliff: "Fliff",
            novig: "Novig",
        };

        function getBookLabel(key) {
            if (!key) return "";
            return BOOK_LABELS[key] || key;
        }

        // Client-side network/log helper
        function appendClientLog(msg) {
            try {
                const el = document.getElementById('client-log');
                const ts = new Date().toLocaleTimeString();
                el.textContent = `${ts} - ${msg}\n` + el.textContent;
            } catch (e) {
                // ignore
            }
            console.log('[client-log]', msg);
        }

        function loadRecommendedOddsSortDirection() {
            const savedDirection = localStorage.getItem(RECOMMENDED_ODDS_SORT_KEY);
            if (savedDirection === "asc" || savedDirection === "desc") {
                return savedDirection;
            }
            return "desc";
        }

        function saveRecommendedOddsSortDirection(direction) {
            if (direction === "asc" || direction === "desc") {
                localStorage.setItem(RECOMMENDED_ODDS_SORT_KEY, direction);
            }
        }

        function normalizeOddsValue(odds, fallback) {
            const numOdds = typeof odds === "string" ? parseFloat(odds) : odds;
            if (Number.isFinite(numOdds)) {
                return numOdds;
            }
            return fallback;
        }

        function sortPlaysByRecommendedOdds(plays, direction = "desc") {
            const list = Array.isArray(plays) ? [...plays] : [];
            const fallback = direction === "asc" ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;

            list.sort((a, b) => {
                const aOdds = normalizeOddsValue(a?.book_price, fallback);
                const bOdds = normalizeOddsValue(b?.book_price, fallback);
                return direction === "asc" ? aOdds - bOdds : bOdds - aOdds;
            });

            return list;
        }

        function sortPlaysByArbitrageMargin(plays, direction = "desc") {
            const list = Array.isArray(plays) ? [...plays] : [];
            const fallback = direction === "asc" ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;

            list.sort((a, b) => {
                const aMargin = normalizeOddsValue(a?.arb_margin_percent, fallback);
                const bMargin = normalizeOddsValue(b?.arb_margin_percent, fallback);
                return direction === "asc" ? aMargin - bMargin : bMargin - aMargin;
            });

            return list;
        }

        function getSortedArbitragePlays(plays) {
            if (arbitrageSortMode === "odds") {
                return sortPlaysByRecommendedOdds(plays, recommendedOddsSortDirection);
            }
            return sortPlaysByArbitrageMargin(plays, "desc");
        }

        function getArbitrageSortLabel() {
            if (arbitrageSortMode === "odds") {
                return recommendedOddsSortDirection === "desc"
                    ? "Recommended Odds (High â†’ Low)"
                    : "Recommended Odds (Low â†’ High)";
            }
            return "Arbitrage Margin";
        }

        function updateOddsSortButtonLabel() {
            const btn = document.getElementById("best-odds-sort-btn");
            if (!btn) return;
            if (arbitrageSortMode === "odds") {
                btn.textContent = recommendedOddsSortDirection === "desc"
                    ? "Odds Sort: High â†’ Low"
                    : "Odds Sort: Low â†’ High";
            } else {
                btn.textContent = "Odds Sort Off (Arb Margin)";
            }
        }

        function getSgpOddsRangeFilters() {
            const minInput = document.getElementById("sgp-min-odds-input");
            const maxInput = document.getElementById("sgp-max-odds-input");

            const minOdds = Number.parseInt(minInput?.value, 10);
            const maxOdds = Number.parseInt(maxInput?.value, 10);

            const resolvedMin = Number.isNaN(minOdds) ? 100 : minOdds;
            const resolvedMax = Number.isNaN(maxOdds) ? 20000 : maxOdds;

            if (minInput && Number.isNaN(minOdds)) minInput.value = resolvedMin;
            if (maxInput && Number.isNaN(maxOdds)) maxInput.value = resolvedMax;

            return {
                min_total_american_odds: resolvedMin,
                max_total_american_odds: resolvedMax
            };
        }

        async function loggedFetch(url, options = {}, tag = '') {
            const method = (options.method || 'GET').toUpperCase();
            const safeBody = options.body ? (typeof options.body === 'string' ? options.body.slice(0, 200) : JSON.stringify(options.body).slice(0, 200)) : '';
            appendClientLog(`${tag} -> ${method} ${url} ${safeBody ? '| body=' + safeBody : ''}`);
            let res;
            try {
                res = await fetch(url, options);
            } catch (err) {
                appendClientLog(`${tag} <= ERROR ${err.message || err}`);
                throw err;
            }
            appendClientLog(`${tag} <= ${res.status} ${res.statusText}`);
            return res;
        }

        function formatStartTime(isoString) {
            if (!isoString) return "";

            const trimmed = String(isoString).trim();
            if (!trimmed) return "";

            const date = new Date(trimmed);
            if (Number.isNaN(date.getTime())) {
                return trimmed;
            }

            const options = {
                timeZone: "America/New_York",
                month: "short",
                day: "numeric",
                hour: "numeric",
                minute: "2-digit",
                hour12: true,
            };
            return date.toLocaleString("en-US", options) + " ET";
        }

        function formatMarketLabel(marketKey) {
            const mapping = {
                h2h: "ML",
                spreads: "Spreads",
                totals: "Totals"
            };
            return mapping[marketKey] || marketKey.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        }

        const PROP_MARKET_LABELS = {
            player_points: "Points",
            player_assists: "Assists",
            player_rebounds: "Rebounds",
            player_threes: "Threes",
            player_pass_yds: "Pass Yards",
            player_rec_yds: "Receiving Yards",
            player_rush_yds: "Rush Yards",
            player_anytime_td: "Anytime TD",
            player_pass_tds: "Pass TDs",
            player_goals: "Goals",
            player_shots_on_goal: "Shots on Goal",
            player_power_play_points: "Power Play Points",
            player_blocks: "Blocks",
            player_saves: "Saves",
        };

        const PLAYER_PROP_MARKETS_BY_SPORT = {
            basketball_nba: [
                "player_points",
                "player_assists",
                "player_rebounds",
                "player_threes",
            ],
            americanfootball_nfl: [
                "player_pass_yds",
                "player_rec_yds",
                "player_rush_yds",
                "player_anytime_td",
                "player_pass_tds",
            ],
            icehockey_nhl: [
                "player_points",
                "player_goals",
                "player_assists",
                "player_shots_on_goal",
                "player_power_play_points",
                "player_blocks",
                "player_saves",
            ],
        };

        const ALL_PLAYER_PROP_MARKETS = Array.from(
            new Set(Object.values(PLAYER_PROP_MARKETS_BY_SPORT).flat())
        );

        function formatPropMarketLabel(marketKey) {
            return PROP_MARKET_LABELS[marketKey] || formatMarketLabel(marketKey);
        }

        function getPropMarketsForSport(sportKey) {
            if (sportKey && PLAYER_PROP_MARKETS_BY_SPORT[sportKey]) {
                return PLAYER_PROP_MARKETS_BY_SPORT[sportKey];
            }
            return ALL_PLAYER_PROP_MARKETS;
        }

        function renderPropMarketCheckboxes(sportKey) {
            const container = document.getElementById("props-markets");
            if (!container) return;

            const currentSelection = new Set(getSelectedPropMarkets());
            const markets = getPropMarketsForSport(sportKey);
            const fragment = document.createDocumentFragment();

            const addCheckbox = (value, label, checked = true) => {
                const wrapper = document.createElement("label");
                const input = document.createElement("input");
                input.type = "checkbox";
                input.value = value;
                input.checked = checked;
                wrapper.appendChild(input);
                wrapper.append(label);
                fragment.appendChild(wrapper);
            };

            const hasAllSelected = currentSelection.size === 0 || currentSelection.has("all_player_props");
            const hasOverlap = markets.some((market) => currentSelection.has(market));
            const defaultToAll = hasAllSelected || !hasOverlap;

            const shouldCheck = (value) =>
                value === "all_player_props" ? hasAllSelected : defaultToAll || currentSelection.has(value);

            addCheckbox("all_player_props", "All player props", hasAllSelected);
            markets.forEach((market) => {
                addCheckbox(market, formatPropMarketLabel(market), shouldCheck(market));
            });

            container.innerHTML = "";
            container.appendChild(fragment);
        }

        function formatSportLabel(sportKey) {
            const mapping = {
                basketball_nba: "NBA",
                americanfootball_nfl: "NFL",
                icehockey_nhl: "NHL",
                basketball_ncaab: "NCAAB",
                americanfootball_ncaaf: "NCAAF"
                , mma_mixed_martial_arts: "UFC / MMA"
            };
            return mapping[sportKey] || sportKey.toUpperCase();
        }

        // Fetch sports schema from server and render checkboxes
        let showAllSportsMode = false;

        async function fetchAndRenderSports(showAll = false) {
            try {
                const res = await loggedFetch('/api/sports', {}, 'sports');
                if (!res.ok) {
                    appendClientLog('sports <= failed to load schema');
                    return;
                }
                const list = await res.json();
                const container = document.getElementById('sports-container');
                if (!container) return;
                container.innerHTML = '';
                for (const s of list) {
                    if (!s || !s.key) continue;
                    if (!showAll && !s.active) continue; // only show active sports by default
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.marginTop = '0.3rem';

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'sport-checkbox';
                    input.value = s.key;
                    input.checked = showAll ? false : true; // uncheck all when showing all sports
                    input.style.marginRight = '0.4rem';

                    const span = document.createElement('span');
                    span.style.marginLeft = '0.5rem';
                    span.textContent = s.title || s.key;

                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                }
                appendClientLog('Loaded sports schema and rendered checkboxes');
            } catch (err) {
                appendClientLog('Failed to load sports schema: ' + (err.message || err));
            }
        }

        function formatBookLabel(bookKey) {
            const mapping = {
                draftkings: "DraftKings",
                fanduel: "FanDuel",
                fliff: "Fliff",
                novig: "Novig"
            };
            return mapping[bookKey] || bookKey;
        }

        function getPromoBoostPercent() {
            const boostInput = document.getElementById('promo-boost-input');
            if (!boostInput) return 30;
            const raw = Number(boostInput.value);
            if (Number.isNaN(raw)) return 30;
            return Math.min(100, Math.max(20, raw));
        }

        function setBuilderStatus(message) {
            const bar = document.getElementById('builder-status-bar');
            if (bar) {
                bar.textContent = message;
            }
        }

        function getBuilderToggleElements() {
            return {
                section: document.getElementById('builder-results-section'),
                toggleContainer: document.getElementById('builder-toggle-container'),
                toggleBtn: document.getElementById('builder-results-toggle')
            };
        }

        function showBuilderResultsSection() {
            const { section, toggleContainer, toggleBtn } = getBuilderToggleElements();
            if (section) {
                section.style.display = 'block';
            }
            if (toggleContainer) {
                toggleContainer.style.display = 'flex';
            }
            if (toggleBtn) {
                toggleBtn.textContent = 'Hide Parlay Builder Results';
                toggleBtn.setAttribute('aria-expanded', 'true');
                toggleBtn.classList.add('active');
            }
        }

        function hideBuilderResultsSection(hideToggle = false) {
            const { section, toggleContainer, toggleBtn } = getBuilderToggleElements();
            if (section) {
                section.style.display = 'none';
            }
            if (toggleContainer) {
                toggleContainer.style.display = hideToggle ? 'none' : 'flex';
            }
            if (toggleBtn) {
                toggleBtn.textContent = 'Show Parlay Builder Results';
                toggleBtn.setAttribute('aria-expanded', 'false');
                toggleBtn.classList.remove('active');
            }
        }

        function toggleBuilderResultsSection() {
            const { section } = getBuilderToggleElements();
            const isHidden = !section || section.style.display === 'none' || getComputedStyle(section).display === 'none';
            if (isHidden) {
                showBuilderResultsSection();
            } else {
                hideBuilderResultsSection();
            }
        }

        function getSmsMarginThreshold() {
            const thresholdInput = document.getElementById("sms-threshold-input");
            const value = thresholdInput ? Number(thresholdInput.value) : 0;
            return Number.isNaN(value) ? 0 : value;
        }

        function buildLogFilename(markets, sports, targetBook, compareBook) {
            const timestamp = new Date().toISOString().replace(/[:T]/g, "-").split(".")[0];
            const marketPart = (markets.length ? markets.map(formatMarketLabel) : ["AllMarkets"]).join("+");
            const sportPart = (sports.length ? sports.map(formatSportLabel) : ["AllSports"]).join("+");
            const targetLabel = formatBookLabel(targetBook);
            const compareLabel = formatBookLabel(compareBook);

            const sanitize = (value) => value.replace(/[^a-zA-Z0-9+]+/g, "");
            return `${timestamp}_${sanitize(marketPart)}_${sanitize(sportPart)}_${sanitize(targetLabel)}_vs_${sanitize(compareLabel)}.json`;
        }

        function logSearchResultsToFile(data, { sportKeys, markets, targetBook, compareBook, maxResults, useDummyData }) {
            const payload = {
                logged_at: new Date().toISOString(),
                filters: {
                    sports: sportKeys,
                    markets,
                    target_book: targetBook,
                    compare_book: compareBook,
                    max_results: maxResults,
                    use_dummy_data: useDummyData
                },
                results: data
            };

            const filename = buildLogFilename(markets, sportKeys, targetBook, compareBook);
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function getTeamLogoUrl(teamName, sportKey = null) {
            if (!teamName) return null;

            // Team name to ESPN team code mapping
            const teamMapping = {
                // NBA
                "atlanta hawks": "atl",
                "boston celtics": "bos",
                "brooklyn nets": "bkn",
                "charlotte hornets": "cha",
                "chicago bulls": "chi",
                "cleveland cavaliers": "cle",
                "dallas mavericks": "dal",
                "denver nuggets": "den",
                "detroit pistons": "det",
                "golden state warriors": "gs",
                "houston rockets": "hou",
                "indiana pacers": "ind",
                "los angeles clippers": "lac",
                "los angeles lakers": "lal",
                "memphis grizzlies": "mem",
                "miami heat": "mia",
                "milwaukee bucks": "mil",
                "minnesota timberwolves": "min",
                "new orleans pelicans": "no",
                "new york knicks": "ny",
                "oklahoma city thunder": "okc",
                "orlando magic": "orl",
                "philadelphia 76ers": "phi",
                "phoenix suns": "phx",
                "portland trail blazers": "por",
                "sacramento kings": "sac",
                "san antonio spurs": "sa",
                "toronto raptors": "tor",
                "utah jazz": "utah",
                "washington wizards": "wsh",
                // NFL
                "arizona cardinals": "ari",
                "atlanta falcons": "atl",
                "baltimore ravens": "bal",
                "buffalo bills": "buf",
                "carolina panthers": "car",
                "chicago bears": "chi",
                "cincinnati bengals": "cin",
                "cleveland browns": "cle",
                "dallas cowboys": "dal",
                "denver broncos": "den",
                "detroit lions": "det",
                "green bay packers": "gb",
                "houston texans": "hou",
                "indianapolis colts": "ind",
                "jacksonville jaguars": "jax",
                "kansas city chiefs": "kc",
                "las vegas raiders": "lv",
                "los angeles chargers": "lac",
                "los angeles rams": "lar",
                "miami dolphins": "mia",
                "minnesota vikings": "min",
                "new england patriots": "ne",
                "new orleans saints": "no",
                "new york giants": "nyg",
                "new york jets": "nyj",
                "philadelphia eagles": "phi",
                "pittsburgh steelers": "pit",
                "san francisco 49ers": "sf",
                "seattle seahawks": "sea",
                "tampa bay buccaneers": "tb",
                "tennessee titans": "ten",
                "washington commanders": "wsh",
                // NCAAB - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "butler bulldogs": "2086",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "connecticut huskies": "41",
                "creighton bluejays": "154",
                "duke blue devils": "150",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgetown hoyas": "46",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "gonzaga bulldogs": "2250",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "indiana hoosiers": "84",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "marquette golden eagles": "269",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "miami hurricanes": "2390",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "missouri tigers": "142",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "san diego state aztecs": "21",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "syracuse orange": "183",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "villanova wildcats": "222",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275",
                "xavier musketeers": "2752",
                // NCAAF - Major Teams
                "alabama crimson tide": "333",
                "arizona wildcats": "12",
                "arizona state sun devils": "9",
                "arkansas razorbacks": "8",
                "auburn tigers": "2",
                "baylor bears": "239",
                "boise state broncos": "68",
                "boston college eagles": "103",
                "byu cougars": "252",
                "california golden bears": "25",
                "central florida knights": "2116",
                "cincinnati bearcats": "2132",
                "clemson tigers": "228",
                "colorado buffaloes": "38",
                "florida gators": "57",
                "florida state seminoles": "52",
                "georgia bulldogs": "61",
                "georgia tech yellow jackets": "59",
                "houston cougars": "248",
                "illinois fighting illini": "356",
                "iowa hawkeyes": "2294",
                "iowa state cyclones": "66",
                "kansas jayhawks": "2305",
                "kansas state wildcats": "2306",
                "kentucky wildcats": "96",
                "louisville cardinals": "97",
                "lsu tigers": "99",
                "maryland terrapins": "120",
                "memphis tigers": "235",
                "miami hurricanes": "2390",
                "michigan state spartans": "127",
                "michigan wolverines": "130",
                "minnesota golden gophers": "135",
                "mississippi state bulldogs": "344",
                "mississippi rebels": "145",
                "missouri tigers": "142",
                "nebraska cornhuskers": "158",
                "north carolina tar heels": "153",
                "north carolina state wolfpack": "152",
                "northwestern wildcats": "77",
                "notre dame fighting irish": "87",
                "ohio state buckeyes": "194",
                "oklahoma sooners": "201",
                "oklahoma state cowboys": "197",
                "oregon ducks": "2483",
                "oregon state beavers": "204",
                "penn state nittany lions": "213",
                "pittsburgh panthers": "221",
                "purdue boilermakers": "2509",
                "rutgers scarlet knights": "164",
                "south carolina gamecocks": "2579",
                "stanford cardinal": "24",
                "tcu horned frogs": "2628",
                "tennessee volunteers": "2633",
                "texas longhorns": "251",
                "texas a&m aggies": "245",
                "texas tech red raiders": "2641",
                "tulane green wave": "2655",
                "ucla bruins": "26",
                "usc trojans": "30",
                "utah utes": "254",
                "virginia cavaliers": "258",
                "virginia tech hokies": "259",
                "wake forest demon deacons": "154",
                "washington huskies": "264",
                "washington state cougars": "265",
                "west virginia mountaineers": "277",
                "wisconsin badgers": "275"
            };

            // Normalize team name: lowercase, trim, and remove extra spaces
            const normalized = teamName.toLowerCase().trim().replace(/\s+/g, ' ');
            let teamCode = teamMapping[normalized];

            // If no mapping found, try to extract from common patterns
            if (!teamCode) {
                // First, try exact matches with common short names and variations
                const shortNameMapping = {
                    "kansas": "2305",  // Kansas Jayhawks
                    "kansas jayhawks": "2305",
                    "jayhawks": "2305",
                    "arizona": "12",   // Arizona Wildcats
                    "arizona wildcats": "12",
                    "wildcats": "12",  // Could match multiple, but Arizona is most common
                    "kentucky": "96",   // Kentucky Wildcats
                    "kentucky wildcats": "96",
                    "duke": "150",     // Duke Blue Devils
                    "duke blue devils": "150",
                    "north carolina": "153",  // North Carolina Tar Heels
                    "north carolina tar heels": "153",
                    "tar heels": "153",
                    "ucla": "26",      // UCLA Bruins
                    "ucla bruins": "26",
                    "usc": "30",       // USC Trojans
                    "usc trojans": "30",
                    "texas": "251",    // Texas Longhorns
                    "texas longhorns": "251",
                    "michigan": "130", // Michigan Wolverines
                    "michigan wolverines": "130",
                    "ohio state": "194", // Ohio State Buckeyes
                    "ohio state buckeyes": "194",
                    "alabama": "333",   // Alabama Crimson Tide
                    "alabama crimson tide": "333",
                    "georgia": "61",    // Georgia Bulldogs
                    "georgia bulldogs": "61",
                    "lsu": "99",       // LSU Tigers
                    "lsu tigers": "99",
                    "florida": "57",    // Florida Gators
                    "florida gators": "57",
                    "tennessee": "2633", // Tennessee Volunteers
                    "tennessee volunteers": "2633",
                    "oklahoma": "201",  // Oklahoma Sooners
                    "oklahoma sooners": "201",
                    "oregon": "2483",   // Oregon Ducks
                    "oregon ducks": "2483",
                    "wisconsin": "275", // Wisconsin Badgers
                    "wisconsin badgers": "275",
                    "penn state": "213", // Penn State Nittany Lions
                    "penn state nittany lions": "213",
                    "notre dame": "87"  // Notre Dame Fighting Irish
                };

                // Check short name mapping
                for (const [shortName, code] of Object.entries(shortNameMapping)) {
                    if (normalized === shortName || normalized.startsWith(shortName + " ") || normalized.endsWith(" " + shortName)) {
                        teamCode = code;
                        break;
                    }
                }

                // If still not found, try to match partial names (improved logic)
                if (!teamCode) {
                    // Extract first significant word (skip common words like "the", "at", etc.)
                    const words = normalized.split(/\s+/);
                    const firstWord = words.length > 0 ? words[0] : normalized;
                    const secondWord = words.length > 1 ? words[1] : null;

                    for (const [key, code] of Object.entries(teamMapping)) {
                        // Check if normalized name is contained in key or vice versa
                        // Also check if key starts with normalized (e.g., "kansas" matches "kansas jayhawks")
                        if (normalized === key ||
                            key.startsWith(normalized + " ") ||
                            normalized.startsWith(key + " ") ||
                            key.startsWith(firstWord + " ") ||
                            (normalized.length >= 3 && key.includes(normalized)) ||
                            (key.length >= 3 && normalized.includes(key))) {
                            teamCode = code;
                            break;
                        }
                    }
                }
            }

            // Determine sport for ESPN URL
            let sportPath = "nba";
            if (sportKey) {
                if (sportKey.includes("ncaaf") || sportKey.includes("ncaab")) {
                    sportPath = "ncaa";
                } else if (sportKey.includes("football") || sportKey.includes("nfl")) {
                    sportPath = "nfl";
                } else if (sportKey.includes("hockey")) {
                    sportPath = "nhl";
                } else if (sportKey.includes("basketball") || sportKey.includes("nba")) {
                    sportPath = "nba";
                }
            }

            if (teamCode) {
                return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${teamCode}.png`;
            }

            // Fallback: try normalized name
            const fallback = normalized.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return `https://a.espncdn.com/i/teamlogos/${sportPath}/500/${fallback}.png`;
        }


        const DEFAULT_HEDGE_STAKE = 25;

        function americanToDecimal(odds) {
            if (odds === null || odds === undefined) return null;
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) return null;
            if (numOdds > 0) {
                return 1.0 + numOdds / 100.0;
            }
            return 1.0 + 100.0 / Math.abs(numOdds);
        }

        function calculateHedgeStakeAmounts(targetOdds, hedgeOdds, baseStake = DEFAULT_HEDGE_STAKE) {
            const targetDecimal = americanToDecimal(targetOdds);
            const hedgeDecimal = americanToDecimal(hedgeOdds);

            if (!targetDecimal || !hedgeDecimal) {
                return null;
            }

            const targetIsShorter = targetDecimal <= hedgeDecimal;
            const shorterDecimal = targetIsShorter ? targetDecimal : hedgeDecimal;
            const longerDecimal = targetIsShorter ? hedgeDecimal : targetDecimal;
            const shorterStake = baseStake;
            const targetPayout = shorterStake * shorterDecimal;
            const longerStake = targetPayout / longerDecimal;

            return {
                targetStake: targetIsShorter ? shorterStake : longerStake,
                hedgeStake: targetIsShorter ? longerStake : shorterStake,
            };
        }

        function formatStakeAmount(amount) {
            if (amount === null || amount === undefined || Number.isNaN(amount)) {
                return null;
            }
            return `$${Number(amount).toFixed(2)}`;
        }

        function formatOdds(odds) {
            /**
             * Format odds in American format.
             * Returns the odds as a string with proper formatting.
             */
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            // American format: Add "+" prefix for positive odds
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        function getOddsHighlightClass(odds) {
            if (odds === null || odds === undefined) return "odds-hedge-neutral";

            const numericOdds = typeof odds === "string" ? parseInt(odds, 10) : Number(odds);
            if (Number.isNaN(numericOdds)) return "odds-hedge-neutral";

            if (numericOdds <= -200) return "odds-hedge-dark-red";
            if (numericOdds < -115) return "odds-hedge-light-red";
            if (numericOdds >= 200) return "odds-hedge-dark-green";
            if (numericOdds > 115) return "odds-hedge-light-green";

            return "odds-hedge-neutral";
        }

        function renderParlayBuilderResults(data) {
            const container = document.getElementById('parlay-builder-output');
            if (!container) return;

            if (!data || !Array.isArray(data.parlay_legs) || data.parlay_legs.length === 0) {
                container.textContent = (data && data.notes && data.notes.join(' ')) || 'No parlay suggestion could be built right now.';
                return;
            }

            let html = `<div><strong>Suggested Parlay (${data.parlay_legs.length} legs)</strong></div>`;
            html += '<ol style="padding-left: 1.2rem; margin: 0.35rem 0;">';
            data.parlay_legs.forEach((leg) => {
                const hedgeText = leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom: 0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOdds(leg.book_price)})</div>
                    <div class="small-text">${leg.matchup || ''} â€¢ ${leg.market || ''} â€¢ Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';

            const baseOdds = (data.combined_american_odds !== null && data.combined_american_odds !== undefined)
                ? formatOdds(data.combined_american_odds)
                : 'â€”';
            const baseDecimal = data.combined_decimal_odds ? `${data.combined_decimal_odds.toFixed(2)}x` : 'â€”';
            const boostedOdds = (data.boosted_american_odds !== null && data.boosted_american_odds !== undefined)
                ? formatOdds(data.boosted_american_odds)
                : 'â€”';
            const boostedDecimal = data.boosted_decimal_odds ? `${data.boosted_decimal_odds.toFixed(2)}x` : 'â€”';

            html += `<div style="margin-top: 0.35rem;">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div>Boosted (${data.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;

            if (data.notes && data.notes.length) {
                html += `<div class="small-text" style="color: #fbbf24; margin-top: 0.25rem;">${data.notes.join(' ')}</div>`;
            }

            if (data.used_dummy_data) {
                html += '<div class="small-text" style="color: #f87171; margin-top: 0.25rem;">Dummy odds enabled â€” switch off "Use dummy data" to fetch live lines.</div>';
            }

            container.innerHTML = html;
        }

        function describeSgp(label, sgp) {
            if (!sgp) return '';
            let html = `<div style="margin-top: 0.4rem;"><strong>${label}</strong> (${sgp.legs.length} legs) â€” ${sgp.matchup}`;
            if (sgp.start_time) {
                html += ` â€¢ ${sgp.start_time}`;
            }
            html += '</div><ol style="padding-left: 1.2rem; margin: 0.35rem 0;">';
            sgp.legs.forEach((leg) => {
                const hedgeText = leg.hedge_ev_percent !== null && leg.hedge_ev_percent !== undefined
                    ? `${leg.hedge_ev_percent.toFixed(2)}%`
                    : `${leg.ev_percent.toFixed(2)}%`;
                html += `<li style="margin-bottom: 0.35rem;">
                    <div><strong>${leg.outcome_name}</strong> (${formatOdds(leg.book_price)})</div>
                    <div class="small-text">${leg.market || ''} â€¢ Hedge EV: ${hedgeText}</div>
                </li>`;
            });
            html += '</ol>';
            const baseOdds = (sgp.combined_american_odds !== null && sgp.combined_american_odds !== undefined)
                ? formatOdds(sgp.combined_american_odds)
                : 'â€”';
            const baseDecimal = sgp.combined_decimal_odds ? `${sgp.combined_decimal_odds.toFixed(2)}x` : 'â€”';
            const boostedOdds = (sgp.boosted_american_odds !== null && sgp.boosted_american_odds !== undefined)
                ? formatOdds(sgp.boosted_american_odds)
                : 'â€”';
            const boostedDecimal = sgp.boosted_decimal_odds ? `${sgp.boosted_decimal_odds.toFixed(2)}x` : 'â€”';
            html += `<div class="small-text">Base Odds: <strong>${baseOdds}</strong> (${baseDecimal})</div>`;
            html += `<div class="small-text">Boosted (${sgp.boost_percent}%): <strong>${boostedOdds}</strong> (${boostedDecimal})</div>`;
            if (sgp.note) {
                html += `<div class="small-text" style="color: #fbbf24;">${sgp.note}</div>`;
            }
            return html;
        }

        // Legacy function for backwards compatibility
        function formatAmericanOdds(odds) {
            return formatOdds(odds);
        }

        function createTeamNameWithLogo(teamName, sportKey = null) {
            if (!teamName) return document.createTextNode("");

            const container = document.createElement("span");
            container.className = "team-name-with-logo";

            const logo = document.createElement("img");
            logo.className = "team-logo";
            logo.src = getTeamLogoUrl(teamName, sportKey);
            logo.alt = teamName;
            logo.onerror = function () {
                // Hide logo if it fails to load
                this.style.display = "none";
            };

            const nameSpan = document.createElement("span");
            nameSpan.textContent = teamName;

            container.appendChild(logo);
            container.appendChild(nameSpan);

            return container;
        }

        function parseTeamFromOutcome(outcomeName) {
            // Extract team name from outcome (might include point spread info)
            // Examples: "New York Knicks", "New York Knicks @ -3.5"
            if (!outcomeName) return null;

            // Remove point spread info (everything after @)
            const parts = outcomeName.split(" @ ");
            return parts[0].trim();
        }

        function parseTeamsFromMatchup(matchup) {
            // Parse "Away Team @ Home Team" format
            if (!matchup) return { away: null, home: null };

            const parts = matchup.split(" @ ");
            if (parts.length === 2) {
                return { away: parts[0].trim(), home: parts[1].trim() };
            }
            return { away: matchup, home: null };
        }


        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setSummary(msg) {
            document.getElementById("summary-bar").textContent = msg;
        }

        const arbModeBtn = document.getElementById("arb-mode-btn");
        const propsModeBtn = document.getElementById("props-mode-btn");
        const arbFilterPanel = document.getElementById("arb-filter-panel");
        const propsFilterPanel = document.getElementById("props-filter-panel");
        const arbResultsPanel = document.getElementById("arb-results-panel");
        const propsResultsPanel = document.getElementById("props-results-panel");
        const watcherPanel = document.getElementById("watcher-panel");
        const builderToggleContainer = document.getElementById("builder-toggle-container");

        function setMode(mode) {
            currentMode = mode;
            const isArb = mode === "arb";

            arbModeBtn.classList.toggle("active", isArb);
            arbModeBtn.setAttribute("aria-pressed", String(isArb));
            propsModeBtn.classList.toggle("active", !isArb);
            propsModeBtn.setAttribute("aria-pressed", String(!isArb));

            arbFilterPanel.style.display = isArb ? "block" : "none";
            arbResultsPanel.style.display = isArb ? "block" : "none";
            watcherPanel.style.display = isArb ? "block" : "none";
            builderToggleContainer.style.display = isArb ? "flex" : "none";

            propsFilterPanel.style.display = isArb ? "none" : "block";
            propsResultsPanel.style.display = isArb ? "none" : "block";

            if (!isArb) {
                stopWatcher();
            }

            if (!isArb) {
                renderPlayerPropResults();
            }
        }

        function clearResults() {
            const body = document.getElementById("results-body");
            body.innerHTML = '<tr><td colspan="9" class="small-text">No results yet.</td></tr>';
            setSummary("");
            lastValueData = null;
        }

        function renderValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.plays || data.plays.length === 0) {
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || "comparison book";
                body.innerHTML = `<tr><td colspan="9" class="small-text">No arbitrage opportunities found (maybe market is empty or ${compareBookLabel} not available).</td></tr>`;
                return;
            }

            let plays = data.plays;
            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.novig_reverse_name !== null &&
                    p.novig_reverse_name !== undefined &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
            }

            if (plays.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="small-text">No plays match the current hedge filter.</td></tr>';
                return;
            }

            const currentSport = document.getElementById("sport-select").value;
            plays.forEach(play => {
                const tr = document.createElement("tr");

                const outcomeCell = document.createElement("td");
                const teamName = parseTeamFromOutcome(play.outcome_name);
                const teamWithLogo = createTeamNameWithLogo(teamName, play.sport_key || currentSport);
                outcomeCell.appendChild(teamWithLogo);
                if (play.point !== null && play.point !== undefined) {
                    const pointSpan = document.createElement("span");
                    pointSpan.textContent = " @ " + play.point;
                    outcomeCell.appendChild(pointSpan);
                }
                tr.appendChild(outcomeCell);

                const startCell = document.createElement("td");
                startCell.textContent = formatStartTime(play.start_time);
                tr.appendChild(startCell);

                const compareCell = document.createElement("td");
                const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                const formattedCompareOdds = formatOdds(play.novig_price);
                compareCell.innerHTML = `<strong>${formattedCompareOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                tr.appendChild(compareCell);

                const oppCell = document.createElement("td");
                if (play.novig_reverse_name) {
                    const oppTeamName = parseTeamFromOutcome(play.novig_reverse_name);
                    oppCell.appendChild(createTeamNameWithLogo(oppTeamName, play.sport_key || currentSport));
                } else {
                    oppCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(oppCell);

                const hedgeCell = document.createElement("td");
                if (play.novig_reverse_price !== null && play.novig_reverse_price !== undefined) {
                    const compareBookLabel = document.querySelector("#compare-book-select option:checked")?.textContent || data.compare_book || "Compare";
                    const formattedHedgeOdds = formatOdds(play.novig_reverse_price);
                    hedgeCell.innerHTML = `<strong>${formattedHedgeOdds}</strong><br><span class="small-text">@ ${compareBookLabel}</span>`;
                } else {
                    hedgeCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeCell);

                const bookCell = document.createElement("td");
                const targetBookLabel = document.querySelector("#book-select option:checked")?.textContent || data.target_book || "Target";
                const formattedBookOdds = formatOdds(play.book_price);
                bookCell.innerHTML = `<strong>${formattedBookOdds}</strong><br><span class="small-text">@ ${targetBookLabel}</span>`;
                tr.appendChild(bookCell);

                const hedgeEvCell = document.createElement("td");
                if (play.arb_margin_percent !== null && play.arb_margin_percent !== undefined) {
                    const hedgeRounded = Math.round(play.arb_margin_percent * 100) / 100;
                    const hedgeClass = hedgeRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                    hedgeEvCell.innerHTML = `<span class="${hedgeClass}">${hedgeRounded}%</span>`;
                } else {
                    hedgeEvCell.innerHTML = '<span class="small-text">-</span>';
                }
                tr.appendChild(hedgeEvCell);

                const evCell = document.createElement("td");
                const evRounded = Math.round(play.ev_percent * 100) / 100;
                let badgeClass = evRounded >= 0 ? "badge badge-positive" : "badge badge-negative";
                evCell.innerHTML = `<span class="${badgeClass}">${evRounded}%</span>`;
                tr.appendChild(evCell);


                body.appendChild(tr);
            });
        }

        function setPropsStatus(msg) {
            const bar = document.getElementById("props-status-bar");
            if (bar) bar.textContent = msg;
        }

        function setPropsSummary(msg) {
            const bar = document.getElementById("props-summary-bar");
            if (bar) bar.textContent = msg;
        }

        setPropsSummary(DEFAULT_PROPS_EMPTY_MESSAGE);
        const propsResultsBody = document.getElementById("props-results-body");
        if (propsResultsBody) {
            propsResultsBody.innerHTML = `<tr><td colspan="5" class="small-text">${DEFAULT_PROPS_EMPTY_MESSAGE}</td></tr>`;
        }

        function getSelectedPropMarkets() {
            const boxes = Array.from(document.querySelectorAll('#props-markets input[type="checkbox"]:checked'));
            const markets = boxes.map(box => box.value).filter(Boolean);
            if (!markets.length) {
                markets.push("all_player_props");
            }
            return markets;
        }

        function resetMarkets() {
            const selectedSport = document.getElementById("props-sport")?.value || "";
            renderPropMarketCheckboxes(selectedSport);
        }

        function setSelectOptions(select, options, placeholder) {
            if (!select) return;
            select.innerHTML = "";
            const frag = document.createDocumentFragment();
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.textContent = placeholder;
            frag.appendChild(placeholderOption);

            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.textContent = opt.label;
                frag.appendChild(option);
            });

            select.appendChild(frag);
        }

        function updatePropsSearchButton() {
            const sportSelected = Boolean(document.getElementById("props-sport")?.value);
            const searchBtn = document.getElementById("props-search-btn");

            if (!searchBtn) return;

            searchBtn.disabled = !sportSelected;
            searchBtn.title = sportSelected ? "" : "Select sport from drop down";
        }

        function formatPropsGameLabel(game) {
            const matchup = game.matchup || `${game.away_team || ""} @ ${game.home_team || ""}`.trim();
            const startLabel = formatStartTime(game.start_time || game.commence_time);
            return startLabel ? `${matchup} â€¢ ${startLabel}` : matchup || "Upcoming game";
        }

        async function loadPropsGames() {
            const sport = document.getElementById("props-sport").value;
            const gameSelect = document.getElementById("props-game");
            const teamSelect = document.getElementById("props-team");
            const playerSelect = document.getElementById("props-player");
            const useDummyData = document.getElementById("dummy-data-checkbox")?.checked;

            if (!sport) {
                setSelectOptions(gameSelect, [], "All Games");
                setSelectOptions(teamSelect, [], "All Teams");
                setSelectOptions(playerSelect, [], "All Players");
                return;
            }

            setPropsStatus("Loading games and teams...");
            try {
                const res = await fetch("/api/player-props/games", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sport_key: sport, use_dummy_data: useDummyData })
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                const data = await res.json();
                const games = Array.isArray(data?.games) ? data.games : [];

                const gameOptions = games.map(game => ({
                    value: game.event_id,
                    label: formatPropsGameLabel(game)
                }));
                setSelectOptions(gameSelect, gameOptions, "All Games");

                const teams = new Set();
                games.forEach(game => {
                    if (game.home_team) teams.add(game.home_team);
                    if (game.away_team) teams.add(game.away_team);
                });
                setSelectOptions(teamSelect, Array.from(teams).map(team => ({ value: team, label: team })), "All Teams");
                setSelectOptions(playerSelect, [], "All Players");
            } catch (err) {
                console.error(err);
                setPropsStatus(`Couldn't load games: ${err.message}`);
            }
        }

        async function fetchPlayerProps() {
            setPropsStatus("Loading player props...");

            const sportKey = document.getElementById("props-sport").value;
            if (!sportKey) {
                setPropsStatus("Pick a sport before searching player props.");
                return;
            }

            hasRunPropsSearch = true;

            const payload = {
                sport_key: sportKey,
                team: document.getElementById("props-team").value || null,
                player_name: document.getElementById("props-player").value || null,
                event_id: document.getElementById("props-game").value || null,
                markets: getSelectedPropMarkets(),
                target_book: document.getElementById("props-target").value,
                compare_book: document.getElementById("props-compare").value,
                use_dummy_data: document.getElementById("dummy-data-checkbox")?.checked,
            };

            try {
                const res = await fetch("/api/player-props", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                propsData = await res.json();
                const count = Array.isArray(propsData?.plays) ? propsData.plays.length : 0;
                setPropsStatus(`Loaded ${count} player prop results.`);
                renderPlayerPropResults();
            } catch (err) {
                console.error(err);
                setPropsStatus(`Error loading player props: ${err.message}`);
                propsData = { plays: [] };
                renderPlayerPropResults();
            }
        }

        async function fetchAllSportsPlayerProps() {
            const button = document.getElementById("props-all-sports-btn");
            setPropsStatus("Scanning all sports for player prop arbitrage vs Novig...");
            if (button) button.disabled = true;

            hasRunPropsSearch = true;

            try {
                const res = await fetch("/api/player-props/arbitrage-all", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        use_dummy_data: document.getElementById("dummy-data-checkbox")?.checked,
                        max_results: 150,
                    }),
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || `HTTP ${res.status}`);
                }

                propsData = await res.json();
                const count = Array.isArray(propsData?.plays) ? propsData.plays.length : 0;
                renderPlayerPropResults();

                const targetSummary = (propsData?.target_books || [])
                    .map(getBookLabel)
                    .filter(Boolean)
                    .join(", ") || "DraftKings, FanDuel, Fliff";
                const compareSummary = getBookLabel(propsData?.compare_book) || "Novig";
                setPropsSummary(`Found ${count} player prop arbitrage plays across all sports. Targets: ${targetSummary}; Hedge: ${compareSummary}.`);
                setPropsStatus("Done.");
            } catch (err) {
                console.error(err);
                setPropsStatus(`Error loading all-sports player props: ${err.message}`);
                propsData = { plays: [] };
                renderPlayerPropResults();
            } finally {
                if (button) button.disabled = false;
            }
        }

        function renderPlayerPropResults() {
            const body = document.getElementById("props-results-body");
            body.innerHTML = "";

            const plays = Array.isArray(propsData?.plays) ? propsData.plays : [];
            if (!hasRunPropsSearch || !plays.length) {
                const message = hasRunPropsSearch
                    ? "No player prop value plays found."
                    : DEFAULT_PROPS_EMPTY_MESSAGE;
                body.innerHTML = `<tr><td colspan="5" class="small-text">${message}</td></tr>`;
                setPropsSummary(message);
                return;
            }

            const targetBookLabel = document.querySelector("#props-target option:checked")?.textContent || "Target book";
            const compareBookLabel = document.querySelector("#props-compare option:checked")?.textContent || "Compare book";
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "baseball_mlb": "MLB",
                "icehockey_nhl": "NHL"
            };

            const sorted = sortPlaysByArbitrageMargin(plays, "desc");
            const playsWithStake = sorted.map(play => {
                const hedgeStakeAmounts = TableRenderers.helpers.calculateHedgeStakeAmounts(play.book_price, play.novig_reverse_price);
                return {
                    ...play,
                    targetLabel: getBookLabel(play.target_book) || targetBookLabel,
                    compareLabel: getBookLabel(play.compare_book) || compareBookLabel,
                    targetStakeText: hedgeStakeAmounts ? TableRenderers.helpers.formatStakeAmount(hedgeStakeAmounts.targetStake) : null,
                    hedgeStakeText: hedgeStakeAmounts ? TableRenderers.helpers.formatStakeAmount(hedgeStakeAmounts.hedgeStake) : null,
                };
            });

            TableRenderers.renderPropRows(body, playsWithStake, {
                targetBookLabel,
                compareBookLabel,
                sportLabels,
                marketLabelGetter: (key) => key,
                startTimeFormatter: TableRenderers.helpers.formatStartTime,
                oddsFormatter: TableRenderers.helpers.formatOddsWithColor,
                hedgeOddsFormatter: TableRenderers.helpers.formatOddsWithColor,
                emptyMessage: "No player prop value plays found.",
            });

            setPropsSummary(`Showing ${playsWithStake.length} player prop results.`);
        }

        function renderValueFromState() {
            if (!lastValueData) return;
            renderValuePlays(lastValueData, filterHedgeOnly);
        }

        async function fetchValuePlays(singleRun = false) {
            const sport = document.getElementById("sport-select").value;
            const market = document.getElementById("market-select").value;
            const book = document.getElementById("book-select").value;
            const compareBook = document.getElementById("compare-book-select").value;
            const maxResults = Number(document.getElementById("max-results-input").value) || 25;

            if (book === compareBook) {
                setStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            if (singleRun) {
                // Don't wipe lastValueData instantly; let new data overwrite.
                setSummary("");
            }
            setStatus("Fetching arbitrage opportunities...");
            try {
                const res = await fetch("/api/value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sport,
                        market,
                        target_book: book,
                        compare_book: compareBook,
                        max_results: maxResults
                    }),
                });
                if (!res.ok) {
                    if (res.status === 404) {
                        const message = "Search was correct, but no markets were found at the moment.";
                        alert(message);
                        setBestStatus(message);
                        return;
                    }

                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastValueData = data;
                renderValueFromState();

                const playsCount = (data.plays || []).length;
                const compareBookLabel = document.querySelector("#compare-book-select option:checked").textContent;
                setSummary(`Showing top ${playsCount} arbitrage opportunities for ${book} in market "${market}" vs ${compareBookLabel}. Filter: ${filterHedgeOnly ? "Hedgeable only" : "All"}.`);
                setStatus("Done.");
            } catch (e) {
                console.error(e);
                setStatus("Error: " + e.message);
            }
        }

        function startValueLoop() {
            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }

            setStatus("Watching for arbitrage opportunities...");
            document.getElementById("start-loop-btn").disabled = true;
            document.getElementById("find-btn").disabled = true;
            document.getElementById("stop-loop-btn").disabled = false;

            // initial fetch
            fetchValuePlays(true);
            valuePollTimer = setInterval(() => fetchValuePlays(false), intervalMs);
        }

        function stopValueLoop() {
            if (valuePollTimer) {
                clearInterval(valuePollTimer);
                valuePollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-loop-btn").disabled = false;
            document.getElementById("find-btn").disabled = false;
            document.getElementById("stop-loop-btn").disabled = true;
        }

        function toggleHedgeFilter() {
            filterHedgeOnly = !filterHedgeOnly;
            const btn = document.getElementById("filter-opp-btn");
            if (filterHedgeOnly) {
                btn.classList.add("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (ON)";
            } else {
                btn.classList.remove("toggle-on");
                btn.textContent = "Filter: Hedgeable Only (OFF)";
            }
            renderValueFromState();
        }

        // Arbitrage Finder Functions
        function setBestStatus(msg) {
            document.getElementById("best-status-bar").textContent = msg;
        }

        function setBestSummary(msg) {
            document.getElementById("best-summary-bar").textContent = msg;
        }

        function clearBestResults() {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            document.getElementById("best-results-section").style.display = "none";
            setBestSummary("");
        }

        function renderBestValuePlays(data, hedgeOnly = false) {
            const body = document.getElementById("best-results-body");
            body.innerHTML = "";
            const section = document.getElementById("best-results-section");
            section.style.display = "block";

            if (!data || !data.plays || data.plays.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="small-text">No arbitrage opportunities found.</td></tr>';
                return;
            }

            let plays = data.plays;

            if (hedgeOnly) {
                plays = plays.filter(p =>
                    p.arb_margin_percent !== null &&
                    p.arb_margin_percent !== undefined &&
                    p.arb_margin_percent >= 0 &&
                    p.novig_reverse_price !== null &&
                    p.novig_reverse_price !== undefined
                );
                if (plays.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="small-text">No hedge opportunities found (arbitrage margin â‰¥ 0%).</td></tr>';
                    return;
                }
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const marketLabels = {
                "h2h": "Moneyline",
                "spreads": "Spreads",
                "totals": "Totals"
            };

            const sortedPlays = getSortedArbitragePlays(plays);
            TableRenderers.renderArbRows(body, sortedPlays, {
                includeSportColumn: true,
                sportLabels,
                marketLabels,
                targetBookLabel: document.querySelector("#best-target-book-select option:checked")?.textContent || data.target_book || "Target",
                compareBookLabel: document.querySelector("#best-compare-book-select option:checked")?.textContent || data.compare_book || "Compare",
                emptyMessage: hedgeOnly
                    ? "No hedge opportunities found (arbitrage margin â‰¥ 0%)."
                    : "No arbitrage opportunities found.",
                showLogos: true,
                oddsFormatter: formatOdds,
                oddsHighlightClassGetter: getOddsHighlightClass,
                startTimeFormatter: formatStartTime,
                hedgeStakeCalculator: calculateHedgeStakeAmounts,
                stakeFormatter: formatStakeAmount,
                getTeamLogoUrl,
                parseTeamFromOutcome,
                parseTeamsFromMatchup,
            });
        }

        // Request browser notification permission
        async function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                await Notification.requestPermission();
            }
        }

        // Show browser notification for hedge opportunities
        function showHedgeAlert(play) {
            if (!("Notification" in window)) {
                console.log("Browser does not support notifications");
                return;
            }

            if (Notification.permission !== "granted") {
                return;
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            const notification = new Notification(`Hedge Opportunity Found! (${margin}%)`, {
                body: `${sportLabel}: ${teamName} ${bookOdds} vs Hedge ${hedgeOdds}\n${play.matchup || ""}`,
                icon: getTeamLogoUrl(teamName, play.sport_key) || undefined,
                tag: `hedge-${play.event_id}-${play.outcome_name}`, // Prevent duplicate notifications
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                notification.close();
            };
        }

        // Generate unique ID for a play to track alerts
        function getPlayId(play) {
            return `${play.event_id}-${play.outcome_name}-${play.book_price}-${play.novig_reverse_price}`;
        }

        // Send SMS alert
        async function sendSMSAlert(play) {
            const phoneInput = document.getElementById("sms-phone-input");
            const phone = phoneInput ? phoneInput.value.trim() : "";

            if (!phone) {
                return; // No phone number configured, skip SMS
            }

            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "icehockey_nhl": "NHL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };

            const sportLabel = sportLabels[play.sport_key] || play.sport_key;
            const teamName = parseTeamFromOutcome(play.outcome_name);
            const margin = Math.round(play.arb_margin_percent * 100) / 100;
            const bookOdds = formatOdds(play.book_price);
            const hedgeOdds = play.novig_reverse_price ? formatOdds(play.novig_reverse_price) : "N/A";

            // Format message (SMS has 160 char limit, so keep it concise)
            const message = `Hedge Alert! ${sportLabel}: ${teamName} ${bookOdds} vs ${hedgeOdds} (${margin}% margin). ${play.matchup || ""}`;

            try {
                const response = await fetch("/api/send-sms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone: phone,
                        message: message
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("SMS send failed:", error.detail || "Unknown error");
                } else {
                    const result = await response.json();
                    console.log("SMS sent successfully. Quota remaining:", result.quotaRemaining);
                }
            } catch (error) {
                console.error("Error sending SMS:", error);
            }
        }

        // Check for new hedge opportunities and alert
        function checkForHedgeAlerts(plays) {
            if (!plays || plays.length === 0) return;

            plays.forEach(play => {
                const marginPercent = play.arb_margin_percent;
                // Only alert for plays with arbitrage margin >= 0
                if (marginPercent !== null &&
                    marginPercent !== undefined &&
                    marginPercent >= 0 &&
                    play.novig_reverse_price !== null &&
                    play.novig_reverse_price !== undefined) {

                    const playId = getPlayId(play);
                    const meetsSmsThreshold = marginPercent >= getSmsMarginThreshold();

                    // Only alert if we haven't seen this play before
                    if (!alertedPlayIds.has(playId)) {
                        alertedPlayIds.add(playId);
                        showHedgeAlert(play);
                    }

                    if (meetsSmsThreshold && !smsAlertedPlayIds.has(playId)) {
                        smsAlertedPlayIds.add(playId);
                        sendSMSAlert(play); // Send SMS alert
                    }
                }
            });
        }

        async function buildParlayRecommendation() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const boostPercent = getPromoBoostPercent();

            showBuilderResultsSection();

            if (sportCheckboxes.length === 0) {
                setBuilderStatus("Select at least one sport to build a parlay.");
                return;
            }
            if (marketCheckboxes.length === 0) {
                setBuilderStatus("Select at least one market to build a parlay.");
                return;
            }
            if (targetBook === compareBook) {
                setBuilderStatus("Target book and comparison book must differ for parlay building.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);

            setBuilderStatus("Building parlay from highest hedge EV plays...");

            try {
                const res = await loggedFetch("/api/parlay-builder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        parlay_size: 3,
                        boost_percent: boostPercent,
                        use_dummy_data: useDummyData
                    })
                }, 'parlay-builder');

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || (`HTTP ${res.status}`));
                }

                const data = await res.json();
                renderParlayBuilderResults(data);
                setBuilderStatus(`Built parlay using ${data.parlay_legs?.length || 0} legs with a ${boostPercent}% boost.`);
            } catch (err) {
                setBuilderStatus(`Parlay builder failed: ${err.message || err}`);
            }
        }

        async function buildSgpRecommendation() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const boostPercent = getPromoBoostPercent();

            if (sportCheckboxes.length !== 1) {
                setBuilderStatus("Pick exactly one sport to scan for SGP player props.");
                return;
            }
            if (targetBook === compareBook) {
                setBuilderStatus("Target book and comparison book must differ for SGP building.");
                return;
            }

            const sportKey = sportCheckboxes[0].value;
            setBuilderStatus("Searching player props for SGP legs...");

            try {
                const res = await loggedFetch("/api/sgp-builder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_key: sportKey,
                        target_book: targetBook,
                        compare_book: compareBook,
                        boost_percent: boostPercent,
                        use_dummy_data: useDummyData,
                        avoid_correlation: true,
                        ...getSgpOddsRangeFilters()
                    })
                }, 'sgp-builder');

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || (`HTTP ${res.status}`));
                }

                const data = await res.json();
                renderSGPBuilderResults(data);
                setBuilderStatus("Updated SGP recommendations using hedge EV player props.");
            } catch (err) {
                setBuilderStatus(`SGP builder failed: ${err.message || err}`);
            }
        }

        async function fetchBestValuePlays() {
            const sportCheckboxes = document.querySelectorAll(".sport-checkbox:checked");
            const marketCheckboxes = document.querySelectorAll(".market-checkbox:checked");
            const targetBook = document.getElementById("best-target-book-select").value;
            const compareBook = document.getElementById("best-compare-book-select").value;
            const maxResults = Number(document.getElementById("best-max-results-input").value) || 50;
            const useDummyData = document.getElementById("dummy-data-checkbox").checked;
            const shouldLogResults = document.getElementById("log-results-checkbox").checked;

            if (sportCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one sport.");
                return;
            }

            if (marketCheckboxes.length === 0) {
                setBestStatus("Error: Please select at least one market.");
                return;
            }

            if (targetBook === compareBook) {
                setBestStatus("Error: Target book and comparison book cannot be the same.");
                return;
            }

            const sportKeys = Array.from(sportCheckboxes).map(cb => cb.value);
            const markets = Array.from(marketCheckboxes).map(cb => cb.value);
            const isWatcherRunning = watcherTimer !== null;
            const shouldLogThisSearch = shouldLogResults && !isWatcherRunning;

            // Only clear results if watcher is not running (to avoid flickering during updates)
            if (!isWatcherRunning) {
                clearBestResults();
            }

            if (isWatcherRunning) {
                setBestStatus("Watcher: Checking for hedge opportunities...");
            } else {
                setBestStatus("Searching for arbitrage opportunities across sports and markets...");
            }
            if (useDummyData) {
                setBestStatus((isWatcherRunning ? "Watcher: Checking for hedge opportunities..." : "Searching for arbitrage opportunities across sports and markets...") + " [DUMMY DATA MODE]");
            }

            try {
                // When watcher is running, we can request fewer results since we only care about hedge opportunities
                // The API already sorts by arb_margin_percent, so top results are most likely to be hedge opportunities
                const requestMaxResults = isWatcherRunning ? maxResults : maxResults * 2;

                const res = await loggedFetch("/api/best-value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: sportKeys,
                        markets: markets,
                        target_book: targetBook,
                        compare_book: compareBook,
                        max_results: requestMaxResults,
                        use_dummy_data: useDummyData
                    }),
                }, 'best-value-plays');
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || ("HTTP " + res.status));
                }
                const data = await res.json();
                lastBestValueData = data;

                if (shouldLogThisSearch) {
                    logSearchResultsToFile(data, {
                        sportKeys,
                        markets,
                        targetBook,
                        compareBook,
                        maxResults: requestMaxResults,
                        useDummyData
                    });
                }

                // If watcher is running, filter to show only hedge opportunities
                renderBestValuePlays(data, isWatcherRunning);

                // Check for hedge alerts if watcher is running
                if (isWatcherRunning) {
                    const hedgePlays = (data.plays || []).filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    );
                    checkForHedgeAlerts(data.plays);

                    const watcherStatusBar = document.getElementById("watcher-status-bar");
                    const intervalVal = Number(document.getElementById("watcher-interval-input").value) || 60;
                    const newAlerts = hedgePlays.filter(p => !alertedPlayIds.has(getPlayId(p))).length;
                    if (newAlerts > 0) {
                        watcherStatusBar.textContent = `ðŸ”” Found ${hedgePlays.length} hedge opportunities (${newAlerts} new alerts!). Next check in ${intervalVal}s...`;
                    } else {
                        watcherStatusBar.textContent = `Watching... Found ${hedgePlays.length} hedge opportunities. Next check in ${intervalVal}s...`;
                    }
                }

                let playsCount = (data.plays || []).length;
                if (isWatcherRunning) {
                    // Count only hedge opportunities when watcher is running
                    playsCount = data.plays.filter(p =>
                        p.arb_margin_percent !== null &&
                        p.arb_margin_percent !== undefined &&
                        p.arb_margin_percent >= 0 &&
                        p.novig_reverse_price !== null &&
                        p.novig_reverse_price !== undefined
                    ).length;
                }
                const compareBookLabel = document.querySelector("#best-compare-book-select option:checked").textContent;
                const sortLabel = getArbitrageSortLabel();
                if (isWatcherRunning) {
                    setBestSummary(`Hedge Watcher: Showing ${playsCount} hedge opportunities (arbitrage margin â‰¥ 0%) across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by ${sortLabel} (vs ${compareBookLabel}).`);
                } else {
                    setBestSummary(`Found ${playsCount} arbitrage opportunities across ${sportKeys.length} sport(s) and ${markets.length} market(s). Sorted by ${sortLabel} (vs ${compareBookLabel}).`);
                }
                setBestStatus(isWatcherRunning ? "Watcher: Updated." : "Done.");
            } catch (e) {
                console.error(e);
                setBestStatus("Error: " + e.message);
            }
        }

        // Save form selections to localStorage
        function saveFormSelections() {
            const selections = {
                sports: Array.from(document.querySelectorAll(".sport-checkbox:checked")).map(cb => cb.value),
                markets: Array.from(document.querySelectorAll(".market-checkbox:checked")).map(cb => cb.value),
                targetBook: document.getElementById("best-target-book-select").value,
                compareBook: document.getElementById("best-compare-book-select").value,
                maxResults: document.getElementById("best-max-results-input").value,
                dummyData: document.getElementById("dummy-data-checkbox").checked,
                logResults: document.getElementById("log-results-checkbox").checked,
                watcherInterval: document.getElementById("watcher-interval-input").value,
                smsThreshold: document.getElementById("sms-threshold-input").value
            };
            localStorage.setItem("arbitrageFinderSelections", JSON.stringify(selections));
        }

        // Load form selections from localStorage
        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("arbitrageFinderSelections");
                if (!saved) return;

                const selections = JSON.parse(saved);

                // Restore sports checkboxes
                if (selections.sports && Array.isArray(selections.sports)) {
                    document.querySelectorAll(".sport-checkbox").forEach(cb => {
                        cb.checked = selections.sports.includes(cb.value);
                    });
                }

                // Restore markets checkboxes
                if (selections.markets && Array.isArray(selections.markets)) {
                    document.querySelectorAll(".market-checkbox").forEach(cb => {
                        cb.checked = selections.markets.includes(cb.value);
                    });
                }

                // Restore selects
                if (selections.targetBook) {
                    document.getElementById("best-target-book-select").value = selections.targetBook;
                }
                if (selections.compareBook) {
                    document.getElementById("best-compare-book-select").value = selections.compareBook;
                }
                if (selections.maxResults) {
                    document.getElementById("best-max-results-input").value = selections.maxResults;
                }
                if (selections.dummyData !== undefined) {
                    document.getElementById("dummy-data-checkbox").checked = selections.dummyData;
                }
                if (selections.logResults !== undefined) {
                    document.getElementById("log-results-checkbox").checked = selections.logResults;
                }
                if (selections.watcherInterval) {
                    document.getElementById("watcher-interval-input").value = selections.watcherInterval;
                }
                if (selections.smsThreshold !== undefined) {
                    document.getElementById("sms-threshold-input").value = selections.smsThreshold;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        // Credits display functions
        async function fetchCredits() {
            try {
                const response = await fetch("/api/credits");
                if (!response.ok) {
                    throw new Error("Failed to fetch credits");
                }
                const data = await response.json();
                updateCreditsDisplay(data);
            } catch (error) {
                console.error("Error fetching credits:", error);
                document.getElementById("api-credits").textContent = "API: Error";
            }
        }

        function updateCreditsDisplay(data) {
            const apiCreditsEl = document.getElementById("api-credits");

            if (data.api_credits) {
                const credits = data.api_credits;
                const percentage = (credits.used / credits.total) * 100;
                let className = "credits-high";
                if (percentage >= 90) {
                    className = "credits-low";
                } else if (percentage >= 70) {
                    className = "credits-medium";
                }
                apiCreditsEl.textContent = `API: ${credits.display}`;
                apiCreditsEl.className = className;
            } else {
                apiCreditsEl.textContent = "API: N/A";
                apiCreditsEl.className = "";
            }
        }

        // Refresh credits every 5 minutes
        function startCreditsRefresh() {
            fetchCredits(); // Initial fetch
            setInterval(fetchCredits, 5 * 60 * 1000); // Refresh every 5 minutes
        }

        // Smooth page navigation with fade transition
        function smoothNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 300); // Match the CSS transition duration
        }

        // Fade in on page load
        function fadeInPage() {
            requestAnimationFrame(() => {
                document.body.classList.add('fade-in');
            });
        }

        // Handle both initial load and back/forward navigation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fadeInPage);
        } else {
            fadeInPage();
        }

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was loaded from cache (back/forward navigation)
                document.body.classList.remove('fade-in');
                requestAnimationFrame(() => {
                    document.body.classList.add('fade-in');
                });
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            // Set up smooth navigation for all smooth-nav links
            document.querySelectorAll('.smooth-nav').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = link.getAttribute('data-href') || link.getAttribute('href');
                    if (url) {
                        smoothNavigate(url);
                    }
                });
            });

            // Mark the current page button as active (Bet Watcher button should not be active on this page)
            const watcherButton = document.querySelector('.top-right-buttons .smooth-nav[data-href="/watcher.html"]');
            if (watcherButton) {
                watcherButton.classList.remove('active');
            }

            // Start credits refresh
            startCreditsRefresh();

            // Load sports schema, then restore saved form selections and attach listeners
            fetchAndRenderSports().then(() => {
                try {
                    loadFormSelections();
                    document.getElementById('toggle-all-sports-btn').addEventListener('click', () => {
                        showAllSportsMode = !showAllSportsMode;
                        const btn = document.getElementById('toggle-all-sports-btn');
                        btn.textContent = showAllSportsMode ? 'Show Active Only' : 'Show All Sports';
                        btn.style.backgroundColor = showAllSportsMode ? '#e8f5e9' : '#f0f0f0';
                        fetchAndRenderSports(showAllSportsMode);
                    });
                } catch (e) {
                    appendClientLog('loadFormSelections failed: ' + (e.message || e));
                }

                // Save form selections when they change
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
                document.getElementById("best-target-book-select").addEventListener("change", saveFormSelections);
                document.getElementById("best-compare-book-select").addEventListener("change", saveFormSelections);
                document.getElementById("best-max-results-input").addEventListener("change", saveFormSelections);
                document.getElementById("dummy-data-checkbox").addEventListener("change", saveFormSelections);
                document.getElementById("log-results-checkbox").addEventListener("change", saveFormSelections);
                document.getElementById("watcher-interval-input").addEventListener("change", saveFormSelections);
                document.getElementById("sms-threshold-input").addEventListener("change", saveFormSelections);
            }).catch((err) => {
                appendClientLog('Failed to render sports schema: ' + (err.message || err));
                // Fallback: still attempt to load selections and attach listeners to any existing controls
                try { loadFormSelections(); } catch (e) { /* ignore */ }
                document.querySelectorAll(".sport-checkbox, .market-checkbox").forEach(el => {
                    el.addEventListener("change", saveFormSelections);
                });
            });

            // Load dummy data setting from localStorage
            const dummyDataCheckbox = document.getElementById("dummy-data-checkbox");
            const savedDummyData = localStorage.getItem("useDummyData");
            if (savedDummyData === "true") {
                dummyDataCheckbox.checked = true;
            }

            // Save dummy data setting to localStorage when changed
            dummyDataCheckbox.addEventListener("change", (e) => {
                localStorage.setItem("useDummyData", e.target.checked ? "true" : "false");
            });

            // Load and save SMS phone number from localStorage
            const smsPhoneInput = document.getElementById("sms-phone-input");
            const savedPhone = localStorage.getItem("smsPhoneNumber");
            if (savedPhone && smsPhoneInput) {
                smsPhoneInput.value = savedPhone;
            }
            if (smsPhoneInput) {
                smsPhoneInput.addEventListener("change", (e) => {
                    localStorage.setItem("smsPhoneNumber", e.target.value);
                });
            }

            // Arbitrage Finder buttons
            document.getElementById("find-best-btn").onclick = fetchBestValuePlays;
            document.getElementById("clear-best-btn").onclick = clearBestResults;
            document.getElementById("build-parlay-btn").onclick = buildParlayRecommendation;

            const builderToggleBtn = document.getElementById("builder-results-toggle");
            if (builderToggleBtn) {
                builderToggleBtn.addEventListener("click", toggleBuilderResultsSection);
            }
            hideBuilderResultsSection(true);

            // Arbitrage finder book validation
            const bestTargetBook = document.getElementById("best-target-book-select");
            const bestCompareBook = document.getElementById("best-compare-book-select");

            function validateBestBookSelection() {
                if (bestTargetBook.value === bestCompareBook.value) {
                    setBestStatus("Error: Target book and comparison book cannot be the same.");
                    return false;
                }
                return true;
            }

            bestTargetBook.addEventListener("change", validateBestBookSelection);
            bestCompareBook.addEventListener("change", validateBestBookSelection);

            // Watcher functionality
            const watcherIntervalInput = document.getElementById("watcher-interval-input");
            const startWatcherBtn = document.getElementById("start-watcher-btn");
            const stopWatcherBtn = document.getElementById("stop-watcher-btn");
            const watcherStatusBar = document.getElementById("watcher-status-bar");

            // Request notification permission on page load
            requestNotificationPermission();

            function startWatcher() {
                const intervalVal = Number(watcherIntervalInput.value) || 60;
                const intervalMs = Math.max(intervalVal, 30) * 1000; // min 30 seconds

                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }

                // Validate book selection
                if (!validateBestBookSelection()) {
                    return;
                }

                // Clear previous alerts when starting fresh
                alertedPlayIds.clear();
                smsAlertedPlayIds.clear();

                watcherStatusBar.textContent = `Starting watcher... Checking for hedge opportunities every ${intervalVal}s...`;
                startWatcherBtn.disabled = true;
                stopWatcherBtn.disabled = false;
                document.getElementById("find-best-btn").disabled = true;

                // Show results section
                document.getElementById("best-results-section").style.display = "block";

                // Initial fetch
                fetchBestValuePlays();

                // Set up polling with error handling
                watcherTimer = setInterval(async () => {
                    try {
                        await fetchBestValuePlays();
                    } catch (error) {
                        console.error("Watcher error:", error);
                        watcherStatusBar.textContent = `Error: ${error.message}. Retrying in ${intervalVal}s...`;
                    }
                }, intervalMs);
            }

            stopWatcher = function stopWatcher() {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                    watcherTimer = null;
                }
                watcherStatusBar.textContent = "Watcher stopped.";
                startWatcherBtn.disabled = false;
                stopWatcherBtn.disabled = true;
                document.getElementById("find-best-btn").disabled = false;

                // Re-render results without hedge filter when watcher stops
                if (lastBestValueData) {
                    renderBestValuePlays(lastBestValueData, false);
                }
            }

            startWatcherBtn.onclick = startWatcher;
            stopWatcherBtn.onclick = stopWatcher;

            const oddsSortBtn = document.getElementById("best-odds-sort-btn");
            if (oddsSortBtn) {
                updateOddsSortButtonLabel();
                oddsSortBtn.addEventListener("click", () => {
                    if (arbitrageSortMode === "arb-margin") {
                        arbitrageSortMode = "odds";
                        recommendedOddsSortDirection = "desc";
                    } else if (recommendedOddsSortDirection === "desc") {
                        recommendedOddsSortDirection = "asc";
                    } else {
                        arbitrageSortMode = "arb-margin";
                        recommendedOddsSortDirection = "desc";
                    }

                    saveRecommendedOddsSortDirection(recommendedOddsSortDirection);
                    updateOddsSortButtonLabel();

                    if (lastBestValueData) {
                        renderBestValuePlays(lastBestValueData, watcherTimer !== null);
                    }
                });
            }

            arbModeBtn.addEventListener("click", () => setMode("arb"));
            propsModeBtn.addEventListener("click", () => setMode("props"));
            document.getElementById("props-sport").addEventListener("change", (event) => {
                const sport = event.target.value;
                renderPropMarketCheckboxes(sport);
                updatePropsSearchButton();
                loadPropsGames();
            });
            document.getElementById("props-search-btn").addEventListener("click", (e) => {
                e.preventDefault();
                setMode("props");
                fetchPlayerProps();
            });

            document.getElementById("props-all-sports-btn").addEventListener("click", (e) => {
                e.preventDefault();
                setMode("props");
                fetchAllSportsPlayerProps();
            });

            document.getElementById("props-reset-btn").addEventListener("click", () => {
                document.getElementById("props-sport").value = "";
                setSelectOptions(document.getElementById("props-game"), [], "All Games");
                setSelectOptions(document.getElementById("props-team"), [], "All Teams");
                setSelectOptions(document.getElementById("props-player"), [], "All Players");
                resetMarkets();
                propsData = null;
                hasRunPropsSearch = false;
                renderPlayerPropResults();
                setPropsStatus("Ready.");
                setPropsSummary(DEFAULT_PROPS_EMPTY_MESSAGE);
                updatePropsSearchButton();
            });

            // Initialize player props filters on load (ensures games list populates when a sport is preselected)
            resetMarkets();
            loadPropsGames();
            updatePropsSearchButton();

            setMode("arb");

            // Test SMS functionality
            const testSmsBtn = document.getElementById("test-sms-btn");
            const testSmsStatus = document.getElementById("test-sms-status");

            async function sendTestSMS() {
                const phoneInput = document.getElementById("sms-phone-input");
                const phone = phoneInput ? phoneInput.value.trim() : "";

                if (!phone) {
                    testSmsStatus.style.display = "block";
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = "Please enter a phone number first.";
                    return;
                }

                testSmsStatus.style.display = "block";
                testSmsStatus.style.color = "#94a3b8";
                testSmsStatus.textContent = "Sending test SMS...";
                testSmsBtn.disabled = true;

                const testMessage = "Test alert from Arbitrage Bet Finder - SMS notifications are working!";

                try {
                    const response = await fetch("/api/send-sms", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            phone: phone,
                            message: testMessage
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        testSmsStatus.style.color = "#bbf7d0";
                        testSmsStatus.textContent = `âœ… Test SMS sent successfully! Quota remaining: ${result.quotaRemaining || "N/A"}`;
                    } else {
                        testSmsStatus.style.color = "#fecaca";
                        testSmsStatus.textContent = `âŒ Failed: ${result.detail || result.error || "Unknown error"}`;
                    }
                } catch (error) {
                    testSmsStatus.style.color = "#fecaca";
                    testSmsStatus.textContent = `âŒ Error: ${error.message}`;
                } finally {
                    testSmsBtn.disabled = false;
                }
            }

            testSmsBtn.onclick = sendTestSMS;

            // Clean up on page unload
            window.addEventListener("beforeunload", () => {
                if (watcherTimer) {
                    clearInterval(watcherTimer);
                }
            });

            // Toggle panel functionality
            const toggleWatcherBtn = document.getElementById("toggle-watcher-btn");
            const watcherPanel = document.getElementById("watcher-panel");

            // Load toggle states from localStorage
            const watcherVisible = localStorage.getItem("watcherVisible") === "true";

            // Set initial states
            if (watcherVisible) {
                watcherPanel.classList.add("open");
                toggleWatcherBtn.classList.add("active");
                document.body.classList.add("watcher-open");
            }

            // Toggle watcher panel
            toggleWatcherBtn.onclick = () => {
                const isOpen = watcherPanel.classList.contains("open");
                if (isOpen) {
                    watcherPanel.classList.remove("open");
                    toggleWatcherBtn.classList.remove("active");
                    document.body.classList.remove("watcher-open");
                    localStorage.setItem("watcherVisible", "false");
                } else {
                    watcherPanel.classList.add("open");
                    toggleWatcherBtn.classList.add("active");
                    document.body.classList.add("watcher-open");
                    localStorage.setItem("watcherVisible", "true");
                }
            };


        });
    </script>
</body>

</html>