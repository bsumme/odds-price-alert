<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Bet Watcher Web</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }

        header {
            padding: 1rem 1.5rem;
            background: #0f172a;
            border-bottom: 1px solid #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.3rem;
        }

        header nav a {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.85rem;
            margin-left: 0.75rem;
        }

        header nav a:hover {
            color: #e5e7eb;
        }

        header nav a.active {
            color: #e5e7eb;
            font-weight: 500;
        }

        main {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
            gap: 1.5rem;
        }

        .card {
            background: #020617;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.6rem;
            margin-bottom: 0.15rem;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.9rem;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .book-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .book-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0;
        }

        .btn {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.9rem;
            font-size: 0.9rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-top: 0.75rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #374151;
            color: #e5e7eb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .small-text {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .bet-list {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #1f2937;
            padding-top: 0.5rem;
        }

        .bet-item {
            padding: 0.35rem 0;
            border-bottom: 1px dashed #1f2937;
        }

        .bet-item span {
            display: inline-block;
        }

        .bet-item button {
            margin-left: 0.5rem;
        }

        .status-bar {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            border-bottom: 1px solid #1f2937;
            padding: 0.4rem 0.5rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #020617;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .scroll-container {
            max-height: 520px;
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>Bet Watcher Web</h1>
            <div class="small-text">
                Track specific teams/lines across books and get quick snapshots or loops.
            </div>
        </div>
        <nav>
            <a href="/">Value Finder</a>
            <a href="/watcher.html" class="active">Watcher</a>
        </nav>
    </header>

    <main>
        <!-- Left: controls and saved bets -->
        <section class="card">
            <h2>Configure Bets</h2>

            <button class="btn btn-link" style="margin-bottom: 0.5rem;" onclick="window.location.href='/'">
                ⇄ Switch to Value Finder (Home)
            </button>

            <label for="team-input">Team name</label>
            <input id="team-input" type="text" placeholder="e.g. New York Knicks" />

            <label for="odds-input">Target odds (“or better”)</label>
            <input id="odds-input" type="text" placeholder="-290 or +120" />

            <label>Books to watch</label>
            <div class="book-checkboxes">
                <label><input type="checkbox" name="book" value="draftkings" checked /> DraftKings</label>
                <label><input type="checkbox" name="book" value="fanduel" checked /> FanDuel</label>
                <label><input type="checkbox" name="book" value="novig" /> Novig</label>
                <label><input type="checkbox" name="book" value="fliff" checked /> Fliff</label>
            </div>

            <label for="interval-input">Polling interval (seconds)</label>
            <input id="interval-input" type="number" min="15" step="15" value="60" />

            <button class="btn btn-primary" id="add-bet-btn">Add bet</button>
            <button class="btn btn-secondary" id="clear-bets-btn">Clear all bets</button>

            <div class="small-text" style="margin-top: 0.4rem;">
                Bets are saved in your browser (localStorage) on this machine.
            </div>

            <div class="bet-list" id="bet-list"></div>

            <hr style="border-color:#1f2937; margin: 0.9rem 0;" />

            <button class="btn btn-primary" id="start-btn">Start watching</button>
            <button class="btn btn-secondary" id="snapshot-btn">One-time snapshot</button>
            <button class="btn btn-secondary" id="stop-btn" disabled>Stop</button>

            <div class="status-bar" id="status-bar">
                Ready.
            </div>
        </section>

        <!-- Right: live odds table -->
        <section class="card">
            <h2>Live Odds</h2>
            <div class="small-text" id="last-updated"></div>
            <div class="scroll-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Bet</th>
                            <th style="width: 26%;">Matchup</th>
                            <th style="width: 18%;">Start Time</th>
                            <th>Prices</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <tr>
                            <td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start
                                watching.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const STORAGE_KEY = "betWatcherBets";
        let bets = [];
        let pollTimer = null;

        function parseOdds(value) {
            if (!value) return null;
            value = value.trim();
            if (value.startsWith("+")) value = value.slice(1);
            const n = Number(value);
            return Number.isNaN(n) ? null : n;
        }

        function loadBetsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    bets = parsed;
                }
            } catch (e) {
                console.error("Failed to load bets from storage", e);
            }
        }

        function saveBetsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
            } catch (e) {
                console.error("Failed to save bets to storage", e);
            }
        }

        function renderBetList() {
            const listEl = document.getElementById("bet-list");
            listEl.innerHTML = "";
            if (bets.length === 0) {
                listEl.innerHTML = '<div class="small-text">No bets configured yet.</div>';
                return;
            }
            bets.forEach((bet, idx) => {
                const div = document.createElement("div");
                div.className = "bet-item";
                const booksLabel = bet.bookmaker_keys.join(", ");
                div.innerHTML = `
          <span>[${idx + 1}] <strong>${bet.team_name}</strong> @ ${booksLabel} (target ${bet.target_odds} or better)</span>
          <button class="btn btn-secondary btn-sm" data-idx="${idx}">Remove</button>
        `;
                const btn = div.querySelector("button");
                btn.onclick = () => {
                    bets.splice(idx, 1);
                    saveBetsToStorage();
                    renderBetList();
                };
                listEl.appendChild(div);
            });
        }

        function addBetFromForm() {
            const teamInput = document.getElementById("team-input");
            const oddsInput = document.getElementById("odds-input");
            const team = teamInput.value.trim();
            if (!team) {
                alert("Please enter a team name.");
                return;
            }

            const parsedOdds = parseOdds(oddsInput.value);
            if (parsedOdds === null) {
                alert("Please enter valid target odds like -290 or +120.");
                return;
            }

            const bookCheckboxes = document.querySelectorAll('input[name="book"]:checked');
            const bookmaker_keys = Array.from(bookCheckboxes).map(cb => cb.value);
            if (bookmaker_keys.length === 0) {
                alert("Select at least one book.");
                return;
            }

            bets.push({
                team_name: team,
                target_odds: parsedOdds,
                bookmaker_keys,
            });

            saveBetsToStorage();
            renderBetList();

            teamInput.value = "";
            oddsInput.value = "";
        }

        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setLastUpdated() {
            const el = document.getElementById("last-updated");
            const now = new Date();
            el.textContent = "Last updated: " + now.toLocaleTimeString();
        }

        function clearResultsTable() {
            const body = document.getElementById("results-body");
            body.innerHTML = `
        <tr><td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start watching.</td></tr>
      `;
        }

        function renderResults(data) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.bets || data.bets.length === 0) {
                clearResultsTable();
                return;
            }

            data.bets.forEach((bet, betIndex) => {
                if (!bet.games || bet.games.length === 0) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td>[${betIndex + 1}] ${bet.team_name}</td>
            <td colspan="3" class="small-text">No upcoming games found.</td>
          `;
                    body.appendChild(tr);
                    return;
                }

                bet.games.forEach(game => {
                    const tr = document.createElement("tr");

                    const betCell = document.createElement("td");
                    betCell.innerHTML = `<strong>${bet.team_name}</strong><br /><span class="small-text">Target: ${bet.target_odds} or better</span>`;
                    tr.appendChild(betCell);

                    const matchupCell = document.createElement("td");
                    matchupCell.textContent = game.matchup || "";
                    tr.appendChild(matchupCell);

                    const startCell = document.createElement("td");
                    startCell.textContent = game.start_time || "";
                    tr.appendChild(startCell);

                    const pricesCell = document.createElement("td");
                    if (!game.prices || game.prices.length === 0) {
                        pricesCell.innerHTML = '<span class="small-text">No lines available.</span>';
                    } else {
                        game.prices.forEach(priceObj => {
                            const line = document.createElement("div");
                            const name = priceObj.bookmaker_name || priceObj.bookmaker_key;
                            const price = priceObj.price;
                            let inner = `<strong>${name}:</strong> `;
                            if (price === null || price === undefined) {
                                inner += '<span class="small-text">(no line)</span>';
                            } else {
                                inner += price;
                            }

                            const hit = (price !== null && price >= bet.target_odds); // "or better" logic

                            if (hit) {
                                inner += ' <span class="badge badge-hit">HIT</span>';
                            }

                            const isBest = game.best_bookmaker_key && priceObj.bookmaker_key === game.best_bookmaker_key && game.best_price === price;
                            if (isBest) {
                                inner += ' <span class="badge badge-best">BEST</span>';
                            }

                            line.innerHTML = inner;
                            pricesCell.appendChild(line);
                        });

                        if (game.best_bookmaker_name && game.best_price !== null) {
                            const summary = document.createElement("div");
                            summary.className = "small-text";
                            summary.textContent = `Best current price: ${game.best_bookmaker_name} ${game.best_price}`;
                            pricesCell.appendChild(summary);
                        }
                    }

                    tr.appendChild(pricesCell);
                    body.appendChild(tr);
                });
            });
        }

        async function fetchSnapshot() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }
            setStatus("Fetching snapshot...");
            try {
                const response = await fetch("/api/odds", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bets, sport_key: "basketball_nba" }),
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || ("HTTP " + response.status));
                }
                const data = await response.json();
                renderResults(data);
                setLastUpdated();
                setStatus("Snapshot fetched.");
            } catch (e) {
                console.error(e);
                setStatus("Error fetching odds: " + e.message);
            }
        }

        function startWatching() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }

            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            setStatus("Watching odds...");
            document.getElementById("start-btn").disabled = true;
            document.getElementById("snapshot-btn").disabled = true;
            document.getElementById("stop-btn").disabled = false;

            // Run immediately, then on interval
            fetchSnapshot();
            pollTimer = setInterval(fetchSnapshot, intervalMs);
        }

        function stopWatching() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-btn").disabled = false;
            document.getElementById("snapshot-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        function clearBets() {
            if (!confirm("Clear all saved bets?")) return;
            bets = [];
            saveBetsToStorage();
            renderBetList();
            clearResultsTable();
        }

        window.addEventListener("DOMContentLoaded", () => {
            loadBetsFromStorage();
            renderBetList();

            document.getElementById("add-bet-btn").onclick = addBetFromForm;
            document.getElementById("clear-bets-btn").onclick = clearBets;
            document.getElementById("snapshot-btn").onclick = fetchSnapshot;
            document.getElementById("start-btn").onclick = startWatching;
            document.getElementById("stop-btn").onclick = stopWatching;
        });
    </script>
</body>

</html>