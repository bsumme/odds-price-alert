<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Bet Watcher Web</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.fade-out {
            opacity: 0;
        }

        body.fade-in {
            opacity: 1;
        }

        header {
            padding: 0.5rem 1rem;
            background: #1e293b;
            border-bottom: 2px solid #334155;
            display: none;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            height: auto;
            min-height: 3rem;
        }

        header.show {
            display: flex;
        }

        .top-right-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
        }

        .top-right-buttons .btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .top-right-buttons .btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .top-right-buttons .btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }

        .toggle-buttons {
            position: fixed;
            bottom: 0.5rem;
            right: 0.5rem;
            z-index: 1001;
            display: flex;
            gap: 0.5rem;
            transition: bottom 0.2s;
        }

        .toggle-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        .toggle-btn.active {
            background: #166534;
            border-color: #15803d;
            color: #bbf7d0;
        }


        main {
            padding: 0.75rem;
            height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0.75rem;
            align-items: start;
            overflow: hidden;
            padding-top: 0.75rem;
            box-sizing: border-box;
        }

        header.show + main {
            padding-top: 4.5rem;
        }

        .card {
            background: #1e293b;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            padding: 0.6rem 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card h2 {
            margin-top: 0;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            margin-top: 0.4rem;
            margin-bottom: 0.1rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border-radius: 0.4rem;
            border: 1px solid #475569;
            background: #0f172a;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.8rem;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .book-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .book-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0;
        }

        .btn {
            border: none;
            border-radius: 0.4rem;
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.4rem;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: #166534;
            color: #bbf7d0;
        }

        .btn-primary:hover {
            background: #15803d;
        }

        .btn-secondary {
            background: #475569;
            color: #e5e7eb;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #475569;
            color: #e5e7eb;
        }

        .btn-link:hover {
            background: #334155;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .small-text {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .bet-list {
            margin-top: 0.75rem;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #334155;
            padding-top: 0.5rem;
        }

        .bet-item {
            padding: 0.25rem 0;
            border-bottom: 1px dashed #334155;
        }

        .bet-item span {
            display: inline-block;
        }

        .bet-item button {
            margin-left: 0.5rem;
        }

        .status-bar {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 0.4rem;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Custom scrollbar styling */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        th,
        td {
            border-bottom: 1px solid #334155;
            padding: 0.3rem 0.4rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #1e293b;
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.7rem;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .odds-chip {
            display: inline-block;
            padding: 0.1rem 0.45rem;
            border-radius: 0.4rem;
            font-weight: 700;
        }

        .odds-plus-strong {
            background: #14532d;
            color: #bbf7d0;
        }

        .odds-plus {
            background: #166534;
            color: #bbf7d0;
        }

        .odds-plus-light {
            background: #15803d;
            color: #dcfce7;
        }

        .odds-favorite-strong {
            background: #7f1d1d;
            color: #fecdd3;
        }

        .odds-favorite {
            background: #991b1b;
            color: #fecaca;
        }

        .odds-favorite-light {
            background: #b91c1c;
            color: #fee2e2;
        }

        .odds-neutral {
            background: #374151;
            color: #e5e7eb;
        }


        /* Alert popup styles */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-in;
        }

        .alert-popup {
            background: #020617;
            border: 2px solid #166534;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideIn 0.3s ease-out;
        }

        .alert-popup h3 {
            margin: 0 0 1rem 0;
            color: #bbf7d0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-popup .alert-content {
            color: #e5e7eb;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .alert-popup .alert-detail {
            background: #0f172a;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            border-left: 3px solid #166534;
        }

        .alert-popup .alert-detail strong {
            color: #bbf7d0;
        }

        .alert-popup button {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
        }

        .alert-popup button:hover {
            background: #1d4ed8;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 1600px) {
            main {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 1400px) {
            main {
                grid-template-columns: 260px 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="top-right-buttons">
        <a href="/BensSportsBookApp.html" class="btn smooth-nav" data-href="/BensSportsBookApp.html" title="Go to Arbitrage Finder">Arbitrage Finder</a>
        <a href="/watcher.html" class="btn smooth-nav active" data-href="/watcher.html" title="Go to Watcher">Watcher</a>
        <a href="/linetracker.html" class="btn smooth-nav" data-href="/linetracker.html" title="Go to Line Tracker">Line Tracker</a>
        <a href="/value.html" class="btn smooth-nav" data-href="/value.html" title="Go to Value Finder">Value Finder</a>
        <a href="/sgp-builder.html" class="btn smooth-nav" data-href="/sgp-builder.html" title="Go to SGP Builder">SGP Builder</a>
        <a href="/playerprops.html" class="btn smooth-nav" data-href="/playerprops.html" title="Go to Player Props">Player Props</a>
        <a href="/settings.html" class="btn smooth-nav" data-href="/settings.html" title="Go to Settings">Settings</a>
    </div>
    <header id="main-header">
        <nav>
        </nav>
    </header>

    <main>
        <!-- Left: controls and saved bets -->
        <section class="card">
            <h2>Configure Bets</h2>


            <label for="sport-select">Sport</label>
            <select id="sport-select">
                <option value="basketball_nba">NBA</option>
                <option value="americanfootball_nfl">NFL</option>
                <option value="basketball_ncaab">NCAAB</option>
                <option value="americanfootball_ncaaf">NCAAF</option>
            </select>

            <label for="team-select">Team name</label>
            <select id="team-select">
                <option value="">Select a sport first</option>
            </select>

            <label for="odds-input">Target odds (‚Äúor better‚Äù)</label>
            <input id="odds-input" type="text" placeholder="-290 or +120" />

            <label>Books to watch</label>
            <div class="book-checkboxes">
                <label><input type="checkbox" name="book" value="draftkings" checked /> DraftKings</label>
                <label><input type="checkbox" name="book" value="fanduel" checked /> FanDuel</label>
                <label><input type="checkbox" name="book" value="novig" /> Novig</label>
                <label><input type="checkbox" name="book" value="fliff" checked /> Fliff</label>
            </div>

            <label for="interval-input">Polling interval (seconds)</label>
            <input id="interval-input" type="number" min="15" step="15" value="60" />

            <button class="btn btn-primary" id="add-bet-btn">Add bet</button>
            <button class="btn btn-secondary" id="clear-bets-btn">Clear all bets</button>

            <div class="small-text" style="margin-top: 0.4rem;">
                Bets are saved in your browser (localStorage) on this machine.
            </div>

            <div class="bet-list" id="bet-list"></div>

            <hr style="border-color:#1f2937; margin: 0.9rem 0;" />

            <button class="btn btn-primary" id="start-btn">Start watching</button>
            <button class="btn btn-secondary" id="snapshot-btn">One-time snapshot</button>
            <button class="btn btn-secondary" id="stop-btn" disabled>Stop</button>

            <div class="status-bar" id="status-bar">
                Ready.
            </div>
        </section>

        <!-- Right: live odds table -->
        <section class="card">
            <h2>Live Odds</h2>
            <div class="small-text" id="last-updated"></div>
            <div class="scroll-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Bet</th>
                            <th style="width: 26%;">Matchup</th>
                            <th style="width: 18%;">Start Time</th>
                            <th>Prices</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <tr>
                            <td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start
                                watching.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const STORAGE_KEY = "betWatcherBets";
        let bets = [];
        let pollTimer = null;
        let alertedHits = new Set(); // Track which hits have already been alerted

        // Team lists by sport
        const TEAMS_BY_SPORT = {
            "basketball_nba": [
                "Atlanta Hawks", "Boston Celtics", "Brooklyn Nets", "Charlotte Hornets", "Chicago Bulls",
                "Cleveland Cavaliers", "Dallas Mavericks", "Denver Nuggets", "Detroit Pistons", "Golden State Warriors",
                "Houston Rockets", "Indiana Pacers", "LA Clippers", "Los Angeles Lakers", "Memphis Grizzlies",
                "Miami Heat", "Milwaukee Bucks", "Minnesota Timberwolves", "New Orleans Pelicans", "New York Knicks",
                "Oklahoma City Thunder", "Orlando Magic", "Philadelphia 76ers", "Phoenix Suns", "Portland Trail Blazers",
                "Sacramento Kings", "San Antonio Spurs", "Toronto Raptors", "Utah Jazz", "Washington Wizards"
            ],
            "americanfootball_nfl": [
                "Arizona Cardinals", "Atlanta Falcons", "Baltimore Ravens", "Buffalo Bills", "Carolina Panthers",
                "Chicago Bears", "Cincinnati Bengals", "Cleveland Browns", "Dallas Cowboys", "Denver Broncos",
                "Detroit Lions", "Green Bay Packers", "Houston Texans", "Indianapolis Colts", "Jacksonville Jaguars",
                "Kansas City Chiefs", "Las Vegas Raiders", "Los Angeles Chargers", "Los Angeles Rams", "Miami Dolphins",
                "Minnesota Vikings", "New England Patriots", "New Orleans Saints", "New York Giants", "New York Jets",
                "Philadelphia Eagles", "Pittsburgh Steelers", "San Francisco 49ers", "Seattle Seahawks", "Tampa Bay Buccaneers",
                "Tennessee Titans", "Washington Commanders"
            ],
            "basketball_ncaab": [
                "Alabama", "Arizona", "Arkansas", "Auburn", "Baylor", "Butler", "Cincinnati", "Clemson", "Connecticut", "Creighton",
                "Duke", "Florida", "Florida State", "Gonzaga", "Houston", "Illinois", "Indiana", "Iowa", "Iowa State", "Kansas",
                "Kansas State", "Kentucky", "Louisville", "LSU", "Marquette", "Maryland", "Memphis", "Miami", "Michigan", "Michigan State",
                "Missouri", "NC State", "North Carolina", "Notre Dame", "Ohio State", "Oklahoma", "Oklahoma State", "Oregon", "Penn State", "Purdue",
                "San Diego State", "Seton Hall", "South Carolina", "St. John's", "Syracuse", "TCU", "Tennessee", "Texas", "Texas A&M", "UCLA",
                "USC", "Villanova", "Virginia", "Wake Forest", "Washington", "West Virginia", "Wisconsin", "Xavier"
            ],
            "americanfootball_ncaaf": [
                "Alabama", "Arizona", "Arizona State", "Arkansas", "Auburn", "Baylor", "Boston College", "BYU", "California", "Clemson",
                "Colorado", "Duke", "Florida", "Florida State", "Georgia", "Georgia Tech", "Illinois", "Indiana", "Iowa", "Iowa State",
                "Kansas", "Kansas State", "Kentucky", "Louisville", "LSU", "Maryland", "Miami", "Michigan", "Michigan State", "Minnesota",
                "Mississippi State", "Missouri", "NC State", "Nebraska", "North Carolina", "Northwestern", "Notre Dame", "Ohio State", "Oklahoma", "Oklahoma State",
                "Ole Miss", "Oregon", "Oregon State", "Penn State", "Pittsburgh", "Purdue", "Rutgers", "South Carolina", "Stanford", "Syracuse",
                "TCU", "Tennessee", "Texas", "Texas A&M", "Texas Tech", "UCLA", "USC", "Utah", "Vanderbilt", "Virginia",
                "Virginia Tech", "Wake Forest", "Washington", "Washington State", "West Virginia", "Wisconsin"
            ]
        };

        function populateTeamDropdown() {
            const sportSelect = document.getElementById("sport-select");
            const teamSelect = document.getElementById("team-select");
            const selectedSport = sportSelect.value;
            
            teamSelect.innerHTML = "";
            
            if (!selectedSport) {
                teamSelect.innerHTML = '<option value="">Select a sport first</option>';
                return;
            }
            
            const teams = TEAMS_BY_SPORT[selectedSport] || [];
            teams.forEach(team => {
                const option = document.createElement("option");
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
        }

        function parseOdds(value) {
            if (!value) return null;
            value = value.trim();
            if (value.startsWith("+")) value = value.slice(1);
            const n = Number(value);
            return Number.isNaN(n) ? null : n;
        }

        function loadBetsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    bets = parsed;
                }
            } catch (e) {
                console.error("Failed to load bets from storage", e);
            }
        }

        function saveBetsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
            } catch (e) {
                console.error("Failed to save bets to storage", e);
            }
        }

        // Odds format conversion functions
        function formatOdds(odds) {
            /**
             * Format odds in American format.
             * Returns the odds as a string with proper formatting.
             */
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            // American format: Add "+" prefix for positive odds
            return numOdds > 0 ? `+${numOdds}` : String(numOdds);
        }

        // Legacy function for backwards compatibility
        function formatAmericanOdds(odds) {
            return formatOdds(odds);
        }

        function getOddsColorClass(odds) {
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (numOdds === null || numOdds === undefined || isNaN(numOdds)) {
                return "";
            }

            const absOdds = Math.abs(numOdds);

            if (absOdds <= 115) return "odds-neutral"; // Around even (-110 to +110)

            if (numOdds > 0) {
                if (numOdds >= 350) return "odds-plus-strong"; // Longshots
                if (numOdds >= 200) return "odds-plus"; // Strong plus money
                if (numOdds >= 120) return "odds-plus-light"; // Mild plus money
                return "odds-neutral";
            }

            if (numOdds <= -350) return "odds-favorite-strong"; // Heavy favorites
            if (numOdds <= -200) return "odds-favorite"; // Strong favorites
            if (numOdds <= -120) return "odds-favorite-light"; // Mild favorites
            return "odds-neutral";
        }

        function formatOddsWithColor(odds) {
            const formatted = formatOdds(odds);
            const className = getOddsColorClass(odds);
            if (!className) return formatted;
            return `<span class="odds-chip ${className}">${formatted}</span>`;
        }

        function renderBetList() {
            const listEl = document.getElementById("bet-list");
            listEl.innerHTML = "";
            if (bets.length === 0) {
                listEl.innerHTML = '<div class="small-text">No bets configured yet.</div>';
                return;
            }
            
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };
            
            bets.forEach((bet, idx) => {
                const div = document.createElement("div");
                div.className = "bet-item";
                const booksLabel = bet.bookmaker_keys.join(", ");
                const sportLabel = sportLabels[bet.sport_key] || bet.sport_key || "Unknown";
                div.innerHTML = `
          <span>[${idx + 1}] <strong>${bet.team_name}</strong> (${sportLabel}) @ ${booksLabel} (target ${bet.target_odds} or better)</span>
          <button class="btn btn-secondary btn-sm" data-idx="${idx}">Remove</button>
        `;
                const btn = div.querySelector("button");
                btn.onclick = () => {
                    bets.splice(idx, 1);
                    saveBetsToStorage();
                    renderBetList();
                };
                listEl.appendChild(div);
            });
        }

        function addBetFromForm() {
            const sportSelect = document.getElementById("sport-select");
            const teamSelect = document.getElementById("team-select");
            const oddsInput = document.getElementById("odds-input");
            
            const sportKey = sportSelect.value;
            if (!sportKey) {
                alert("Please select a sport.");
                return;
            }
            
            const team = teamSelect.value;
            if (!team) {
                alert("Please select a team.");
                return;
            }

            const parsedOdds = parseOdds(oddsInput.value);
            if (parsedOdds === null) {
                alert("Please enter valid target odds like -290 or +120.");
                return;
            }

            const bookCheckboxes = document.querySelectorAll('input[name="book"]:checked');
            const bookmaker_keys = Array.from(bookCheckboxes).map(cb => cb.value);
            if (bookmaker_keys.length === 0) {
                alert("Select at least one book.");
                return;
            }

            bets.push({
                sport_key: sportKey,
                team_name: team,
                target_odds: parsedOdds,
                bookmaker_keys,
            });

            saveBetsToStorage();
            renderBetList();

            oddsInput.value = "";
        }

        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setLastUpdated() {
            const el = document.getElementById("last-updated");
            const now = new Date();
            el.textContent = "Last updated: " + now.toLocaleTimeString();
        }

        function clearResultsTable() {
            const body = document.getElementById("results-body");
            body.innerHTML = `
        <tr><td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start watching.</td></tr>
      `;
        }

        function playAlertSound() {
            // Create a simple beep sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // Higher pitch for attention
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // Play a second beep after a short delay
                setTimeout(() => {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();
                    
                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);
                    
                    oscillator2.frequency.value = 1000;
                    oscillator2.type = 'sine';
                    
                    gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator2.start(audioContext.currentTime);
                    oscillator2.stop(audioContext.currentTime + 0.5);
                }, 200);
            } catch (e) {
                console.warn("Could not play alert sound:", e);
            }
        }

        function showAlertPopup(alertData) {
            // Create overlay
            const overlay = document.createElement("div");
            overlay.className = "alert-overlay";
            
            // Create popup
            const popup = document.createElement("div");
            popup.className = "alert-popup";
            
            popup.innerHTML = `
                <h3>üîî Value Play Alert!</h3>
                <div class="alert-content">
                    <div class="alert-detail">
                        <strong>Team:</strong> ${alertData.team_name}
                    </div>
                    <div class="alert-detail">
                        <strong>Bookmaker:</strong> ${alertData.bookmaker_name}
                    </div>
                    <div class="alert-detail">
                        <strong>Price:</strong> ${formatOddsWithColor(alertData.price)} (Target: ${formatOddsWithColor(alertData.target_odds)} or better)
                    </div>
                    ${alertData.matchup ? `<div class="alert-detail"><strong>Matchup:</strong> ${alertData.matchup}</div>` : ''}
                </div>
                <button onclick="this.closest('.alert-overlay').remove()">Got it!</button>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Play sound
            playAlertSound();
            
            // Auto-close after 30 seconds if user doesn't close it
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.remove();
                }
            }, 30000);
        }

        function renderResults(data) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.bets || data.bets.length === 0) {
                clearResultsTable();
                return;
            }

            // Track new hits for alerts
            const newHits = [];

            data.bets.forEach((bet, betIndex) => {
                if (!bet.games || bet.games.length === 0) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td>[${betIndex + 1}] ${bet.team_name}</td>
            <td colspan="3" class="small-text">No upcoming games found.</td>
          `;
                    body.appendChild(tr);
                    return;
                }

                bet.games.forEach(game => {
                    const tr = document.createElement("tr");

                    const betCell = document.createElement("td");
                    betCell.innerHTML = `<strong>${bet.team_name}</strong><br /><span class="small-text">Target: ${bet.target_odds} or better</span>`;
                    tr.appendChild(betCell);

                    const matchupCell = document.createElement("td");
                    matchupCell.textContent = game.matchup || "";
                    tr.appendChild(matchupCell);

                    const startCell = document.createElement("td");
                    startCell.textContent = game.start_time || "";
                    tr.appendChild(startCell);

                    const pricesCell = document.createElement("td");
                    if (!game.prices || game.prices.length === 0) {
                        pricesCell.innerHTML = '<span class="small-text">No lines available.</span>';
                    } else {
                        game.prices.forEach(priceObj => {
                            const line = document.createElement("div");
                            const name = priceObj.bookmaker_name || priceObj.bookmaker_key;
                            const price = priceObj.price;
                            let inner = `<strong>${name}:</strong> `;
                            if (price === null || price === undefined) {
                                inner += '<span class="small-text">(no line)</span>';
                            } else {
                                inner += formatOddsWithColor(price);
                            }

                            const hit = (price !== null && price >= bet.target_odds); // "or better" logic

                            if (hit) {
                                inner += ' <span class="badge badge-hit">HIT</span>';
                                
                                // Check if this is a new hit that hasn't been alerted yet
                                const hitKey = `${bet.team_name}_${name}_${price}_${game.matchup || ''}`;
                                if (!alertedHits.has(hitKey)) {
                                    alertedHits.add(hitKey);
                                    newHits.push({
                                        team_name: bet.team_name,
                                        bookmaker_name: name,
                                        price: price,
                                        target_odds: bet.target_odds,
                                        matchup: game.matchup || ""
                                    });
                                }
                            }

                            const isBest = game.best_bookmaker_key && priceObj.bookmaker_key === game.best_bookmaker_key && game.best_price === price;
                            if (isBest) {
                                inner += ' <span class="badge badge-best">BEST</span>';
                            }

                            line.innerHTML = inner;
                            pricesCell.appendChild(line);
                        });

                        if (game.best_bookmaker_name && game.best_price !== null) {
                            const summary = document.createElement("div");
                            summary.className = "small-text";
                            summary.innerHTML = `Best current price: ${game.best_bookmaker_name} ${formatOddsWithColor(game.best_price)}`;
                            pricesCell.appendChild(summary);
                        }
                    }

                    tr.appendChild(pricesCell);
                    body.appendChild(tr);
                });
            });

            // Show alerts for new hits (only when watcher is running)
            if (pollTimer && newHits.length > 0) {
                newHits.forEach(hit => {
                    showAlertPopup(hit);
                });
            }
        }

        async function fetchSnapshot() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }
            setStatus("Fetching snapshot...");
            try {
                // Convert watcher bets to API BetRequest format
                const apiBets = bets.map(bet => ({
                    sport_key: bet.sport_key || "basketball_nba", // fallback for old bets
                    market: "h2h", // watcher uses moneyline by default
                    team: bet.team_name,
                    point: null,
                    bookmaker_keys: bet.bookmaker_keys
                }));
                
                const response = await fetch("/api/odds", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bets: apiBets }),
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || ("HTTP " + response.status));
                }
                const apiData = await response.json();
                
                // Transform API response to match renderResults expected format
                const transformedData = {
                    bets: bets.map((watcherBet, idx) => {
                        const apiBet = apiData.bets.find(b => b.team === watcherBet.team_name);
                        if (!apiBet) {
                            return {
                                team_name: watcherBet.team_name,
                                target_odds: watcherBet.target_odds,
                                games: []
                            };
                        }
                        
                        // Find best price (convert American to decimal for comparison)
                        const validPrices = apiBet.prices.filter(p => p.price !== null && p.price !== undefined);
                        let bestPrice = null;
                        let bestBook = null;
                        if (validPrices.length > 0) {
                            const best = validPrices.reduce((best, curr) => {
                                // Convert American odds to decimal
                                const bestDecimal = best.price > 0 
                                    ? (best.price / 100) + 1 
                                    : (100 / Math.abs(best.price)) + 1;
                                const currDecimal = curr.price > 0
                                    ? (curr.price / 100) + 1
                                    : (100 / Math.abs(curr.price)) + 1;
                                // Higher decimal odds = better price
                                return currDecimal > bestDecimal ? curr : best;
                            });
                            bestPrice = best.price;
                            bestBook = best.bookmaker_key;
                        }
                        
                        return {
                            team_name: watcherBet.team_name,
                            target_odds: watcherBet.target_odds,
                            games: [{
                                matchup: `${watcherBet.team_name} (${apiBet.sport_key})`,
                                start_time: "",
                                prices: apiBet.prices.map(p => ({
                                    bookmaker_key: p.bookmaker_key,
                                    bookmaker_name: p.bookmaker_name,
                                    price: p.price
                                })),
                                best_bookmaker_key: bestBook,
                                best_price: bestPrice,
                                best_bookmaker_name: apiBet.prices.find(p => p.bookmaker_key === bestBook)?.bookmaker_name || null
                            }]
                        };
                    })
                };
                
                renderResults(transformedData);
                setLastUpdated();
                setStatus("Snapshot fetched.");
            } catch (e) {
                console.error(e);
                setStatus("Error fetching odds: " + e.message);
            }
        }

        function startWatching() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }

            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            // Clear previous alerts when starting fresh (optional - comment out if you want to keep alerts)
            // alertedHits.clear();

            setStatus("Watching odds...");
            document.getElementById("start-btn").disabled = true;
            document.getElementById("snapshot-btn").disabled = true;
            document.getElementById("stop-btn").disabled = false;

            // Run immediately, then on interval
            fetchSnapshot();
            pollTimer = setInterval(fetchSnapshot, intervalMs);
        }

        function stopWatching() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-btn").disabled = false;
            document.getElementById("snapshot-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        function clearBets() {
            if (!confirm("Clear all saved bets?")) return;
            bets = [];
            saveBetsToStorage();
            renderBetList();
            clearResultsTable();
        }

        // Save form selections to localStorage
        function saveFormSelections() {
            const selections = {
                sport: document.getElementById("sport-select").value,
                books: Array.from(document.querySelectorAll('input[name="book"]:checked')).map(cb => cb.value),
                interval: document.getElementById("interval-input").value
            };
            localStorage.setItem("watcherSelections", JSON.stringify(selections));
        }

        // Load form selections from localStorage
        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("watcherSelections");
                if (!saved) return;
                
                const selections = JSON.parse(saved);
                
                if (selections.sport) {
                    document.getElementById("sport-select").value = selections.sport;
                    populateTeamDropdown(); // Update team dropdown when sport changes
                }
                
                if (selections.books && Array.isArray(selections.books)) {
                    document.querySelectorAll('input[name="book"]').forEach(cb => {
                        cb.checked = selections.books.includes(cb.value);
                    });
                }
                
                if (selections.interval) {
                    document.getElementById("interval-input").value = selections.interval;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        // Smooth page navigation with fade transition
        function smoothNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 300); // Match the CSS transition duration
        }

        // Fade in on page load
        function fadeInPage() {
            requestAnimationFrame(() => {
                document.body.classList.add('fade-in');
            });
        }

        // Handle both initial load and back/forward navigation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fadeInPage);
        } else {
            fadeInPage();
        }

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                // Page was loaded from cache (back/forward navigation)
                document.body.classList.remove('fade-in');
                requestAnimationFrame(() => {
                    document.body.classList.add('fade-in');
                });
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            // Set up smooth navigation for all smooth-nav links and buttons
            document.querySelectorAll('.smooth-nav, .smooth-nav-btn').forEach(element => {
                element.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = element.getAttribute('data-href') || element.getAttribute('href');
                    if (url) {
                        smoothNavigate(url);
                    }
                });
            });

            // Mark the current page button as active
            const currentPageButton = document.querySelector('.top-right-buttons .smooth-nav');
            if (currentPageButton) {
                currentPageButton.classList.add('active');
            }

            // Load saved form selections
            loadFormSelections();

            // Save form selections when they change
            document.getElementById("sport-select").addEventListener("change", () => {
                saveFormSelections();
                populateTeamDropdown();
            });
            document.querySelectorAll('input[name="book"]').forEach(cb => {
                cb.addEventListener("change", saveFormSelections);
            });
            document.getElementById("interval-input").addEventListener("change", saveFormSelections);

            loadBetsFromStorage();
            renderBetList();

            // Initialize team dropdown based on default sport selection
            populateTeamDropdown();
            
            // Note: sport change handler is already set up above in the form selections section

            document.getElementById("add-bet-btn").onclick = addBetFromForm;
            document.getElementById("clear-bets-btn").onclick = clearBets;
            document.getElementById("snapshot-btn").onclick = fetchSnapshot;
            document.getElementById("start-btn").onclick = startWatching;
            document.getElementById("stop-btn").onclick = stopWatching;

        });
    </script>
</body>

</html>