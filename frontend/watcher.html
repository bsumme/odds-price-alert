<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Bet Watcher Web</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
        }

        header {
            padding: 1rem 1.5rem;
            background: #0f172a;
            border-bottom: 1px solid #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.3rem;
        }

        header nav a {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.85rem;
            margin-left: 0.75rem;
        }

        header nav a:hover {
            color: #e5e7eb;
        }

        header nav a.active {
            color: #e5e7eb;
            font-weight: 500;
        }

        .odds-format-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            padding: 0.5rem 0.75rem;
            background: #0f172a;
            border-radius: 0.5rem;
            border: 1px solid #1f2937;
        }

        .odds-format-toggle label {
            font-size: 0.85rem;
            color: #9ca3af;
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .odds-format-toggle input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        main {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
            gap: 1.5rem;
        }

        .card {
            background: #020617;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            padding: 1rem 1.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.6rem;
            margin-bottom: 0.15rem;
            color: #9ca3af;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            box-sizing: border-box;
            font-size: 0.9rem;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .book-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .book-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0;
        }

        .btn {
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.9rem;
            font-size: 0.9rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-top: 0.75rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-secondary {
            background: #374151;
            color: #e5e7eb;
        }

        .btn-link {
            background: transparent;
            border: 1px solid #374151;
            color: #e5e7eb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .small-text {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .bet-list {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #1f2937;
            padding-top: 0.5rem;
        }

        .bet-item {
            padding: 0.35rem 0;
            border-bottom: 1px dashed #1f2937;
        }

        .bet-item span {
            display: inline-block;
        }

        .bet-item button {
            margin-left: 0.5rem;
        }

        .status-bar {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            border-bottom: 1px solid #1f2937;
            padding: 0.4rem 0.5rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #020617;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .badge {
            display: inline-block;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
        }

        .badge-hit {
            background: #166534;
            color: #bbf7d0;
        }

        .badge-best {
            background: #1d4ed8;
            color: #bfdbfe;
            margin-left: 0.25rem;
        }

        .scroll-container {
            max-height: 520px;
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>Bet Watcher Web</h1>
            <div class="small-text">
                Track specific teams/lines across books and get quick snapshots or loops.
            </div>
        </div>
        <nav>
            <a href="/">Value Finder</a>
            <a href="/watcher.html" class="active">Watcher</a>
            <div class="odds-format-toggle">
                <label>
                    <input type="radio" name="odds-format" value="american" checked />
                    <span>American</span>
                </label>
                <label>
                    <input type="radio" name="odds-format" value="decimal" />
                    <span>Decimal</span>
                </label>
            </div>
        </nav>
    </header>

    <main>
        <!-- Left: controls and saved bets -->
        <section class="card">
            <h2>Configure Bets</h2>

            <button class="btn btn-link" style="margin-bottom: 0.5rem;" onclick="window.location.href='/'">
                ⇄ Switch to Value Finder (Home)
            </button>

            <label for="sport-select">Sport</label>
            <select id="sport-select">
                <option value="basketball_nba">NBA</option>
                <option value="americanfootball_nfl">NFL</option>
                <option value="basketball_ncaab">NCAAB</option>
                <option value="americanfootball_ncaaf">NCAAF</option>
            </select>

            <label for="team-select">Team name</label>
            <select id="team-select">
                <option value="">Select a sport first</option>
            </select>

            <label for="odds-input">Target odds (“or better”)</label>
            <input id="odds-input" type="text" placeholder="-290 or +120" />

            <label>Books to watch</label>
            <div class="book-checkboxes">
                <label><input type="checkbox" name="book" value="draftkings" checked /> DraftKings</label>
                <label><input type="checkbox" name="book" value="fanduel" checked /> FanDuel</label>
                <label><input type="checkbox" name="book" value="novig" /> Novig</label>
                <label><input type="checkbox" name="book" value="fliff" checked /> Fliff</label>
            </div>

            <label for="interval-input">Polling interval (seconds)</label>
            <input id="interval-input" type="number" min="15" step="15" value="60" />

            <button class="btn btn-primary" id="add-bet-btn">Add bet</button>
            <button class="btn btn-secondary" id="clear-bets-btn">Clear all bets</button>

            <div class="small-text" style="margin-top: 0.4rem;">
                Bets are saved in your browser (localStorage) on this machine.
            </div>

            <div class="bet-list" id="bet-list"></div>

            <hr style="border-color:#1f2937; margin: 0.9rem 0;" />

            <button class="btn btn-primary" id="start-btn">Start watching</button>
            <button class="btn btn-secondary" id="snapshot-btn">One-time snapshot</button>
            <button class="btn btn-secondary" id="stop-btn" disabled>Stop</button>

            <div class="status-bar" id="status-bar">
                Ready.
            </div>
        </section>

        <!-- Right: live odds table -->
        <section class="card">
            <h2>Live Odds</h2>
            <div class="small-text" id="last-updated"></div>
            <div class="scroll-container">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Bet</th>
                            <th style="width: 26%;">Matchup</th>
                            <th style="width: 18%;">Start Time</th>
                            <th>Prices</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <tr>
                            <td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start
                                watching.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const STORAGE_KEY = "betWatcherBets";
        let bets = [];
        let pollTimer = null;

        // Team lists by sport
        const TEAMS_BY_SPORT = {
            "basketball_nba": [
                "Atlanta Hawks", "Boston Celtics", "Brooklyn Nets", "Charlotte Hornets", "Chicago Bulls",
                "Cleveland Cavaliers", "Dallas Mavericks", "Denver Nuggets", "Detroit Pistons", "Golden State Warriors",
                "Houston Rockets", "Indiana Pacers", "LA Clippers", "Los Angeles Lakers", "Memphis Grizzlies",
                "Miami Heat", "Milwaukee Bucks", "Minnesota Timberwolves", "New Orleans Pelicans", "New York Knicks",
                "Oklahoma City Thunder", "Orlando Magic", "Philadelphia 76ers", "Phoenix Suns", "Portland Trail Blazers",
                "Sacramento Kings", "San Antonio Spurs", "Toronto Raptors", "Utah Jazz", "Washington Wizards"
            ],
            "americanfootball_nfl": [
                "Arizona Cardinals", "Atlanta Falcons", "Baltimore Ravens", "Buffalo Bills", "Carolina Panthers",
                "Chicago Bears", "Cincinnati Bengals", "Cleveland Browns", "Dallas Cowboys", "Denver Broncos",
                "Detroit Lions", "Green Bay Packers", "Houston Texans", "Indianapolis Colts", "Jacksonville Jaguars",
                "Kansas City Chiefs", "Las Vegas Raiders", "Los Angeles Chargers", "Los Angeles Rams", "Miami Dolphins",
                "Minnesota Vikings", "New England Patriots", "New Orleans Saints", "New York Giants", "New York Jets",
                "Philadelphia Eagles", "Pittsburgh Steelers", "San Francisco 49ers", "Seattle Seahawks", "Tampa Bay Buccaneers",
                "Tennessee Titans", "Washington Commanders"
            ],
            "basketball_ncaab": [
                "Alabama", "Arizona", "Arkansas", "Auburn", "Baylor", "Butler", "Cincinnati", "Clemson", "Connecticut", "Creighton",
                "Duke", "Florida", "Florida State", "Gonzaga", "Houston", "Illinois", "Indiana", "Iowa", "Iowa State", "Kansas",
                "Kansas State", "Kentucky", "Louisville", "LSU", "Marquette", "Maryland", "Memphis", "Miami", "Michigan", "Michigan State",
                "Missouri", "NC State", "North Carolina", "Notre Dame", "Ohio State", "Oklahoma", "Oklahoma State", "Oregon", "Penn State", "Purdue",
                "San Diego State", "Seton Hall", "South Carolina", "St. John's", "Syracuse", "TCU", "Tennessee", "Texas", "Texas A&M", "UCLA",
                "USC", "Villanova", "Virginia", "Wake Forest", "Washington", "West Virginia", "Wisconsin", "Xavier"
            ],
            "americanfootball_ncaaf": [
                "Alabama", "Arizona", "Arizona State", "Arkansas", "Auburn", "Baylor", "Boston College", "BYU", "California", "Clemson",
                "Colorado", "Duke", "Florida", "Florida State", "Georgia", "Georgia Tech", "Illinois", "Indiana", "Iowa", "Iowa State",
                "Kansas", "Kansas State", "Kentucky", "Louisville", "LSU", "Maryland", "Miami", "Michigan", "Michigan State", "Minnesota",
                "Mississippi State", "Missouri", "NC State", "Nebraska", "North Carolina", "Northwestern", "Notre Dame", "Ohio State", "Oklahoma", "Oklahoma State",
                "Ole Miss", "Oregon", "Oregon State", "Penn State", "Pittsburgh", "Purdue", "Rutgers", "South Carolina", "Stanford", "Syracuse",
                "TCU", "Tennessee", "Texas", "Texas A&M", "Texas Tech", "UCLA", "USC", "Utah", "Vanderbilt", "Virginia",
                "Virginia Tech", "Wake Forest", "Washington", "Washington State", "West Virginia", "Wisconsin"
            ]
        };

        function populateTeamDropdown() {
            const sportSelect = document.getElementById("sport-select");
            const teamSelect = document.getElementById("team-select");
            const selectedSport = sportSelect.value;
            
            teamSelect.innerHTML = "";
            
            if (!selectedSport) {
                teamSelect.innerHTML = '<option value="">Select a sport first</option>';
                return;
            }
            
            const teams = TEAMS_BY_SPORT[selectedSport] || [];
            teams.forEach(team => {
                const option = document.createElement("option");
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
        }

        function parseOdds(value) {
            if (!value) return null;
            value = value.trim();
            if (value.startsWith("+")) value = value.slice(1);
            const n = Number(value);
            return Number.isNaN(n) ? null : n;
        }

        function loadBetsFromStorage() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) {
                    bets = parsed;
                }
            } catch (e) {
                console.error("Failed to load bets from storage", e);
            }
        }

        function saveBetsToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
            } catch (e) {
                console.error("Failed to save bets to storage", e);
            }
        }

        // Odds format conversion functions
        function americanToDecimal(odds) {
            if (odds === null || odds === undefined) return null;
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) return null;
            if (numOdds > 0) {
                return 1.0 + numOdds / 100.0;
            } else {
                return 1.0 + 100.0 / Math.abs(numOdds);
            }
        }

        function getOddsFormat() {
            return localStorage.getItem("oddsFormat") || "american";
        }

        function setOddsFormat(format) {
            localStorage.setItem("oddsFormat", format);
            // Trigger re-render if we have data
            if (bets.length > 0 && pollTimer) {
                fetchSnapshot();
            }
        }

        function formatOdds(odds) {
            /**
             * Format odds based on user preference (American or Decimal).
             * Returns the odds as a string with proper formatting.
             */
            if (odds === null || odds === undefined) {
                return "";
            }
            const numOdds = typeof odds === "string" ? parseInt(odds, 10) : odds;
            if (isNaN(numOdds)) {
                return String(odds);
            }
            
            const format = getOddsFormat();
            if (format === "decimal") {
                const decimal = americanToDecimal(numOdds);
                return decimal ? decimal.toFixed(2) : String(odds);
            } else {
                // American format: Add "+" prefix for positive odds
                return numOdds > 0 ? `+${numOdds}` : String(numOdds);
            }
        }

        // Legacy function for backwards compatibility
        function formatAmericanOdds(odds) {
            return formatOdds(odds);
        }

        function renderBetList() {
            const listEl = document.getElementById("bet-list");
            listEl.innerHTML = "";
            if (bets.length === 0) {
                listEl.innerHTML = '<div class="small-text">No bets configured yet.</div>';
                return;
            }
            
            const sportLabels = {
                "basketball_nba": "NBA",
                "americanfootball_nfl": "NFL",
                "basketball_ncaab": "NCAAB",
                "americanfootball_ncaaf": "NCAAF"
            };
            
            bets.forEach((bet, idx) => {
                const div = document.createElement("div");
                div.className = "bet-item";
                const booksLabel = bet.bookmaker_keys.join(", ");
                const sportLabel = sportLabels[bet.sport_key] || bet.sport_key || "Unknown";
                div.innerHTML = `
          <span>[${idx + 1}] <strong>${bet.team_name}</strong> (${sportLabel}) @ ${booksLabel} (target ${bet.target_odds} or better)</span>
          <button class="btn btn-secondary btn-sm" data-idx="${idx}">Remove</button>
        `;
                const btn = div.querySelector("button");
                btn.onclick = () => {
                    bets.splice(idx, 1);
                    saveBetsToStorage();
                    renderBetList();
                };
                listEl.appendChild(div);
            });
        }

        function addBetFromForm() {
            const sportSelect = document.getElementById("sport-select");
            const teamSelect = document.getElementById("team-select");
            const oddsInput = document.getElementById("odds-input");
            
            const sportKey = sportSelect.value;
            if (!sportKey) {
                alert("Please select a sport.");
                return;
            }
            
            const team = teamSelect.value;
            if (!team) {
                alert("Please select a team.");
                return;
            }

            const parsedOdds = parseOdds(oddsInput.value);
            if (parsedOdds === null) {
                alert("Please enter valid target odds like -290 or +120.");
                return;
            }

            const bookCheckboxes = document.querySelectorAll('input[name="book"]:checked');
            const bookmaker_keys = Array.from(bookCheckboxes).map(cb => cb.value);
            if (bookmaker_keys.length === 0) {
                alert("Select at least one book.");
                return;
            }

            bets.push({
                sport_key: sportKey,
                team_name: team,
                target_odds: parsedOdds,
                bookmaker_keys,
            });

            saveBetsToStorage();
            renderBetList();

            oddsInput.value = "";
        }

        function setStatus(msg) {
            document.getElementById("status-bar").textContent = msg;
        }

        function setLastUpdated() {
            const el = document.getElementById("last-updated");
            const now = new Date();
            el.textContent = "Last updated: " + now.toLocaleTimeString();
        }

        function clearResultsTable() {
            const body = document.getElementById("results-body");
            body.innerHTML = `
        <tr><td colspan="4" class="small-text">No data yet. Add bets and run a snapshot or start watching.</td></tr>
      `;
        }

        function renderResults(data) {
            const body = document.getElementById("results-body");
            body.innerHTML = "";

            if (!data || !data.bets || data.bets.length === 0) {
                clearResultsTable();
                return;
            }

            data.bets.forEach((bet, betIndex) => {
                if (!bet.games || bet.games.length === 0) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td>[${betIndex + 1}] ${bet.team_name}</td>
            <td colspan="3" class="small-text">No upcoming games found.</td>
          `;
                    body.appendChild(tr);
                    return;
                }

                bet.games.forEach(game => {
                    const tr = document.createElement("tr");

                    const betCell = document.createElement("td");
                    betCell.innerHTML = `<strong>${bet.team_name}</strong><br /><span class="small-text">Target: ${bet.target_odds} or better</span>`;
                    tr.appendChild(betCell);

                    const matchupCell = document.createElement("td");
                    matchupCell.textContent = game.matchup || "";
                    tr.appendChild(matchupCell);

                    const startCell = document.createElement("td");
                    startCell.textContent = game.start_time || "";
                    tr.appendChild(startCell);

                    const pricesCell = document.createElement("td");
                    if (!game.prices || game.prices.length === 0) {
                        pricesCell.innerHTML = '<span class="small-text">No lines available.</span>';
                    } else {
                        game.prices.forEach(priceObj => {
                            const line = document.createElement("div");
                            const name = priceObj.bookmaker_name || priceObj.bookmaker_key;
                            const price = priceObj.price;
                            let inner = `<strong>${name}:</strong> `;
                            if (price === null || price === undefined) {
                                inner += '<span class="small-text">(no line)</span>';
                            } else {
                                inner += formatOdds(price);
                            }

                            const hit = (price !== null && price >= bet.target_odds); // "or better" logic

                            if (hit) {
                                inner += ' <span class="badge badge-hit">HIT</span>';
                            }

                            const isBest = game.best_bookmaker_key && priceObj.bookmaker_key === game.best_bookmaker_key && game.best_price === price;
                            if (isBest) {
                                inner += ' <span class="badge badge-best">BEST</span>';
                            }

                            line.innerHTML = inner;
                            pricesCell.appendChild(line);
                        });

                        if (game.best_bookmaker_name && game.best_price !== null) {
                            const summary = document.createElement("div");
                            summary.className = "small-text";
                            summary.textContent = `Best current price: ${game.best_bookmaker_name} ${game.best_price}`;
                            pricesCell.appendChild(summary);
                        }
                    }

                    tr.appendChild(pricesCell);
                    body.appendChild(tr);
                });
            });
        }

        async function fetchSnapshot() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }
            setStatus("Fetching snapshot...");
            try {
                // Convert watcher bets to API BetRequest format
                const apiBets = bets.map(bet => ({
                    sport_key: bet.sport_key || "basketball_nba", // fallback for old bets
                    market: "h2h", // watcher uses moneyline by default
                    team: bet.team_name,
                    point: null,
                    bookmaker_keys: bet.bookmaker_keys
                }));
                
                const response = await fetch("/api/odds", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bets: apiBets }),
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || ("HTTP " + response.status));
                }
                const apiData = await response.json();
                
                // Transform API response to match renderResults expected format
                const transformedData = {
                    bets: bets.map((watcherBet, idx) => {
                        const apiBet = apiData.bets.find(b => b.team === watcherBet.team_name);
                        if (!apiBet) {
                            return {
                                team_name: watcherBet.team_name,
                                target_odds: watcherBet.target_odds,
                                games: []
                            };
                        }
                        
                        // Find best price (convert American to decimal for comparison)
                        const validPrices = apiBet.prices.filter(p => p.price !== null && p.price !== undefined);
                        let bestPrice = null;
                        let bestBook = null;
                        if (validPrices.length > 0) {
                            const best = validPrices.reduce((best, curr) => {
                                // Convert American odds to decimal
                                const bestDecimal = best.price > 0 
                                    ? (best.price / 100) + 1 
                                    : (100 / Math.abs(best.price)) + 1;
                                const currDecimal = curr.price > 0
                                    ? (curr.price / 100) + 1
                                    : (100 / Math.abs(curr.price)) + 1;
                                // Higher decimal odds = better price
                                return currDecimal > bestDecimal ? curr : best;
                            });
                            bestPrice = best.price;
                            bestBook = best.bookmaker_key;
                        }
                        
                        return {
                            team_name: watcherBet.team_name,
                            target_odds: watcherBet.target_odds,
                            games: [{
                                matchup: `${watcherBet.team_name} (${apiBet.sport_key})`,
                                start_time: "",
                                prices: apiBet.prices.map(p => ({
                                    bookmaker_key: p.bookmaker_key,
                                    bookmaker_name: p.bookmaker_name,
                                    price: p.price
                                })),
                                best_bookmaker_key: bestBook,
                                best_price: bestPrice,
                                best_bookmaker_name: apiBet.prices.find(p => p.bookmaker_key === bestBook)?.bookmaker_name || null
                            }]
                        };
                    })
                };
                
                renderResults(transformedData);
                setLastUpdated();
                setStatus("Snapshot fetched.");
            } catch (e) {
                console.error(e);
                setStatus("Error fetching odds: " + e.message);
            }
        }

        function startWatching() {
            if (bets.length === 0) {
                alert("No bets configured.");
                return;
            }

            const intervalInput = document.getElementById("interval-input");
            const intervalVal = Number(intervalInput.value) || 60;
            const intervalMs = Math.max(intervalVal, 15) * 1000; // min 15 seconds

            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            setStatus("Watching odds...");
            document.getElementById("start-btn").disabled = true;
            document.getElementById("snapshot-btn").disabled = true;
            document.getElementById("stop-btn").disabled = false;

            // Run immediately, then on interval
            fetchSnapshot();
            pollTimer = setInterval(fetchSnapshot, intervalMs);
        }

        function stopWatching() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            setStatus("Stopped.");
            document.getElementById("start-btn").disabled = false;
            document.getElementById("snapshot-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        function clearBets() {
            if (!confirm("Clear all saved bets?")) return;
            bets = [];
            saveBetsToStorage();
            renderBetList();
            clearResultsTable();
        }

        // Save form selections to localStorage
        function saveFormSelections() {
            const selections = {
                sport: document.getElementById("sport-select").value,
                books: Array.from(document.querySelectorAll('input[name="book"]:checked')).map(cb => cb.value),
                interval: document.getElementById("interval-input").value
            };
            localStorage.setItem("watcherSelections", JSON.stringify(selections));
        }

        // Load form selections from localStorage
        function loadFormSelections() {
            try {
                const saved = localStorage.getItem("watcherSelections");
                if (!saved) return;
                
                const selections = JSON.parse(saved);
                
                if (selections.sport) {
                    document.getElementById("sport-select").value = selections.sport;
                    populateTeamDropdown(); // Update team dropdown when sport changes
                }
                
                if (selections.books && Array.isArray(selections.books)) {
                    document.querySelectorAll('input[name="book"]').forEach(cb => {
                        cb.checked = selections.books.includes(cb.value);
                    });
                }
                
                if (selections.interval) {
                    document.getElementById("interval-input").value = selections.interval;
                }
            } catch (e) {
                console.error("Failed to load form selections:", e);
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            // Load and setup odds format toggle
            const savedFormat = localStorage.getItem("oddsFormat") || "american";
            const formatRadios = document.querySelectorAll('input[name="odds-format"]');
            formatRadios.forEach(radio => {
                if (radio.value === savedFormat) {
                    radio.checked = true;
                }
                radio.addEventListener("change", (e) => {
                    if (e.target.checked) {
                        setOddsFormat(e.target.value);
                    }
                });
            });

            // Load saved form selections
            loadFormSelections();

            // Save form selections when they change
            document.getElementById("sport-select").addEventListener("change", () => {
                saveFormSelections();
                populateTeamDropdown();
            });
            document.querySelectorAll('input[name="book"]').forEach(cb => {
                cb.addEventListener("change", saveFormSelections);
            });
            document.getElementById("interval-input").addEventListener("change", saveFormSelections);

            loadBetsFromStorage();
            renderBetList();

            // Initialize team dropdown based on default sport selection
            populateTeamDropdown();
            
            // Note: sport change handler is already set up above in the form selections section

            document.getElementById("add-bet-btn").onclick = addBetFromForm;
            document.getElementById("clear-bets-btn").onclick = clearBets;
            document.getElementById("snapshot-btn").onclick = fetchSnapshot;
            document.getElementById("start-btn").onclick = startWatching;
            document.getElementById("stop-btn").onclick = stopWatching;
        });
    </script>
</body>

</html>