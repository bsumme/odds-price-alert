<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bens Direct Fliff Bet</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script>
        (function enforceMobileOnly() {
            function isMobileDevice() {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera || "";
                const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i;
                const isSmallScreen = window.innerWidth < 900;
                const hasTouchScreen = "ontouchstart" in window || navigator.maxTouchPoints > 0;
                return mobileRegex.test((userAgent || "").toLowerCase()) || (isSmallScreen && hasTouchScreen);
            }

            if (!isMobileDevice()) {
                const destination = "/BensSportsBookApp.html" + (window.location.search || "") + (window.location.hash || "");
                window.location.replace(destination);
            }
        })();
    </script>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0f172a;
            --panel: #111827;
            --accent: #22c55e;
            --muted: #94a3b8;
            --border: #1f2937;
            --danger: #f87171;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
            background: var(--bg);
            color: #e5e7eb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0 1rem 2rem;
        }

        header {
            padding: 1rem 0.25rem 0.5rem;
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.96) 0%, rgba(15, 23, 42, 0.7) 60%, rgba(15, 23, 42, 0) 100%);
            backdrop-filter: blur(10px);
            z-index: 5;
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
            letter-spacing: 0.01em;
        }

        .subtitle {
            margin: 0.15rem 0 0;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
        }

        .stack {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        button {
            background: var(--accent);
            color: #052e16;
            border: none;
            border-radius: 999px;
            padding: 0.75rem 1rem;
            font-weight: 700;
            font-size: 1rem;
            width: 100%;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
        }

        button:disabled {
            opacity: 0.75;
            box-shadow: none;
        }

        .status {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: #0b172d;
            border: 1px solid var(--border);
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            color: #cbd5e1;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--accent);
        }

        .label {
            color: var(--muted);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.08em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
        }

        .tile {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.75rem;
        }

        .muted {
            color: var(--muted);
        }

        .empty {
            border: 1px dashed var(--border);
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem;
            color: var(--muted);
        }

        @media (max-width: 520px) {
            body {
                padding: 0 0.75rem 1.5rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Direct Fliff Hedge</h1>
        <p class="subtitle">Mobile-only shortcut to the best Fliff vs Novig main-market arbitrage.</p>
    </header>

    <main class="stack">
        <div class="card stack" id="result-card">
            <div class="row">
                <span class="badge" id="book-label">Fliff ↔ Novig</span>
                <span class="status" id="updated-at">Loading…</span>
            </div>

            <div id="bet-details" class="stack"></div>

            <button id="refresh-btn">Refresh best bet</button>
            <div class="status" id="status-text"></div>
        </div>
    </main>

    <script>
        const SPORT_KEYS = [
            "basketball_nba",
            "americanfootball_nfl",
            "baseball_mlb",
            "icehockey_nhl",
        ];
        const MARKETS = ["h2h", "spreads", "totals"];
        const TARGET_BOOK = "fliff";
        const COMPARE_BOOK = "novig";

        const statusText = document.getElementById("status-text");
        const betDetails = document.getElementById("bet-details");
        const updatedAt = document.getElementById("updated-at");
        const refreshBtn = document.getElementById("refresh-btn");

        function formatPercentage(value) {
            if (value === null || value === undefined) return "—";
            return `${value.toFixed(2)}%`;
        }

        function formatPoint(point) {
            if (point === null || point === undefined) return "";
            const pointNumber = Number(point);
            if (Number.isNaN(pointNumber)) return `${point}`;
            return pointNumber > 0 ? `+${pointNumber}` : `${pointNumber}`;
        }

        function renderBet(bet) {
            betDetails.innerHTML = "";

            if (!bet) {
                betDetails.innerHTML = `
                    <div class="empty">
                        <strong>No arbitrage bets available right now.</strong><br />
                        Try again in a few moments.
                    </div>
                `;
                return;
            }

            const line = [bet.market?.toUpperCase(), bet.outcome_name, formatPoint(bet.point)]
                .filter(Boolean)
                .join(" · ");

            const matchup = bet.matchup || `${bet.sport_key} matchup`;

            betDetails.innerHTML = `
                <div class="stack">
                    <div>
                        <div class="label">Matchup</div>
                        <div class="value">${matchup}</div>
                        <div class="muted">${bet.start_time || "—"}</div>
                    </div>

                    <div>
                        <div class="label">Market</div>
                        <div class="value">${line}</div>
                    </div>

                    <div class="grid">
                        <div class="tile">
                            <div class="label">Fliff Price</div>
                            <div class="value">${bet.book_price || "—"}</div>
                        </div>
                        <div class="tile">
                            <div class="label">Novig Opposite</div>
                            <div class="value">${bet.novig_reverse_price ?? "—"}</div>
                        </div>
                        <div class="tile">
                            <div class="label">Arb Margin</div>
                            <div class="value">${formatPercentage(bet.arb_margin_percent)}</div>
                        </div>
                        <div class="tile">
                            <div class="label">Value Score</div>
                            <div class="value">${formatPercentage(bet.ev_percent)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function pickBestArbitrage(plays = []) {
            const arbitragePlays = plays.filter((play) => typeof play.arb_margin_percent === "number");
            if (arbitragePlays.length === 0) return null;
            return arbitragePlays[0];
        }

        async function fetchBestBet() {
            refreshBtn.disabled = true;
            statusText.textContent = "Scanning Fliff vs Novig for top arbitrage margin...";
            updatedAt.textContent = "Loading…";
            betDetails.innerHTML = "";

            try {
                const response = await fetch("/api/best-value-plays", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sport_keys: SPORT_KEYS,
                        markets: MARKETS,
                        target_book: TARGET_BOOK,
                        compare_book: COMPARE_BOOK,
                        max_results: 25,
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Request failed with status ${response.status}`);
                }

                const data = await response.json();
                const bestBet = pickBestArbitrage(data.plays || []);
                renderBet(bestBet);
                updatedAt.textContent = `Updated ${new Date().toLocaleTimeString()}`;
                statusText.textContent = bestBet
                    ? "Found the best available arbitrage margin."
                    : "Waiting for a fresh Fliff vs Novig arbitrage window.";
            } catch (error) {
                statusText.textContent = `Error fetching best bet: ${error.message || error}`;
                betDetails.innerHTML = "<div class=\"empty\">Could not load bets right now.</div>";
            } finally {
                refreshBtn.disabled = false;
            }
        }

        refreshBtn.addEventListener("click", fetchBestBet);
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                fetchBestBet();
            }
        });

        fetchBestBet();
    </script>
    <script src="/nav-trim.js" defer></script>
</body>

</html>
